<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Dungeon Master - Dashboard</title>
    <!-- Socket.IO for real-time communication -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <!-- jQuery for DOM manipulation -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Static script for game functionality -->
    <script src="/static/script.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #1a1a2e 0%,
          #16213e 50%,
          #0f3460 100%
        );
        color: white;
        height: 100vh;
        overflow: hidden;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 280px 1fr 320px;
        height: 100vh;
        gap: 2px;
        background: #000;
      }

      /* Sağ Panel - Mor ton */
      .right-panel {
        background: linear-gradient(180deg, #4a148c 0%, #6a1b9a 100%);
        padding: 15px;
        overflow-y: auto;
        border: 1px solid rgba(255, 215, 0, 0.3);
        min-height: 100vh;
      }

      .right-panel h3 {
        color: #ffd700;
        font-size: 16px;
        margin-bottom: 15px;
        text-align: center;
      }

      .character-info {
        background: rgba(0, 0, 0, 0.3);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
        text-align: center;
      }

      .character-name {
        color: #ffd700;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .character-details {
        color: rgba(255, 255, 255, 0.8);
        font-size: 12px;
      }

      .level-info {
        background: rgba(0, 0, 0, 0.4);
        padding: 8px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .level-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 13px;
      }

      .level-value {
        color: #ffd700;
        font-weight: bold;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-bottom: 15px;
      }

      .stat-box {
        background: rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 5px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .stat-box-name {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 3px;
      }

      .stat-box-value {
        color: #ffd700;
        font-weight: bold;
        font-size: 14px;
      }

      .equipment-section {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .equipment-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 8px;
      }

      .equipment-slot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        margin-bottom: 4px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
      }

      .equipment-slot:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
      }

      .slot-name {
        color: rgba(255, 255, 255, 0.8);
        font-weight: bold;
      }

      .slot-item {
        color: #4CAF50;
        font-weight: bold;
      }

      .slot-lore {
        color: rgba(255, 255, 255, 0.6);
        font-size: 10px;
        font-style: italic;
      }

      .inventory-section {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .inventory-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 8px;
      }

      .inventory-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
      }

      .inventory-slot {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        padding: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 16px;
        min-height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .inventory-slot:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
      }

      .inventory-slot.filled {
        background: rgba(76, 175, 80, 0.2);
        border-color: #4CAF50;
      }

      .character-actions {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .action-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 8px;
      }

      .action-btn {
        width: 100%;
        padding: 6px 8px;
        margin-bottom: 4px;
        background: rgba(255, 152, 0, 0.2);
        border: 1px solid #FF9800;
        border-radius: 3px;
        color: #FF9800;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
      }

      .action-btn:hover {
        background: rgba(255, 152, 0, 0.3);
      }

      .lore-section {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .lore-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 8px;
      }

      .lore-content {
        font-size: 11px;
      }

      .lore-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3px;
        padding: 2px 0;
      }

      .lore-category {
        color: rgba(255, 255, 255, 0.7);
        font-weight: bold;
      }

      .lore-text {
        color: rgba(255, 255, 255, 0.8);
        text-align: right;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px;
        border-radius: 5px;
        z-index: 1000;
        font-weight: bold;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }

      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }

      /* Sol Panel - Mavi ton */
      .left-panel {
        background: linear-gradient(180deg, #1a237e 0%, #283593 100%);
        padding: 15px;
        overflow-y: auto;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .left-panel h3 {
        color: #ffd700;
        font-size: 16px;
        margin-bottom: 15px;
        background: rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 5px;
        text-align: center;
      }

      .theme-tabs {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin-bottom: 20px;
      }

      .theme-tab {
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 4px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        text-align: center;
      }

      .theme-tab.active {
        background: #ffd700;
        color: #000;
        font-weight: bold;
      }

      .theme-tab:hover:not(.active) {
        background: rgba(255, 215, 0, 0.2);
      }

      .scenarios-list {
        margin-bottom: 15px;
      }

      .scenarios-list h4 {
        color: #ffd700;
        font-size: 14px;
        margin-bottom: 8px;
        padding: 5px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      .scenario-item {
        padding: 8px 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        margin-bottom: 4px;
      }

      .scenario-item:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
      }

      .scenario-item.selected {
        background: rgba(255, 215, 0, 0.3);
        border-color: #ffd700;
        color: #ffd700;
      }

      .scenario-title {
        font-weight: bold;
        margin-bottom: 2px;
      }

      .scenario-desc {
        font-size: 11px;
        opacity: 0.8;
      }

      .stats-section {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .stats-section h4 {
        color: #ffd700;
        text-align: center;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 13px;
      }

      .stat-value {
        background: #ffd700;
        color: #000;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
        font-size: 12px;
      }
      
      /* Character Creation Styles */
      .character-creation {
        margin-bottom: 20px;
      }
      
      .character-creation h4 {
        color: #ffd700;
        font-size: 14px;
        margin-bottom: 10px;
        text-align: center;
      }
      
      .creation-section {
        margin-bottom: 15px;
      }
      
      .creation-section label {
        display: block;
        color: #ffd700;
        font-size: 12px;
        margin-bottom: 5px;
      }
      
      .creation-section input {
        width: 100%;
        padding: 8px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 4px;
        color: white;
        font-size: 13px;
      }
      
      .race-options, .class-options {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .race-option, .class-option {
        padding: 6px 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
      }
      
      .race-option:hover, .class-option:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
      }
      
      .race-option.selected, .class-option.selected {
        background: rgba(255, 215, 0, 0.3);
        border-color: #ffd700;
        color: #ffd700;
      }
      
      .stats-display {
        background: rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 4px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }
      
      .create-character-btn {
        width: 100%;
        padding: 10px;
        background: linear-gradient(45deg, #4CAF50, #45a049);
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
      }
      
      .create-character-btn:hover {
        background: linear-gradient(45deg, #45a049, #4CAF50);
      }
      
      .character-created {
        background: #4CAF50;
        color: white;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        margin-top: 10px;
        font-weight: bold;
      }
      
      /* Interactive Equipment Styles */
      .equipment-slot {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .equipment-slot:hover {
        background: rgba(255, 215, 0, 0.1);
        border-color: #ffd700;
      }
      
      /* Interactive Inventory Styles */
      .inventory-slot {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .inventory-slot:hover {
        background: rgba(76, 175, 80, 0.2);
        border-color: #4CAF50;
        transform: scale(1.1);
      }
      
      /* Character Actions Styles */
      .character-actions {
        margin-top: 15px;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }
      
      .action-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 10px;
        font-weight: bold;
      }
      
      .action-btn {
        width: 100%;
        padding: 8px;
        margin-bottom: 5px;
        background: rgba(255, 215, 0, 0.2);
        border: 1px solid #ffd700;
        border-radius: 4px;
        color: #ffd700;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
        font-weight: bold;
      }
      
      .action-btn:hover {
        background: rgba(255, 215, 0, 0.3);
        transform: translateY(-2px);
      }
      
      /* Notification Animations */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
      
      /* Lore Section Styles */
      .lore-section {
        margin-top: 15px;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }
      
      .lore-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 10px;
        font-weight: bold;
      }
      
      .lore-content {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      
      .lore-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3px 0;
        font-size: 12px;
      }
      
      .lore-category {
        color: #ffd700;
        font-weight: bold;
        font-size: 11px;
      }
      
      .lore-text {
        color: rgba(255, 255, 255, 0.8);
        text-align: right;
        font-size: 11px;
      }
      
      /* Character Lore Styles */
      .character-lore {
        margin-top: 8px;
        padding: 5px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
        font-size: 11px;
      }
      
      .lore-title {
        color: #ffd700;
        font-weight: bold;
        margin-right: 5px;
      }
      
      .lore-text {
        color: rgba(255, 255, 255, 0.8);
      }
      
      /* Equipment Slot Lore */
      .slot-lore {
        display: block;
        font-size: 10px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 2px;
        font-style: italic;
      }
      
      /* Enhanced Equipment Slots */
      .equipment-slot {
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 5px;
      }
      
      .equipment-slot:hover {
        background: rgba(255, 215, 0, 0.1);
        border-color: #ffd700;
        transform: translateX(5px);
      }
      
      /* Enhanced Inventory Slots */
      .inventory-slot {
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }
      
      .inventory-slot:hover {
        background: rgba(76, 175, 80, 0.3);
        border-color: #4CAF50;
        transform: scale(1.1);
        z-index: 10;
      }
      
      .inventory-slot:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 5px 8px;
        border-radius: 4px;
        font-size: 11px;
        white-space: nowrap;
        z-index: 1000;
      }

      /* Orta Panel - Koyu mavi */
      .center-panel {
        background: linear-gradient(180deg, #263238 0%, #37474f 100%);
        padding: 15px;
        overflow-y: auto;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .scenario-header {
        background: rgba(255, 215, 0, 0.1);
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ffd700;
        margin-bottom: 15px;
        text-align: center;
      }

      .scenario-title {
        color: #ffd700;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .scenario-description {
        background: rgba(0, 0, 0, 0.4);
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-size: 14px;
        line-height: 1.4;
      }

      .choices-section {
        margin-bottom: 15px;
      }

      .choices-title {
        color: #4caf50;
        font-size: 15px;
        margin-bottom: 10px;
      }

      .choices-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .choice-btn {
        padding: 10px;
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid #4caf50;
        border-radius: 5px;
        color: #4caf50;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        text-align: center;
      }

      .choice-btn:hover {
        background: rgba(76, 175, 80, 0.3);
      }

      .game-status {
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
      }

      .status-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 14px;
      }

      /* Sağ Panel - Mor ton */
      .right-panel {
        background: linear-gradient(180deg, #4a148c 0%, #6a1b9a 100%);
        padding: 15px;
        overflow-y: auto;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .right-panel h3 {
        color: #ffd700;
        font-size: 16px;
        margin-bottom: 15px;
        text-align: center;
      }

      .character-info {
        background: rgba(0, 0, 0, 0.3);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
        text-align: center;
      }

      .character-name {
        color: #ffd700;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .character-details {
        color: rgba(255, 255, 255, 0.8);
        font-size: 12px;
      }

      .level-info {
        background: rgba(0, 0, 0, 0.4);
        padding: 8px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .level-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 13px;
      }

      .level-value {
        color: #ffd700;
        font-weight: bold;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-bottom: 15px;
      }

      .stat-box {
        background: rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 5px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .stat-box-name {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 3px;
      }

      .stat-box-value {
        color: #ffd700;
        font-weight: bold;
        font-size: 14px;
      }

      .equipment-section {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .equipment-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 8px;
      }

      .equipment-slot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        margin-bottom: 4px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
      }

      .equipment-slot:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
      }

      .slot-name {
        color: rgba(255, 255, 255, 0.8);
        font-weight: bold;
      }

      .slot-item {
        color: #4CAF50;
        font-weight: bold;
      }

      .slot-lore {
        color: rgba(255, 255, 255, 0.6);
        font-size: 10px;
        font-style: italic;
      }

      .inventory-section {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .inventory-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 8px;
      }

      .inventory-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
      }

      .inventory-slot {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        padding: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 16px;
        min-height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .inventory-slot:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
      }

      .inventory-slot.filled {
        background: rgba(76, 175, 80, 0.2);
        border-color: #4CAF50;
      }

      .character-actions {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .action-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 8px;
      }

      .action-btn {
        width: 100%;
        padding: 6px 8px;
        margin-bottom: 4px;
        background: rgba(255, 152, 0, 0.2);
        border: 1px solid #FF9800;
        border-radius: 3px;
        color: #FF9800;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
      }

      .action-btn:hover {
        background: rgba(255, 152, 0, 0.3);
      }

      .lore-section {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .lore-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 8px;
      }

      .lore-content {
        font-size: 11px;
      }

      .lore-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3px;
        padding: 2px 0;
      }

      .lore-category {
        color: rgba(255, 255, 255, 0.7);
        font-weight: bold;
      }

      .lore-text {
        color: rgba(255, 255, 255, 0.8);
        text-align: right;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px;
        border-radius: 5px;
        z-index: 1000;
        font-weight: bold;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }

      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      }

      .equipment-slot {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 12px;
      }

      .slot-name {
        color: rgba(255, 255, 255, 0.7);
      }

      .slot-item {
        color: #4caf50;
      }

      .inventory-section {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .inventory-title {
        color: #ffd700;
        font-size: 14px;
        text-align: center;
        margin-bottom: 8px;
      }

      .inventory-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
      }

      .inventory-slot {
        aspect-ratio: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        cursor: pointer;
      }

      .inventory-slot.filled {
        background: rgba(76, 175, 80, 0.2);
        border-color: #4caf50;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(255, 215, 0, 0.5);
        border-radius: 3px;
      }

      /* Loading states */
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      /* Error states */
      .error {
        color: #ff4444;
        background: rgba(255, 68, 68, 0.1);
        border: 1px solid #ff4444;
        padding: 8px;
        border-radius: 4px;
        margin: 8px 0;
      }

      /* Advanced Storytelling Styles */
      .story-intro {
        background: rgba(0, 0, 0, 0.4);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .story-intro p {
        margin-bottom: 10px;
        line-height: 1.6;
      }

      .plot-twist {
        margin: 15px 0;
        animation: plotTwistAppear 0.8s ease-out;
      }

      .plot-twist-alert {
        background: linear-gradient(
          135deg,
          rgba(255, 193, 7, 0.2) 0%,
          rgba(255, 152, 0, 0.2) 100%
        );
        border: 2px solid rgba(255, 193, 7, 0.5);
        border-radius: 12px;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .plot-twist-alert::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      .plot-twist-icon {
        font-size: 24px;
        animation: pulse 2s infinite;
        filter: drop-shadow(0 0 8px rgba(255, 193, 7, 0.6));
      }

      .plot-twist-text {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        flex: 1;
      }

      .emotional-beat {
        margin: 12px 0;
        animation: emotionalBeatAppear 0.6s ease-out;
      }

      .emotional-beat-content {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.2) 0%,
          rgba(103, 58, 183, 0.2) 100%
        );
        border: 1px solid rgba(156, 39, 176, 0.4);
        border-radius: 8px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(156, 39, 176, 0.2);
        backdrop-filter: blur(8px);
      }

      .emotional-icon {
        font-size: 18px;
        opacity: 0.8;
      }

      .emotional-text {
        font-size: 14px;
        color: #e1bee7;
        font-style: italic;
        flex: 1;
      }

      .emotional-beat.intensity-high .emotional-beat-content {
        background: linear-gradient(
          135deg,
          rgba(244, 67, 54, 0.3) 0%,
          rgba(233, 30, 99, 0.3) 100%
        );
        border-color: rgba(244, 67, 54, 0.6);
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
      }

      .emotional-beat.intensity-high .emotional-text {
        color: #ffcdd2;
      }

      .emotional-beat.intensity-medium .emotional-beat-content {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.2) 0%,
          rgba(103, 58, 183, 0.2) 100%
        );
        border-color: rgba(156, 39, 176, 0.4);
        box-shadow: 0 4px 15px rgba(156, 39, 176, 0.2);
      }

      .emotional-beat.intensity-low .emotional-beat-content {
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.2) 0%,
          rgba(30, 136, 229, 0.2) 100%
        );
        border-color: rgba(33, 150, 243, 0.4);
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
      }

      .emotional-beat.intensity-low .emotional-text {
        color: #bbdefb;
      }

      @keyframes plotTwistAppear {
        0% {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        50% {
          opacity: 0.8;
          transform: translateY(-5px) scale(1.02);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes emotionalBeatAppear {
        0% {
          opacity: 0;
          transform: translateX(-15px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      /* Battle Sequence Styles */
      .battle-sequence {
        background: linear-gradient(45deg, #2c3e50, #34495e);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        border: 2px solid #e74c3c;
      }

      .battle-alert {
        color: #e74c3c;
        font-weight: bold;
        text-align: center;
        font-size: 16px;
        margin-bottom: 15px;
        text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
      }

      .battle-status {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
      }

      .enemy-info,
      .player-info {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .battle-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .battle-btn {
        padding: 10px;
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .attack-btn {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
      }

      .defend-btn {
        background: linear-gradient(45deg, #3498db, #2980b9);
      }

      .magic-btn {
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
      }

      .flee-btn {
        background: linear-gradient(45deg, #f39c12, #e67e22);
      }

      .battle-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      /* Contextual Actions Styles */
      .contextual-actions-section {
        margin-top: 20px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .actions-title {
        color: #ffd700;
        font-size: 16px;
        margin-bottom: 15px;
        text-align: center;
      }

      .contextual-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }

      .action-btn {
        padding: 12px 16px;
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        text-align: center;
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .action-btn.combat {
        background: linear-gradient(135deg, #c53030 0%, #9b2c2c 100%);
      }

      .action-btn.explore {
        background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      }

      .action-btn.social {
        background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
      }

      .action-btn.inventory {
        background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);
      }

      .action-btn.general {
        background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%);
      }

      .battle-log {
        background: rgba(0, 0, 0, 0.4);
        padding: 8px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 12px;
      }

      .battle-message {
        color: #4caf50;
        margin-bottom: 5px;
      }

      .damage-info {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
      }

      .player-damage {
        color: #4caf50;
      }

      .enemy-damage {
        color: #e74c3c;
      }

      .battle-result {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        text-align: center;
      }

      .result-message {
        color: white;
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 10px;
      }

      /* Dialogue Sequence Styles */
      .dialogue-sequence {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.1) 0%,
          rgba(103, 58, 183, 0.1) 100%
        );
        border: 1px solid rgba(156, 39, 176, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 8px 25px rgba(156, 39, 176, 0.2);
        backdrop-filter: blur(10px);
      }

      .dialogue-content {
        margin-bottom: 20px;
      }

      .npc-info {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
      }

      .npc-icon {
        font-size: 24px;
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
      }

      .npc-name {
        font-size: 18px;
        font-weight: 600;
        color: #e1bee7;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      .dialogue-text {
        font-size: 16px;
        line-height: 1.6;
        color: #f3e5f5;
        font-style: italic;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 4px solid rgba(156, 39, 176, 0.5);
      }

      .dialogue-choices {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }

      .dialogue-btn {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.3) 0%,
          rgba(103, 58, 183, 0.3) 100%
        );
        border: 1px solid rgba(156, 39, 176, 0.5);
        border-radius: 8px;
        padding: 12px 16px;
        color: #f3e5f5;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
      }

      .dialogue-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.5) 0%,
          rgba(103, 58, 183, 0.5) 100%
        );
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
      }

      .dialogue-response {
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.1) 0%,
          rgba(46, 125, 50, 0.1) 100%
        );
        border: 1px solid rgba(76, 175, 80, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
        backdrop-filter: blur(10px);
        animation: responseAppear 0.5s ease-out;
      }

      .response-content {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .npc-response {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
      }

      .response-text {
        font-size: 16px;
        line-height: 1.6;
        color: #e8f5e8;
        font-style: italic;
        flex: 1;
      }

      .response-consequence {
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        border-left: 4px solid rgba(76, 175, 80, 0.5);
        font-size: 14px;
        color: #c8e6c9;
      }

      @keyframes responseAppear {
        0% {
          opacity: 0;
          transform: translateY(-20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Story Progression Styles */
      .story-progression {
        background: linear-gradient(45deg, #f39c12, #e67e22);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .progression-alert {
        color: white;
        font-weight: bold;
        text-align: center;
        font-size: 16px;
        margin-bottom: 10px;
      }

      .progression-text {
        color: white;
        text-align: center;
        font-style: italic;
      }

      .story-continuation {
        background: rgba(0, 0, 0, 0.4);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .story-continuation p {
        margin-bottom: 10px;
        line-height: 1.6;
      }

      /* Enhanced Choice Styles */
      .combat-choice {
        background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
        border-color: #e74c3c !important;
      }

      .dialogue-choice {
        background: linear-gradient(45deg, #3498db, #2980b9) !important;
        border-color: #3498db !important;
      }

      /* Error Message Styles */
      .error-message {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
      }

      /* Scenario Meta Styles */
      .scenario-meta {
        display: flex;
        gap: 8px;
        margin-top: 5px;
        font-size: 11px;
      }

      .difficulty {
        background: rgba(255, 152, 0, 0.3);
        padding: 2px 6px;
        border-radius: 3px;
        color: #ff9800;
      }

      .genre {
        background: rgba(156, 39, 176, 0.3);
        padding: 2px 6px;
        border-radius: 3px;
        color: #9c27b0;
      }

      /* Character Creation Styles */
      .character-creation {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .character-creation h4 {
        color: #ffd700;
        font-size: 16px;
        margin-bottom: 15px;
        text-align: center;
      }

      .creation-section {
        margin-bottom: 15px;
      }

      .creation-section label {
        display: block;
        color: #ffd700;
        font-size: 14px;
        margin-bottom: 8px;
        font-weight: bold;
      }

      .creation-section input {
        width: 100%;
        padding: 8px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        color: white;
        font-size: 13px;
      }

      .creation-section input:focus {
        outline: none;
        border-color: #ffd700;
      }

      .race-options,
      .class-options {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .race-option,
      .class-option {
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        text-align: center;
      }

      .race-option:hover,
      .class-option:hover {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
      }

      .race-option.selected,
      .class-option.selected {
        background: rgba(255, 215, 0, 0.3);
        border-color: #ffd700;
        color: #ffd700;
        font-weight: bold;
      }

      .stats-display {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .create-character-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(45deg, #ffd700, #ffa500);
        border: none;
        border-radius: 6px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        margin-top: 10px;
      }

      .create-character-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
      }

      .create-character-btn:active {
        transform: translateY(0);
      }

      /* Character Created Success Message */
      .character-created {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        color: white;
        margin: 10px 0;
      }

      .character-created h3 {
        margin-bottom: 15px;
        font-size: 18px;
      }

      .character-created p {
        margin-bottom: 8px;
        font-size: 14px;
      }

      /* AI Features Section */
      .ai-features-section {
        margin-top: 20px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .ai-features-section h4 {
        color: #ffd700;
        font-size: 14px;
        margin-bottom: 12px;
        text-align: center;
      }

      .ai-feature-btn {
        width: 100%;
        padding: 10px;
        margin-bottom: 8px;
        background: linear-gradient(45deg, #9c27b0, #673ab7);
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
      }

      .ai-feature-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(156, 39, 176, 0.3);
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
      }

      .modal-content {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        margin: 5% auto;
        padding: 20px;
        border: 2px solid #ffd700;
        border-radius: 10px;
        width: 80%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        color: white;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
      }

      .modal-title {
        color: #ffd700;
        font-size: 18px;
        font-weight: bold;
      }

      .close-modal {
        color: #ffd700;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
      }

      .close-modal:hover {
        color: #ff6b6b;
      }

      .modal-section {
        margin-bottom: 20px;
      }

      .modal-section h3 {
        color: #ffd700;
        font-size: 16px;
        margin-bottom: 10px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #ffd700;
        font-size: 14px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 5px;
        color: white;
        font-size: 14px;
      }

      .form-group textarea {
        height: 100px;
        resize: vertical;
      }

      .modal-btn {
        padding: 12px 20px;
        background: linear-gradient(45deg, #ffd700, #ffa500);
        border: none;
        border-radius: 5px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        margin-right: 10px;
      }

      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
      }

      .modal-btn.secondary {
        background: linear-gradient(45deg, #6c757d, #495057);
        color: white;
      }

      .file-upload-area {
        border: 2px dashed rgba(255, 215, 0, 0.5);
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .file-upload-area:hover {
        border-color: #ffd700;
        background: rgba(255, 215, 0, 0.1);
      }

      .file-upload-area.dragover {
        border-color: #ffd700;
        background: rgba(255, 215, 0, 0.2);
      }

      .agent-tabs {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
      }

      .agent-tab {
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .agent-tab.active {
        background: #ffd700;
        color: #000;
      }

      .agent-tab:hover:not(.active) {
        background: rgba(255, 215, 0, 0.2);
      }

      .agent-content {
        display: none;
      }

      .agent-content.active {
        display: block;
      }

      .story-preview {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }

      .story-preview h4 {
        color: #ffd700;
        margin-bottom: 10px;
      }

      .story-text {
        line-height: 1.6;
        font-size: 14px;
      }

      /* Enhanced Natural Story Progression Styles */
      .story-continuation {
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.1) 0%,
          rgba(46, 125, 50, 0.1) 100%
        );
        border: 1px solid rgba(76, 175, 80, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
        backdrop-filter: blur(10px);
        animation: continuationAppear 0.8s ease-out;
      }

      .continuation-text {
        font-size: 16px;
        line-height: 1.6;
        color: #e8f5e8;
        font-style: italic;
        text-align: center;
      }

      .natural-progression {
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.1) 0%,
          rgba(30, 136, 229, 0.1) 100%
        );
        border: 1px solid rgba(33, 150, 243, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 8px 25px rgba(33, 150, 243, 0.2);
        backdrop-filter: blur(10px);
        animation: progressionAppear 0.6s ease-out;
      }

      .progression-text {
        font-size: 16px;
        line-height: 1.6;
        color: #bbdefb;
        font-style: italic;
        text-align: center;
      }

      .natural-continuation {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.1) 0%,
          rgba(103, 58, 183, 0.1) 100%
        );
        border: 1px solid rgba(156, 39, 176, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 8px 25px rgba(156, 39, 176, 0.2);
        backdrop-filter: blur(10px);
        animation: naturalContinuationAppear 0.7s ease-out;
      }

      .story-progression {
        background: linear-gradient(
          135deg,
          rgba(255, 193, 7, 0.1) 0%,
          rgba(255, 152, 0, 0.1) 100%
        );
        border: 1px solid rgba(255, 193, 7, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.2);
        backdrop-filter: blur(10px);
        animation: storyProgressionAppear 0.5s ease-out;
      }

      @keyframes continuationAppear {
        0% {
          opacity: 0;
          transform: translateY(-15px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes progressionAppear {
        0% {
          opacity: 0;
          transform: translateX(-15px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes naturalContinuationAppear {
        0% {
          opacity: 0;
          transform: scale(0.95);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes storyProgressionAppear {
        0% {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Enhanced Contextual Choice System Styles */
      .choice-btn {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.3) 0%,
          rgba(103, 58, 183, 0.3) 100%
        );
        border: 1px solid rgba(156, 39, 176, 0.5);
        border-radius: 12px;
        padding: 15px 20px;
        color: #f3e5f5;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        margin: 8px 0;
        text-align: left;
        position: relative;
        overflow: hidden;
      }

      .choice-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.5s ease;
      }

      .choice-btn:hover::before {
        left: 100%;
      }

      .choice-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.5) 0%,
          rgba(103, 58, 183, 0.5) 100%
        );
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(156, 39, 176, 0.4);
      }

      .choice-btn.combat-choice {
        background: linear-gradient(
          135deg,
          rgba(244, 67, 54, 0.3) 0%,
          rgba(233, 30, 99, 0.3) 100%
        );
        border-color: rgba(244, 67, 54, 0.5);
      }

      .choice-btn.combat-choice:hover {
        background: linear-gradient(
          135deg,
          rgba(244, 67, 54, 0.5) 0%,
          rgba(233, 30, 99, 0.5) 100%
        );
        box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
      }

      .choice-btn.dialogue-choice {
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.3) 0%,
          rgba(30, 136, 229, 0.3) 100%
        );
        border-color: rgba(33, 150, 243, 0.5);
      }

      .choice-btn.dialogue-choice:hover {
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.5) 0%,
          rgba(30, 136, 229, 0.5) 100%
        );
        box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
      }

      .choice-btn.exploration-choice {
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.3) 0%,
          rgba(46, 125, 50, 0.3) 100%
        );
        border-color: rgba(76, 175, 80, 0.5);
      }

      .choice-btn.exploration-choice:hover {
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.5) 0%,
          rgba(46, 125, 50, 0.5) 100%
        );
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
      }

      .choice-btn.stealth-choice {
        background: linear-gradient(
          135deg,
          rgba(96, 125, 139, 0.3) 0%,
          rgba(69, 90, 100, 0.3) 100%
        );
        border-color: rgba(96, 125, 139, 0.5);
      }

      .choice-btn.stealth-choice:hover {
        background: linear-gradient(
          135deg,
          rgba(96, 125, 139, 0.5) 0%,
          rgba(69, 90, 100, 0.5) 100%
        );
        box-shadow: 0 8px 25px rgba(96, 125, 139, 0.4);
      }

      .choice-btn.story-choice {
        background: linear-gradient(
          135deg,
          rgba(255, 193, 7, 0.3) 0%,
          rgba(255, 152, 0, 0.3) 100%
        );
        border-color: rgba(255, 193, 7, 0.5);
      }

      .choice-btn.story-choice:hover {
        background: linear-gradient(
          135deg,
          rgba(255, 193, 7, 0.5) 0%,
          rgba(255, 152, 0, 0.5) 100%
        );
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
      }

      .contextual-story-progression {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.1) 0%,
          rgba(103, 58, 183, 0.1) 100%
        );
        border: 1px solid rgba(156, 39, 176, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 8px 25px rgba(156, 39, 176, 0.2);
        backdrop-filter: blur(10px);
        animation: contextualProgressionAppear 0.8s ease-out;
      }

      .story-text {
        font-size: 16px;
        line-height: 1.6;
        color: #f3e5f5;
        font-style: italic;
        margin-bottom: 15px;
      }

      .story-atmosphere {
        font-size: 14px;
        line-height: 1.4;
        color: #e1bee7;
        opacity: 0.8;
        font-style: italic;
      }

      @keyframes contextualProgressionAppear {
        0% {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .choices-title {
        color: #e1bee7;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      .choices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 12px;
        margin-top: 15px;
      }

      /* Advanced Storytelling System Styles */
      .advanced-choice {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.15) 0%,
          rgba(103, 58, 183, 0.15) 100%
        );
        border: 2px solid rgba(156, 39, 176, 0.4);
        border-radius: 16px;
        padding: 20px;
        margin: 12px 0;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
      }

      .advanced-choice::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.6s ease;
      }

      .advanced-choice:hover::before {
        left: 100%;
      }

      .advanced-choice:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 35px rgba(156, 39, 176, 0.3);
        border-color: rgba(156, 39, 176, 0.6);
      }

      .choice-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .choice-title {
        color: #f3e5f5;
        font-size: 18px;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      .choice-type-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .exploration-badge {
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.8) 0%,
          rgba(46, 125, 50, 0.8) 100%
        );
        color: white;
      }

      .dialogue-badge {
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.8) 0%,
          rgba(30, 136, 229, 0.8) 100%
        );
        color: white;
      }

      .combat-badge {
        background: linear-gradient(
          135deg,
          rgba(244, 67, 54, 0.8) 0%,
          rgba(233, 30, 99, 0.8) 100%
        );
        color: white;
      }

      .stealth-badge {
        background: linear-gradient(
          135deg,
          rgba(96, 125, 139, 0.8) 0%,
          rgba(69, 90, 100, 0.8) 100%
        );
        color: white;
      }

      .preparation-badge {
        background: linear-gradient(
          135deg,
          rgba(255, 193, 7, 0.8) 0%,
          rgba(255, 152, 0, 0.8) 100%
        );
        color: white;
      }

      .choice-description {
        color: #e1bee7;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 12px;
        font-style: italic;
      }

      .choice-context {
        color: #b39ddb;
        font-size: 13px;
        line-height: 1.4;
        margin-bottom: 12px;
        opacity: 0.8;
      }

      .choice-consequences {
        margin-bottom: 12px;
      }

      .consequence {
        padding: 8px 12px;
        border-radius: 8px;
        margin: 4px 0;
        font-size: 13px;
        font-weight: 500;
      }

      .consequence.immediate {
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.2) 0%,
          rgba(46, 125, 50, 0.2) 100%
        );
        border: 1px solid rgba(76, 175, 80, 0.3);
        color: #a5d6a7;
      }

      .consequence.long-term {
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.2) 0%,
          rgba(30, 136, 229, 0.2) 100%
        );
        border: 1px solid rgba(33, 150, 243, 0.3);
        color: #90caf9;
      }

      .choice-requirements {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .requirement-skill {
        background: linear-gradient(
          135deg,
          rgba(255, 193, 7, 0.3) 0%,
          rgba(255, 152, 0, 0.3) 100%
        );
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        color: #ffcc02;
        font-weight: 500;
      }

      .requirement-difficulty {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .requirement-difficulty.easy {
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.6) 0%,
          rgba(46, 125, 50, 0.6) 100%
        );
        color: white;
      }

      .requirement-difficulty.medium {
        background: linear-gradient(
          135deg,
          rgba(255, 193, 7, 0.6) 0%,
          rgba(255, 152, 0, 0.6) 100%
        );
        color: white;
      }

      .requirement-difficulty.hard {
        background: linear-gradient(
          135deg,
          rgba(244, 67, 54, 0.6) 0%,
          rgba(233, 30, 99, 0.6) 100%
        );
        color: white;
      }

      .rich-story-progression {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.1) 0%,
          rgba(103, 58, 183, 0.1) 100%
        );
        border: 2px solid rgba(156, 39, 176, 0.3);
        border-radius: 16px;
        padding: 24px;
        margin: 20px 0;
        box-shadow: 0 8px 25px rgba(156, 39, 176, 0.2);
        backdrop-filter: blur(10px);
        animation: richStoryProgressionAppear 1s ease-out;
      }

      .story-narrative {
        font-size: 16px;
        line-height: 1.7;
        color: #f3e5f5;
        font-style: italic;
        margin-bottom: 16px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .story-atmosphere {
        font-size: 14px;
        line-height: 1.5;
        color: #e1bee7;
        opacity: 0.9;
        margin-bottom: 16px;
        font-style: italic;
      }

      .story-consequences {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .immediate-consequence {
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.2) 0%,
          rgba(46, 125, 50, 0.2) 100%
        );
        border: 1px solid rgba(76, 175, 80, 0.3);
        border-radius: 8px;
        padding: 12px;
        color: #a5d6a7;
        font-weight: 500;
      }

      .long-term-consequence {
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.2) 0%,
          rgba(30, 136, 229, 0.2) 100%
        );
        border: 1px solid rgba(33, 150, 243, 0.3);
        border-radius: 8px;
        padding: 12px;
        color: #90caf9;
        font-weight: 500;
      }

      @keyframes richStoryProgressionAppear {
        0% {
          opacity: 0;
          transform: translateY(-30px) scale(0.95);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .karma-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(
          135deg,
          rgba(76, 175, 80, 0.9) 0%,
          rgba(46, 125, 50, 0.9) 100%
        );
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 1000;
        animation: notificationAppear 0.5s ease-out;
      }

      .karma-notification.negative {
        background: linear-gradient(
          135deg,
          rgba(244, 67, 54, 0.9) 0%,
          rgba(233, 30, 99, 0.9) 100%
        );
      }

      .reputation-notification {
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.9) 0%,
          rgba(30, 136, 229, 0.9) 100%
        );
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 1000;
        animation: notificationAppear 0.5s ease-out;
      }

      .event-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(
          135deg,
          rgba(255, 193, 7, 0.9) 0%,
          rgba(255, 152, 0, 0.9) 100%
        );
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 1000;
        animation: notificationAppear 0.5s ease-out;
      }

      @keyframes notificationAppear {
        0% {
          opacity: 0;
          transform: translateX(100px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .choices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }

      .choice-btn.advanced-choice {
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .choice-btn.advanced-choice:hover {
        transform: translateY(-6px);
        box-shadow: 0 16px 40px rgba(156, 39, 176, 0.4);
      }

      /* Display rich story progression - HIDDEN CONSEQUENCES */
      .rich-story-progression {
        background: linear-gradient(
          135deg,
          rgba(156, 39, 176, 0.1) 0%,
          rgba(103, 58, 183, 0.1) 100%
        );
        border: 2px solid rgba(156, 39, 176, 0.3);
        border-radius: 16px;
        padding: 24px;
        margin: 20px 0;
        box-shadow: 0 8px 25px rgba(156, 39, 176, 0.2);
        backdrop-filter: blur(10px);
        animation: richStoryProgressionAppear 1s ease-out;
      }

      .choice-mystery {
        margin-top: 12px;
        padding: 8px 12px;
        background: linear-gradient(135deg, rgba(156, 39, 176, 0.2) 0%, rgba(103, 58, 183, 0.2) 100%);
        border: 1px solid rgba(156, 39, 176, 0.3);
        border-radius: 8px;
      }

      .mystery-hint {
        color: #e1bee7;
        font-size: 13px;
        font-style: italic;
        opacity: 0.8;
      }

      .story-mystery {
        margin-top: 16px;
        padding: 12px;
        background: linear-gradient(135deg, rgba(156, 39, 176, 0.2) 0%, rgba(103, 58, 183, 0.2) 100%);
        border: 1px solid rgba(156, 39, 176, 0.3);
        border-radius: 8px;
      }

      .mystery-text {
        color: #e1bee7;
        font-size: 14px;
        font-style: italic;
        text-align: center;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <!-- Sol Panel -->
      <div class="left-panel">
        <h3>⚔️ AI Dungeon Master</h3>

        <div class="theme-tabs">
          <div class="theme-tab active" onclick="switchTheme('fantasy', event)">
            Fantasy
          </div>
          <div class="theme-tab" onclick="switchTheme('warhammer', event)">
            Warhammer 40K
          </div>
          <div class="theme-tab" onclick="switchTheme('cyberpunk', event)">
            Cyberpunk
          </div>
        </div>

        <div id="fantasy-content" class="theme-content">
          <!-- Character Creation Section -->
          <div class="character-creation">
            <h4>👤 Karakter Oluştur</h4>

            <div class="creation-section">
              <label>İsim:</label>
              <input
                type="text"
                id="character-name-input"
                placeholder="Karakter adı..."
                value="Yeni Kahraman"
              />
            </div>

            <div class="creation-section">
              <label>Irk:</label>
              <div class="race-options" id="fantasy-races">
                <div
                  class="race-option selected"
                  data-race="human"
                  onclick="selectRace('human', 'fantasy')"
                >
                  👤 İnsan
                </div>
                <div
                  class="race-option"
                  data-race="elf"
                  onclick="selectRace('elf', 'fantasy')"
                >
                  🧝‍♀️ Elf
                </div>
                <div
                  class="race-option"
                  data-race="dwarf"
                  onclick="selectRace('dwarf', 'fantasy')"
                >
                  🧙‍♂️ Cüce
                </div>
                <div
                  class="race-option"
                  data-race="orc"
                  onclick="selectRace('orc', 'fantasy')"
                >
                  👹 Ork
                </div>
                <div
                  class="race-option"
                  data-race="halfling"
                  onclick="selectRace('halfling', 'fantasy')"
                >
                  🧒 Halfling
                </div>
              </div>
            </div>

            <div class="creation-section">
              <label>Sınıf:</label>
              <div class="class-options" id="fantasy-classes">
                <div
                  class="class-option selected"
                  data-class="warrior"
                  onclick="selectClass('warrior', 'fantasy')"
                >
                  ⚔️ Savaşçı
                </div>
                <div
                  class="class-option"
                  data-class="mage"
                  onclick="selectClass('mage', 'fantasy')"
                >
                  🔮 Büyücü
                </div>
                <div
                  class="class-option"
                  data-class="rogue"
                  onclick="selectClass('rogue', 'fantasy')"
                >
                  🗡️ Hırsız
                </div>
                <div
                  class="class-option"
                  data-class="cleric"
                  onclick="selectClass('cleric', 'fantasy')"
                >
                  ⛪ Rahip
                </div>
                <div
                  class="class-option"
                  data-class="ranger"
                  onclick="selectClass('ranger', 'fantasy')"
                >
                  🏹 Avcı
                </div>
              </div>
            </div>

            <div class="creation-section">
              <label>İstatistikler:</label>
              <div class="stats-display" id="fantasy-stats">
                <div class="stat-row">
                  <span>Güç:</span>
                  <span class="stat-value" id="strength-value">15</span>
                </div>
                <div class="stat-row">
                  <span>Çeviklik:</span>
                  <span class="stat-value" id="dexterity-value">12</span>
                </div>
                <div class="stat-row">
                  <span>Dayanıklılık:</span>
                  <span class="stat-value" id="constitution-value">14</span>
                </div>
                <div class="stat-row">
                  <span>Zeka:</span>
                  <span class="stat-value" id="intelligence-value">10</span>
                </div>
                <div class="stat-row">
                  <span>Bilgelik:</span>
                  <span class="stat-value" id="wisdom-value">8</span>
                </div>
                <div class="stat-row">
                  <span>Karizma:</span>
                  <span class="stat-value" id="charisma-value">13</span>
                </div>
              </div>
            </div>

            <button class="create-character-btn" onclick="createCharacter()">
              🎭 Karakteri Oluştur
            </button>
          </div>

          <!-- AI Features Section -->
          <div class="ai-features-section">
            <h4>🤖 AI Özellikleri</h4>

            <button class="ai-feature-btn" onclick="openRAGUpload()">
              📄 Doküman Yükle (RAG)
            </button>

            <button class="ai-feature-btn" onclick="openAIStoryCreator()">
              ✍️ AI Hikaye Oluşturucu
            </button>

            <button class="ai-feature-btn" onclick="openAIAgentPanel()">
              🧠 AI Agent Paneli
            </button>

            <button
              class="ai-feature-btn"
              onclick="openCustomScenarioCreator()"
            >
              🎯 Özel Senaryo Oluştur
            </button>
          </div>
        </div>

        <div id="warhammer-content" class="theme-content" style="display: none">
          <!-- Character Creation Section -->
          <div class="character-creation">
            <h4>👤 Karakter Oluştur</h4>

            <div class="creation-section">
              <label>İsim:</label>
              <input
                type="text"
                id="character-name-input-warhammer"
                placeholder="Karakter adı..."
                value="Yeni Kahraman"
              />
            </div>

            <div class="creation-section">
              <label>Irk:</label>
              <div class="race-options" id="warhammer-races">
                <div
                  class="race-option selected"
                  data-race="human"
                  onclick="selectRace('human', 'warhammer')"
                >
                  👤 İnsan
                </div>
                <div
                  class="race-option"
                  data-race="space-marine"
                  onclick="selectRace('space-marine', 'warhammer')"
                >
                  🛡️ Space Marine
                </div>
                <div
                  class="race-option"
                  data-race="eldar"
                  onclick="selectRace('eldar', 'warhammer')"
                >
                  🌟 Eldar
                </div>
                <div
                  class="race-option"
                  data-race="ork"
                  onclick="selectRace('ork', 'warhammer')"
                >
                  💀 Ork
                </div>
                <div
                  class="race-option"
                  data-race="tau"
                  onclick="selectRace('tau', 'warhammer')"
                >
                  🔫 Tau
                </div>
              </div>
            </div>

            <div class="creation-section">
              <label>Sınıf:</label>
              <div class="race-options" id="warhammer-classes">
                <div
                  class="class-option selected"
                  data-class="commissar"
                  onclick="selectClass('commissar', 'warhammer')"
                >
                  ⚔️ Commissar
                </div>
                <div
                  class="class-option"
                  data-class="psyker"
                  onclick="selectClass('psyker', 'warhammer')"
                >
                  🔮 Psyker
                </div>
                <div
                  class="class-option"
                  data-class="tech-priest"
                  onclick="selectClass('tech-priest', 'warhammer')"
                >
                  ⚙️ Tech Priest
                </div>
                <div
                  class="class-option"
                  data-class="assassin"
                  onclick="selectClass('assassin', 'warhammer')"
                >
                  🗡️ Assassin
                </div>
                <div
                  class="class-option"
                  data-class="inquisitor"
                  onclick="selectClass('inquisitor', 'warhammer')"
                >
                  🔍 Inquisitor
                </div>
              </div>
            </div>

            <div class="creation-section">
              <label>İstatistikler:</label>
              <div class="stats-display" id="warhammer-stats">
                <div class="stat-row">
                  <span>Güç:</span>
                  <span class="stat-value" id="strength-value-warhammer"
                    >18</span
                  >
                </div>
                <div class="stat-row">
                  <span>Çeviklik:</span>
                  <span class="stat-value" id="dexterity-value-warhammer"
                    >14</span
                  >
                </div>
                <div class="stat-row">
                  <span>Dayanıklılık:</span>
                  <span class="stat-value" id="constitution-value-warhammer"
                    >16</span
                  >
                </div>
                <div class="stat-row">
                  <span>Zeka:</span>
                  <span class="stat-value" id="intelligence-value-warhammer"
                    >12</span
                  >
                </div>
                <div class="stat-row">
                  <span>Bilgelik:</span>
                  <span class="stat-value" id="wisdom-value-warhammer">10</span>
                </div>
                <div class="stat-row">
                  <span>Karizma:</span>
                  <span class="stat-value" id="charisma-value-warhammer"
                    >15</span
                  >
                </div>
              </div>
            </div>

            <button class="create-character-btn" onclick="createCharacter()">
              🎭 Karakteri Oluştur
            </button>
          </div>
        </div>

        <div id="cyberpunk-content" class="theme-content" style="display: none">
          <!-- Character Creation Section -->
          <div class="character-creation">
            <h4>👤 Karakter Oluştur</h4>

            <div class="creation-section">
              <label>İsim:</label>
              <input
                type="text"
                id="character-name-input-cyberpunk"
                placeholder="Karakter adı..."
                value="Yeni Kahraman"
              />
            </div>

            <div class="creation-section">
              <label>Irk:</label>
              <div class="race-options" id="cyberpunk-races">
                <div
                  class="race-option selected"
                  data-race="human"
                  onclick="selectRace('human', 'cyberpunk')"
                >
                  👤 İnsan
                </div>
                <div
                  class="race-option"
                  data-race="android"
                  onclick="selectRace('android', 'cyberpunk')"
                >
                  🤖 Android
                </div>
                <div
                  class="race-option"
                  data-race="cyborg"
                  onclick="selectRace('cyborg', 'cyberpunk')"
                >
                  🔧 Cyborg
                </div>
                <div
                  class="race-option"
                  data-race="mutant"
                  onclick="selectRace('mutant', 'cyberpunk')"
                >
                  🧬 Mutant
                </div>
                <div
                  class="race-option"
                  data-race="enhanced"
                  onclick="selectRace('enhanced', 'cyberpunk')"
                >
                  ⚡ Enhanced
                </div>
              </div>
            </div>

            <div class="creation-section">
              <label>Sınıf:</label>
              <div class="class-options" id="cyberpunk-classes">
                <div
                  class="class-option selected"
                  data-class="netrunner"
                  onclick="selectClass('netrunner', 'cyberpunk')"
                >
                  💻 Netrunner
                </div>
                <div
                  class="class-option"
                  data-class="solo"
                  onclick="selectClass('solo', 'cyberpunk')"
                >
                  🔫 Solo
                </div>
                <div
                  class="class-option"
                  data-class="techie"
                  onclick="selectClass('techie', 'cyberpunk')"
                >
                  🔧 Techie
                </div>
                <div
                  class="class-option"
                  data-class="fixer"
                  onclick="selectClass('fixer', 'cyberpunk')"
                >
                  💰 Fixer
                </div>
                <div
                  class="class-option"
                  data-class="nomad"
                  onclick="selectClass('nomad', 'cyberpunk')"
                >
                  🏍️ Nomad
                </div>
              </div>
            </div>

            <div class="creation-section">
              <label>İstatistikler:</label>
              <div class="stats-display" id="cyberpunk-stats">
                <div class="stat-row">
                  <span>Güç:</span>
                  <span class="stat-value" id="strength-value-cyberpunk"
                    >12</span
                  >
                </div>
                <div class="stat-row">
                  <span>Çeviklik:</span>
                  <span class="stat-value" id="dexterity-value-cyberpunk"
                    >16</span
                  >
                </div>
                <div class="stat-row">
                  <span>Dayanıklılık:</span>
                  <span class="stat-value" id="constitution-value-cyberpunk"
                    >13</span
                  >
                </div>
                <div class="stat-row">
                  <span>Zeka:</span>
                  <span class="stat-value" id="intelligence-value-cyberpunk"
                    >15</span
                  >
                </div>
                <div class="stat-row">
                  <span>Bilgelik:</span>
                  <span class="stat-value" id="wisdom-value-cyberpunk">10</span>
                </div>
                <div class="stat-row">
                  <span>Karizma:</span>
                  <span class="stat-value" id="charisma-value-cyberpunk"
                    >14</span
                  >
                </div>
              </div>
            </div>

            <button class="create-character-btn" onclick="createCharacter()">
              🎭 Karakteri Oluştur
            </button>
          </div>
        </div>

        <div class="stats-section">
          <h4>📊 Oyun İstatistikleri</h4>
          <div class="stat-row">
            <span>Aktif Senaryo</span>
            <span class="stat-value" id="active-scenario">-</span>
          </div>
          <div class="stat-row">
            <span>Toplam XP</span>
            <span class="stat-value" id="total-xp">0</span>
          </div>
          <div class="stat-row">
            <span>Karma</span>
            <span class="stat-value" id="karma">0</span>
          </div>
          <div class="stat-row">
            <span>Tamamlanan</span>
            <span class="stat-value" id="completed">0</span>
          </div>
        </div>
      </div>

      <!-- Orta Panel -->
      <div class="center-panel">
        <!-- Scenario Selection Section -->
        <div class="scenarios-selection">
          <h3 style="color: #ffd700; margin-bottom: 15px; text-align: center">
            📜 Senaryolar
          </h3>
          <button onclick="loadScenarios()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            font-weight: bold;
          ">🔄 Senaryoları Yeniden Yükle</button>
          <button onclick="testEverything()" style="
            background: #ff9800;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            font-weight: bold;
            margin-left: 10px;
          ">🧪 Test Et</button>
          <button onclick="alert('JavaScript çalışıyor!')" style="
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            font-weight: bold;
            margin-left: 10px;
          ">🚨 JS TEST</button>
          
          <button onclick="testAllButtons()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            font-weight: bold;
            margin-left: 10px;
          ">🔍 BUTON TEST</button>

          <div id="scenarios-container">
            <!-- Scenarios will be loaded here -->
            <div class="scenario-item" onclick="selectScenario({id: 'dragon_hunters_path', title: 'Ejderha Avcısının Yolu', description: 'Kızıl ejderha köyleri yakıyor. Sen ejderha avcısısın.', difficulty: 'hard', theme: 'fantasy'})">
              <div class="scenario-title">🐉 Ejderha Avcısının Yolu</div>
              <div class="scenario-desc">Kızıl ejderha köyleri yakıyor. Sen ejderha avcısısın.</div>
              <div class="scenario-meta">
                <span class="difficulty">hard</span>
                <span class="genre">fantasy</span>
              </div>
            </div>
            <div class="scenario-item" onclick="selectScenario({id: 'magical_forest_mysteries', title: 'Büyülü Ormanın Gizemleri', description: 'Büyülü yaratıklarla dolu gizemli orman.', difficulty: 'hard', theme: 'fantasy'})">
              <div class="scenario-title">🌳 Büyülü Ormanın Gizemleri</div>
              <div class="scenario-desc">Büyülü yaratıklarla dolu gizemli orman.</div>
              <div class="scenario-meta">
                <span class="difficulty">hard</span>
                <span class="genre">fantasy</span>
              </div>
            </div>
            <div class="scenario-item" onclick="selectScenario({id: 'hive_city_defense', title: 'Hive Şehrinin Savunması', description: 'Devasa hive şehrini dış tehditlerden koruma görevi.', difficulty: 'hard', theme: 'warhammer'})">
              <div class="scenario-title">🏰 Hive Şehrinin Savunması</div>
              <div class="scenario-desc">Devasa hive şehrini dış tehditlerden koruma görevi.</div>
              <div class="scenario-meta">
                <span class="difficulty">hard</span>
                <span class="genre">warhammer</span>
              </div>
            </div>
            <div class="scenario-item" onclick="selectScenario({id: 'cyberpunk_city_secrets', title: 'Cyberpunk Şehir Gizemleri', description: 'Neon ışıkları altında teknoloji ve gizem.', difficulty: 'hard', theme: 'cyberpunk'})">
              <div class="scenario-title">🌃 Cyberpunk Şehir Gizemleri</div>
              <div class="scenario-desc">Neon ışıkları altında teknoloji ve gizem.</div>
              <div class="scenario-meta">
                <span class="difficulty">hard</span>
                <span class="genre">cyberpunk</span>
              </div>
            </div>
          </div>

          <!-- AI Generated Scenarios Section -->
          <div
            class="ai-scenarios-section"
            style="
              margin-top: 20px;
              padding: 15px;
              background: rgba(0, 0, 0, 0.3);
              border-radius: 8px;
              border: 1px solid rgba(255, 215, 0, 0.3);
            "
          >
            <h4 style="color: #ffd700; margin-bottom: 10px; text-align: center">
              🤖 AI Üretilen Senaryolar
            </h4>
            <p style="text-align: center; margin-bottom: 15px; font-size: 14px">
              AI tarafından özel olarak üretilen benzersiz hikayeler!
            </p>
            <div id="ai-scenarios-container">
              <!-- AI Generated scenarios will be loaded here -->
              <div class="scenario-item" onclick="selectScenario({id: 'ai_fantasy_adventure', title: 'AI: Fantastik Macera', description: 'AI tarafından üretilen benzersiz fantastik hikaye.', difficulty: 'medium', theme: 'fantasy', ai_generated: true})">
                <div class="scenario-title">🤖 AI: Fantastik Macera</div>
                <div class="scenario-desc">AI tarafından üretilen benzersiz fantastik hikaye.</div>
                <div class="scenario-meta">
                  <span class="difficulty">medium</span>
                  <span class="genre">fantasy</span>
                  <span class="ai-badge" style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">AI</span>
                </div>
              </div>
              <div class="scenario-item" onclick="selectScenario({id: 'ai_scifi_mission', title: 'AI: Bilim Kurgu Görevi', description: 'AI tarafından üretilen gelecek teknolojisi hikayesi.', difficulty: 'hard', theme: 'scifi', ai_generated: true})">
                <div class="scenario-title">🤖 AI: Bilim Kurgu Görevi</div>
                <div class="scenario-desc">AI tarafından üretilen gelecek teknolojisi hikayesi.</div>
                <div class="scenario-meta">
                  <span class="difficulty">hard</span>
                  <span class="genre">scifi</span>
                  <span class="ai-badge" style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">AI</span>
                </div>
              </div>
              <div class="scenario-item" onclick="selectScenario({id: 'ai_cyberpunk_thriller', title: 'AI: Cyberpunk Gerilim', description: 'AI tarafından üretilen neon ışıkları altında gerilim.', difficulty: 'hard', theme: 'cyberpunk', ai_generated: true})">
                <div class="scenario-title">🤖 AI: Cyberpunk Gerilim</div>
                <div class="scenario-desc">AI tarafından üretilen neon ışıkları altında gerilim.</div>
                <div class="scenario-meta">
                  <span class="difficulty">hard</span>
                  <span class="genre">cyberpunk</span>
                  <span class="ai-badge" style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">AI</span>
                </div>
              </div>
              <div class="scenario-item" onclick="selectScenario({id: 'ai_warhammer_battle', title: 'AI: Warhammer Savaşı', description: 'AI tarafından üretilen epik Warhammer 40K savaşı.', difficulty: 'hard', theme: 'warhammer', ai_generated: true})">
                <div class="scenario-title">🤖 AI: Warhammer Savaşı</div>
                <div class="scenario-desc">AI tarafından üretilen epik Warhammer 40K savaşı.</div>
                <div class="scenario-meta">
                  <span class="difficulty">hard</span>
                  <span class="genre">warhammer</span>
                  <span class="ai-badge" style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">AI</span>
                </div>
              </div>
            </div>
            <button
              class="generate-ai-scenario-btn"
              onclick="generateAIScenario()"
              style="
                width: 100%;
                padding: 12px;
                background: linear-gradient(45deg, #9c27b0, #673ab7);
                border: none;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 14px;
                margin-top: 10px;
              "
            >
              🤖 Yeni AI Senaryo Üret
            </button>
          </div>
        </div>

          <div
            class="advanced-story-section"
            style="
              margin-top: 20px;
              padding: 15px;
              background: rgba(0, 0, 0, 0.3);
              border-radius: 8px;
              border: 1px solid rgba(255, 215, 0, 0.3);
            "
          >
            <h4 style="color: #ffd700; margin-bottom: 10px; text-align: center">
              📚 Gelişmiş Hikaye Oluşturucu
            </h4>
            <p style="text-align: center; margin-bottom: 15px; font-size: 14px">
              Kendi hikayeni oluştur ve AI ile geliştir!
            </p>
            <button
              class="advanced-story-btn"
              onclick="document.getElementById('advanced-story-modal').style.display='block'"
              style="
                width: 100%;
                padding: 12px;
                background: linear-gradient(45deg, #9c27b0, #673ab7);
                border: none;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 14px;
              "
            >
              📚 Gelişmiş Hikaye Oluştur
            </button>
          </div>
        </div>

        <div class="scenario-header" id="scenario-header" style="display: none">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <button
              onclick="backToScenarios()"
              style="
                background: #ffd700;
                color: #000;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
              "
            >
              ← Senaryolara Dön
            </button>
            <h1 class="scenario-title" id="current-scenario-title">
              📜 Senaryo Seçin
            </h1>
          </div>
        </div>

        <div
          class="scenario-description"
          id="current-scenario-description"
          style="display: none"
        >
          Sol panelden bir senaryo seçin veya yeni bir hikaye başlatın.
        </div>

        <div class="choices-section" id="choices-section" style="display: none">
          <h4 class="choices-title">⚡ Seçeneklerin:</h4>
          <div class="choices-grid" id="choices-grid">
            <!-- Choices will be loaded here -->
          </div>
        </div>

        <div class="contextual-actions-section" id="contextual-actions-section" style="display: none">
          <h4 class="actions-title">🎯 Aksiyonlar:</h4>
          <div class="contextual-actions" id="contextual-actions">
            <!-- Contextual actions will be loaded here -->
          </div>
        </div>

        <div class="game-status">
          <h4 style="color: #ffd700; margin-bottom: 8px">🎮 Oyun Durumu</h4>
          <div class="status-row">
            <span>Seviye</span>
            <span id="player-level">1</span>
          </div>
          <div class="status-row">
            <span>XP</span>
            <span id="player-xp">0</span>
          </div>
          <div class="status-row">
            <span>Karma</span>
            <span id="player-karma">0</span>
          </div>
        </div>
      </div>

      <!-- Sağ Panel -->
      <div class="right-panel">
        <h3>🎮 Oyun Durumu</h3>
        
        <!-- Character Info Section -->
        <div class="character-info">
          <div class="character-name" id="character-name">Aelindra</div>
          <div class="character-details" id="character-class">Elf Savaşçısı</div>
          <div class="character-lore" id="character-lore">
            <span class="lore-title">📖 Hikaye:</span>
            <span class="lore-text">Antik ormanın son elf savaşçısı, ejderha avcısı geleneğinin son temsilcisi.</span>
          </div>
        </div>
        
        <!-- Level & XP Section -->
        <div class="level-info">
          <div class="level-row">
            <span>Level:</span>
            <span class="level-value" id="char-level">1</span>
          </div>
          <div class="level-row">
            <span>XP:</span>
            <span class="level-value" id="char-xp">0/100</span>
          </div>
          <div class="level-row">
            <span>Sonraki Level:</span>
            <span class="level-value" id="next-level">100 XP</span>
          </div>
          <div class="level-row">
            <span>Karma:</span>
            <span class="level-value" id="char-karma">0</span>
          </div>
        </div>
        
        <!-- Stats Grid Section -->
        <div class="stats-grid" id="stats-grid">
          <div class="stat-box">
            <div class="stat-box-name">Güç</div>
            <div class="stat-box-value" id="strength-display">15</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-name">Çeviklik</div>
            <div class="stat-box-value" id="dexterity-display">18</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-name">Zeka</div>
            <div class="stat-box-value" id="intelligence-display">16</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-name">Dayanıklılık</div>
            <div class="stat-box-value" id="constitution-display">14</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-name">Bilgelik</div>
            <div class="stat-box-value" id="wisdom-display">13</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-name">Karizma</div>
            <div class="stat-box-value" id="charisma-display">17</div>
          </div>
        </div>
        
        <!-- Equipment Section -->
        <div class="equipment-section">
          <div class="equipment-title">🛡️ Ekipmanlar</div>
          <div class="equipment-slot" onclick="changeEquipment('weapon')">
            <span class="slot-name">Silah:</span>
            <span class="slot-item" id="weapon-slot">Steel Sword</span>
            <span class="slot-lore">Antik elf ustası tarafından dövülmüş</span>
          </div>
          <div class="equipment-slot" onclick="changeEquipment('armor')">
            <span class="slot-name">Zırh:</span>
            <span class="slot-item" id="armor-slot">Leather Armor</span>
            <span class="slot-lore">Ejderha derisinden yapılmış</span>
          </div>
          <div class="equipment-slot" onclick="changeEquipment('shield')">
            <span class="slot-name">Kalkan:</span>
            <span class="slot-item" id="shield-slot">-</span>
            <span class="slot-lore">Boş slot</span>
          </div>
          <div class="equipment-slot" onclick="changeEquipment('gloves')">
            <span class="slot-name">Eldiven:</span>
            <span class="slot-item" id="gloves-slot">Magic Ring</span>
            <span class="slot-lore">Büyülü güçler içeriyor</span>
          </div>
          <div class="equipment-slot" onclick="changeEquipment('boots')">
            <span class="slot-name">Ayakkabı:</span>
            <span class="slot-item" id="boots-slot">-</span>
            <span class="slot-lore">Boş slot</span>
          </div>
        </div>
        
        <!-- Inventory Section -->
        <div class="inventory-section">
          <div class="inventory-title">🎒 Envanter</div>
          <div class="inventory-grid" id="inventory-grid">
            <div class="inventory-slot filled" onclick="useItem(this)" title="Elf Kılıcı - Antik büyü ile güçlendirilmiş">⚔️</div>
            <div class="inventory-slot filled" onclick="useItem(this)" title="Can İksiri - Yaraları iyileştirir">🧪</div>
            <div class="inventory-slot filled" onclick="useItem(this)" title="Elf Ekmeği - Enerji verir">🍞</div>
            <div class="inventory-slot filled" onclick="useItem(this)" title="Altın - 50 altın">💰</div>
            <div class="inventory-slot" onclick="addRandomItem(this)" title="Yeni öğe ekle">+</div>
            <div class="inventory-slot" onclick="addRandomItem(this)" title="Yeni öğe ekle">+</div>
            <div class="inventory-slot" onclick="addRandomItem(this)" title="Yeni öğe ekle">+</div>
            <div class="inventory-slot" onclick="addRandomItem(this)" title="Yeni öğe ekle">+</div>
            <div class="inventory-slot" onclick="addRandomItem(this)" title="Yeni öğe ekle">+</div>
          </div>
        </div>
        
        <!-- Character Actions Section -->
        <div class="character-actions">
          <div class="action-title">⚡ Aksiyonlar</div>
          <button class="action-btn" onclick="performAction('rest')" title="Can ve mana yeniler">🛏️ Dinlen</button>
          <button class="action-btn" onclick="performAction('train')" title="Güç ve beceri artırır">⚔️ Antrenman</button>
          <button class="action-btn" onclick="performAction('craft')" title="Yeni ekipman üretir">🔧 Üret</button>
          <button class="action-btn" onclick="performAction('trade')" title="Altın kazanır">💰 Ticaret</button>
        </div>
        
        <!-- Lore Information Section -->
        <div class="lore-section">
          <div class="lore-title">📚 Dünya Bilgisi</div>
          <div class="lore-content" id="lore-content">
            <div class="lore-item">
              <span class="lore-category">🌍 Bölge:</span>
              <span class="lore-text">Antik Orman - Ejderhaların son sığınağı</span>
            </div>
            <div class="lore-item">
              <span class="lore-category">⚔️ Tehdit:</span>
              <span class="lore-text">Kızıl Ejderha - Köyleri yakıp yıkıyor</span>
            </div>
            <div class="lore-item">
              <span class="lore-category">🏰 Yerleşim:</span>
              <span class="lore-text">Elf Köyü - Son güvenli sığınak</span>
            </div>
            <div class="lore-item">
              <span class="lore-category">🎯 Görev:</span>
              <span class="lore-text">Ejderhayı durdur ve köyü kurtar</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Simple working JavaScript
      console.log("🚀 JAVASCRIPT LOADED!");
      
      // Global variables
      let currentTheme = 'fantasy';
      let scenarios = [];
      
      // Simple test function
      function testEverything() {
        console.log("🧪 Test function called!");
        alert("✅ JavaScript çalışıyor!");
        
        // Test right panel
        const rightPanel = document.querySelector('.right-panel');
        if (rightPanel) {
          console.log("✅ Right panel found!");
          rightPanel.style.border = "2px solid red";
        } else {
          console.log("❌ Right panel not found!");
        }
      }
      
      // Simple theme switching
      function switchTheme(theme, event) {
        console.log("🎨 Theme switched to:", theme);
        currentTheme = theme;
        
        // Update active tab
        document.querySelectorAll('.theme-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        if (event && event.target) {
          event.target.classList.add('active');
        }
        
        alert(`Tema değiştirildi: ${theme}`);
      }
      
      // Simple equipment change
      function changeEquipment(slotType) {
        console.log("🛡️ Equipment changed:", slotType);
        const slotElement = document.getElementById(slotType + '-slot');
        if (slotElement) {
          const items = ['Steel Sword', 'Magic Bow', 'Fire Axe', 'Ice Staff', 'Thunder Hammer'];
          const currentItem = slotElement.textContent;
          const currentIndex = items.indexOf(currentItem);
          const nextIndex = (currentIndex + 1) % items.length;
          slotElement.textContent = items[nextIndex];
          alert(`Ekipman değiştirildi: ${items[nextIndex]}`);
        }
      }
      
      // Simple action
      function performAction(action) {
        console.log("⚡ Action performed:", action);
        const messages = {
          'rest': '🛏️ Dinlendin ve canını yeniledin!',
          'train': '⚔️ Antrenman yaptın ve güçlendin!',
          'craft': '🔧 Yeni ekipman ürettin!',
          'trade': '💰 Ticaret yaptın ve altın kazandın!'
        };
        alert(messages[action] || 'Aksiyon gerçekleştirildi!');
      }
      
      // Simple item use
      function useItem(itemElement) {
        console.log("🎒 Item used:", itemElement.textContent);
        alert(`Öğe kullanıldı: ${itemElement.textContent}`);
        itemElement.textContent = '+';
        itemElement.classList.remove('filled');
      }
      
      // Simple add item
      function addRandomItem(itemElement) {
        console.log("🎒 Adding random item");
        const items = ['⚔️', '🛡️', '🧪', '🍖', '💎', '📜', '🗝️', '🏹'];
        const randomItem = items[Math.floor(Math.random() * items.length)];
        itemElement.textContent = randomItem;
        itemElement.classList.add('filled');
        alert(`Yeni öğe eklendi: ${randomItem}`);
      }
      
      // Enhanced scenario selection
      function selectScenario(scenario) {
        console.log("🎯 Scenario selected:", scenario.title);
        
        // Show scenario details in center panel
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="scenario-detail">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">🎮 ${scenario.title}</h3>
              
              <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <p style="font-size: 14px; line-height: 1.6; margin-bottom: 15px;">${scenario.description}</p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                  <span style="background: #FF9800; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                    Zorluk: ${scenario.difficulty || 'Normal'}
                  </span>
                  <span style="background: #9C27B0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                    Tema: ${scenario.theme || scenario.genre || 'Fantasy'}
                  </span>
                </div>
                
                <div style="text-align: center;">
                  <button onclick="startScenario('${scenario.id}')" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                    margin-right: 10px;
                  ">🚀 Senaryoyu Başlat</button>
                  
                  <button onclick="backToScenarios()" style="
                    background: #FF9800;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                  ">← Geri Dön</button>
                </div>
              </div>
              
              <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,215,0,0.3);">
                <h4 style="color: #FFD700; margin-bottom: 10px;">📖 Senaryo Detayları</h4>
                <ul style="font-size: 13px; line-height: 1.5;">
                  <li>🎯 <strong>Görev:</strong> ${scenario.description}</li>
                  <li>⏱️ <strong>Süre:</strong> ${scenario.estimatedPlayTime || 60} dakika</li>
                  <li>🎭 <strong>Karmaşık:</strong> ${scenario.complexity || 'Orta'}</li>
                  <li>🌟 <strong>Özellikler:</strong> Gelişmiş hikaye anlatımı, NPC etkileşimleri, savaş sistemi</li>
                </ul>
              </div>
            </div>
          `;
        }
        
        alert(`✅ Senaryo seçildi: ${scenario.title}`);
      }
      
      // Start scenario
      function startScenario(scenarioId) {
        console.log("🚀 Starting scenario:", scenarioId);
        
        // Load scenario details from API
        fetch(`/api/story/scenario/${scenarioId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const scenario = data.scenario;
              showScenarioStory(scenario);
            } else {
              alert("❌ Senaryo yüklenemedi!");
            }
          })
          .catch(error => {
            console.error("API Error:", error);
            alert("❌ Bağlantı hatası!");
          });
      }
      
      // Show scenario story
      function showScenarioStory(scenario) {
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="scenario-story">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 ${scenario.title}</h3>
              
              <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px; text-align: justify;">
                  ${scenario.description}
                </p>
                
                <div style="text-align: center; margin: 20px 0;">
                  <p style="color: #FFD700; font-style: italic; font-size: 14px;">
                    "Bu macerada her seçimin sonuçları olacak. Dikkatli ol ve seçimlerini akıllıca yap..."
                  </p>
                </div>
                
                <div style="text-align: center;">
                  <button onclick="showStoryChoices('${scenario.id}')" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 16px;
                  ">🎭 Hikayeye Başla</button>
                </div>
              </div>
            </div>
          `;
        }
      }
      
      // Show story choices
      function showStoryChoices(scenarioId) {
        console.log("🎭 Loading story choices for scenario:", scenarioId);
        
        // Load story node from API
        fetch(`/api/story/node/${scenarioId}/start`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.node) {
              displayStoryNode(data.node, scenarioId);
            } else {
              alert("❌ Hikaye yüklenemedi!");
            }
          })
          .catch(error => {
            console.error("API Error:", error);
            alert("❌ Bağlantı hatası!");
          });
      }
      
      // Display story node with choices
      function displayStoryNode(node, scenarioId) {
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          let choicesHtml = '';
          
          if (node.choices && node.choices.length > 0) {
            choicesHtml = `
              <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin: 20px 0;">
                ${node.choices.map(choice => `
                  <button onclick="makeStoryChoice('${scenarioId}', '${choice.text}')" style="
                    background: rgba(76, 175, 80, 0.2);
                    border: 1px solid #4CAF50;
                    color: #4CAF50;
                    padding: 15px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    text-align: left;
                  " onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'" onmouseout="this.style.background='rgba(76, 175, 80, 0.2)'">
                    ${choice.text}
                  </button>
                `).join('')}
              </div>
            `;
          }
          
          centerPanel.innerHTML = `
            <div class="story-node">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 ${node.title || 'Hikaye'}</h3>
              
              <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px; text-align: justify;">
                  ${node.description}
                </p>
                
                ${choicesHtml}
                
                <div style="text-align: center;">
                  <button onclick="backToScenarios()" style="
                    background: #FF9800;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                  ">← Geri Dön</button>
                </div>
              </div>
            </div>
          `;
        }
      }
      
      // Make story choice
      function makeStoryChoice(scenarioId, choiceText) {
        console.log("🎯 Making story choice:", choiceText, "for scenario:", scenarioId);
        
        // Send choice to API
        fetch(`/api/game/story/progress`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            scenario_id: scenarioId,
            choice_text: choiceText
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Display next story node
            displayStoryProgress(data, scenarioId);
          } else {
            alert("❌ Seçim yapılamadı!");
          }
        })
        .catch(error => {
          console.error("API Error:", error);
          alert("❌ Bağlantı hatası!");
        });
      }
      
      // Display story progress
      function displayStoryProgress(data, scenarioId) {
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          let choicesHtml = '';
          
          if (data.available_actions && data.available_actions.length > 0) {
            choicesHtml = `
              <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin: 20px 0;">
                ${data.available_actions.map(choice => `
                  <button onclick="makeStoryChoice('${scenarioId}', '${choice}')" style="
                    background: rgba(76, 175, 80, 0.2);
                    border: 1px solid #4CAF50;
                    color: #4CAF50;
                    padding: 15px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    text-align: left;
                  " onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'" onmouseout="this.style.background='rgba(76, 175, 80, 0.2)'">
                    ${choice}
                  </button>
                `).join('')}
              </div>
            `;
          }
          
          centerPanel.innerHTML = `
            <div class="story-progress">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 Hikaye Devam Ediyor</h3>
              
              <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px; text-align: justify;">
                  ${data.message || data.story_text}
                </p>
                
                ${choicesHtml}
                
                <div style="text-align: center;">
                  <button onclick="backToScenarios()" style="
                    background: #FF9800;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                  ">← Geri Dön</button>
                </div>
              </div>
            </div>
          `;
        }
      }
      
      // Make choice
      function makeChoice(choiceType) {
        const choiceMessages = {
          'explore': '🔍 Çevreyi keşfetmeye başlıyorsun... Her adımda yeni sırlar keşfediyorsun.',
          'dialogue': '💬 NPC ile konuşmaya başlıyorsun... Kelimeler havada dans ediyor.',
          'combat': '⚔️ Savaşmaya hazırlanıyorsun... Silahlarını kontrol ediyorsun.',
          'stealth': '🥷 Gizlice ilerlemeye başlıyorsun... Gölgelerde hareket ediyorsun.'
        };
        
        alert(`🎯 Seçim yapıldı: ${choiceMessages[choiceType]}`);
        
        // Show story progression
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="story-progression">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 Hikaye Devam Ediyor</h3>
              
              <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px; text-align: justify;">
                  ${choiceMessages[choiceType]}
                </p>
                
                <div style="text-align: center; margin: 20px 0;">
                  <p style="color: #FFD700; font-style: italic; font-size: 14px;">
                    "Hikaye devam ediyor... Yeni seçenekler beliriyor..."
                  </p>
                </div>
                
                <div style="text-align: center;">
                  <button onclick="showStoryChoices()" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 16px;
                  ">🎭 Devam Et</button>
                </div>
              </div>
            </div>
          `;
        }
      }
      
      // Back to scenarios
      function backToScenarios() {
        loadScenarios();
      }
      
      // Simple load scenarios
      function loadScenarios() {
        console.log("🔄 Loading scenarios...");
        
        // API'den senaryoları yükle
        fetch('/api/scenarios')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.scenarios) {
              scenarios = data.scenarios;
              displayScenarios();
              alert(`✅ ${data.scenarios.length} senaryo yüklendi!`);
            } else {
              alert("❌ Senaryolar yüklenemedi!");
            }
          })
          .catch(error => {
            console.error("API Error:", error);
            alert("❌ Bağlantı hatası!");
          });
      }
      
      // Display scenarios
      function displayScenarios() {
        const container = document.getElementById('scenarios-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        scenarios.forEach(scenario => {
          const scenarioElement = document.createElement('div');
          scenarioElement.className = 'scenario-item';
          scenarioElement.innerHTML = `
            <div class="scenario-title">${scenario.title}</div>
            <div class="scenario-desc">${scenario.description}</div>
            <div class="scenario-meta">
              <span class="difficulty">${scenario.difficulty || 'normal'}</span>
              <span class="genre">${scenario.theme || 'fantasy'}</span>
            </div>
          `;
          scenarioElement.onclick = () => selectScenario(scenario);
          container.appendChild(scenarioElement);
        });
      }
      
      // Character functions
      let selectedRace = null;
      let selectedClass = null;
      
      function selectRace(race, theme) {
        console.log("🏃 Race selected:", race, "for theme:", theme);
        selectedRace = race;
        
        // Remove selected class from all race options
        document.querySelectorAll('.race-option').forEach(item => {
          item.classList.remove('selected');
        });
        
        // Add selected class to clicked item
        event.target.classList.add('selected');
        
        updatePreviewStats();
        console.log(`Irk seçildi: ${race}`);
      }
      
      function selectClass(className, theme) {
        console.log("⚔️ Class selected:", className, "for theme:", theme);
        selectedClass = className;
        
        // Remove selected class from all class options
        document.querySelectorAll('.class-option').forEach(item => {
          item.classList.remove('selected');
        });
        
        // Add selected class to clicked item
        event.target.classList.add('selected');
        
        updatePreviewStats();
        console.log(`Sınıf seçildi: ${className}`);
      }
      
      function updatePreviewStats() {
        if (!selectedRace || !selectedClass) {
          return; // Eğer ırk veya sınıf seçilmemişse çık
        }
        
        try {
          const stats = calculateCharacterStats(selectedRace, selectedClass);
          
          // Preview stats panelini güncelle
          const previewPanel = document.querySelector('.character-creation-panel');
          if (previewPanel) {
            const existingPreview = previewPanel.querySelector('.stats-preview');
            if (existingPreview) {
              existingPreview.remove();
            }
            
            const previewDiv = document.createElement('div');
            previewDiv.className = 'stats-preview';
            previewDiv.innerHTML = `
              <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,215,0,0.3); margin-top: 15px;">
                <h4 style="color: #FFD700; text-align: center; margin-bottom: 10px;">📊 Önizleme Statları</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                  <div>❤️ HP: <span style="color: #FFD700;">${stats.hp}</span></div>
                  <div>⚔️ Saldırı: <span style="color: #FFD700;">${stats.attack}</span></div>
                  <div>🛡️ Savunma: <span style="color: #FFD700;">${stats.defense}</span></div>
                  <div>🔮 Özel: <span style="color: #FFD700;">${stats.special}</span></div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.7); text-align: center;">
                  ${getRaceDescription(selectedRace)} | ${getClassDescription(selectedClass)}
                </div>
              </div>
            `;
            previewPanel.appendChild(previewDiv);
          }
        } catch (error) {
          console.error("Stats update error:", error);
        }
      }
      
      function getRaceDescription(race) {
        const descriptions = {
          'İnsan': 'Dengeli ve uyumlu',
          'Elf': 'Zarif ve büyüye yatkın',
          'Cüce': 'Güçlü ve dayanıklı',
          'Ork': 'Vahşi ve güçlü',
          'Android': 'Yapay zeka ile donatılmış',
          'Uzaylı': 'Telepatik yeteneklere sahip',
          'Mutasyon': 'Radyasyon sonucu değişmiş',
          'Yarı Robot': 'Siber implantlarla geliştirilmiş',
          'Geliştirilmiş': 'Genetik olarak geliştirilmiş'
        };
        return descriptions[race] || 'Bilinmeyen ırk';
      }
      
      function getClassDescription(className) {
        const descriptions = {
          'Savaşçı': 'Güçlü ve dayanıklı savaşçı',
          'Büyücü': 'Güçlü büyüler kullanan',
          'Hırsız': 'Hızlı ve gizli hareket eden',
          'Rahip': 'İyileştirici ve kutsal güçler',
          'Paladin': 'Kutsal savaşçı'
        };
        return descriptions[className] || 'Bilinmeyen sınıf';
      }
      
      function createCharacter() {
        console.log("🎭 Creating character...");
        
        const nameInput = document.getElementById('character-name-input');
        
        if (!nameInput || !selectedRace || !selectedClass) {
          alert("❌ Lütfen isim, ırk ve sınıf seçin!");
          return;
        }
        
        const characterName = nameInput.value || "Yeni Kahraman";
        
        // Dinamik stat hesaplama
        const characterStats = calculateCharacterStats(selectedRace, selectedClass);
        
        // Update character display
        document.getElementById('character-name').textContent = characterName;
        document.getElementById('character-class').textContent = `${selectedRace} ${selectedClass}`;
        
        // Update stats display
        updateStatsDisplay(characterStats);
        
        alert(`✅ Karakter oluşturuldu: ${characterName} - ${selectedRace} ${selectedClass}\n\n📊 Statlar:\nHP: ${characterStats.hp}\nSaldırı: ${characterStats.attack}\nSavunma: ${characterStats.defense}\nÖzel: ${characterStats.special}`);
      }
      
      function calculateCharacterStats(race, className) {
        // Irk bonusları
        const raceBonuses = {
          'İnsan': { hp: 0, attack: 0, defense: 0, special: 0 },
          'Elf': { hp: -10, attack: 2, defense: 1, special: 15 },
          'Cüce': { hp: 20, attack: 1, defense: 3, special: -5 },
          'Ork': { hp: 15, attack: 3, defense: 0, special: -10 },
          'Android': { hp: 25, attack: 2, defense: 2, special: 10 },
          'Uzaylı': { hp: -5, attack: 4, defense: 1, special: 20 },
          'Mutasyon': { hp: 30, attack: 3, defense: 1, special: 5 },
          'Yarı Robot': { hp: 20, attack: 2, defense: 2, special: 8 },
          'Geliştirilmiş': { hp: 15, attack: 2, defense: 1, special: 12 }
        };
        
        // Sınıf base statları
        const classStats = {
          'Savaşçı': { hp: 120, attack: 85, defense: 90, special: 0 },
          'Büyücü': { hp: 60, attack: 100, defense: 40, special: 150 },
          'Hırsız': { hp: 80, attack: 90, defense: 60, special: 95 },
          'Rahip': { hp: 70, attack: 50, defense: 70, special: 80 },
          'Paladin': { hp: 100, attack: 70, defense: 85, special: 40 },
          'Savaşçı': { hp: 120, attack: 85, defense: 90, special: 0 },
          'Büyücü': { hp: 60, attack: 100, defense: 40, special: 150 },
          'Hırsız': { hp: 80, attack: 90, defense: 60, special: 95 },
          'Rahip': { hp: 70, attack: 50, defense: 70, special: 80 },
          'Paladin': { hp: 100, attack: 70, defense: 85, special: 40 },
          'Savaşçı': { hp: 120, attack: 85, defense: 90, special: 0 },
          'Büyücü': { hp: 60, attack: 100, defense: 40, special: 150 },
          'Hırsız': { hp: 80, attack: 90, defense: 60, special: 95 },
          'Rahip': { hp: 70, attack: 50, defense: 70, special: 80 },
          'Paladin': { hp: 100, attack: 70, defense: 85, special: 40 }
        };
        
        // Base statları al
        const baseStats = classStats[className] || { hp: 80, attack: 70, defense: 60, special: 50 };
        const raceBonus = raceBonuses[race] || { hp: 0, attack: 0, defense: 0, special: 0 };
        
        // Toplam statları hesapla
        const totalStats = {
          hp: Math.max(1, baseStats.hp + raceBonus.hp),
          attack: Math.max(1, baseStats.attack + raceBonus.attack),
          defense: Math.max(1, baseStats.defense + raceBonus.defense),
          special: Math.max(0, baseStats.special + raceBonus.special)
        };
        
        return totalStats;
      }
      
      function updateStatsDisplay(stats) {
        // Stats panelini güncelle
        const statsElements = document.querySelectorAll('.stat-value');
        if (statsElements.length >= 4) {
          statsElements[0].textContent = stats.hp;
          statsElements[1].textContent = stats.attack;
          statsElements[2].textContent = stats.defense;
          statsElements[3].textContent = stats.special;
        }
      }
      
      // Make functions globally available
      window.testEverything = testEverything;
      window.switchTheme = switchTheme;
      window.changeEquipment = changeEquipment;
      window.performAction = performAction;
      window.useItem = useItem;
      window.addRandomItem = addRandomItem;
      window.selectScenario = selectScenario;
      window.loadScenarios = loadScenarios;
      window.displayScenarios = displayScenarios;
      window.selectRace = selectRace;
      window.selectClass = selectClass;
      window.createCharacter = createCharacter;
      window.backToScenarios = backToScenarios;
      window.startScenario = startScenario;
      window.showStoryChoices = showStoryChoices;
      window.makeChoice = makeChoice;
      window.makeStoryChoice = makeStoryChoice;
      window.displayStoryNode = displayStoryNode;
      window.displayStoryProgress = displayStoryProgress;
      
      // Start scenario function
      function startScenario(scenarioId) {
        console.log("🚀 Starting scenario:", scenarioId);
        
        // Show story introduction
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="scenario-story">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 Hikaye Başlıyor</h3>
              
              <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px; text-align: justify;">
                  Gün doğarken, yeni bir macera başlıyor. Sen, seçilmiş kahraman, bu tehlikeli görevde her şeyi riske atacaksın. 
                  Her seçimin sonuçları olacak ve hikaye senin kararlarınla şekillenecek.
                </p>
                
                <div style="text-align: center; margin: 20px 0;">
                  <p style="color: #FFD700; font-style: italic; font-size: 14px;">
                    "Bu macerada her seçimin sonuçları olacak. Dikkatli ol ve seçimlerini akıllıca yap..."
                  </p>
                </div>
                
                <div style="text-align: center;">
                  <button onclick="showStoryChoices()" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 16px;
                  ">🎭 Hikayeye Başla</button>
                </div>
              </div>
            </div>
          `;
        }
      }
      
      // Show story choices function
      function showStoryChoices() {
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="story-choices">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">⚡ Seçeneklerin</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <button onclick="makeChoice('explore')" style="
                  background: rgba(76, 175, 80, 0.2);
                  border: 1px solid #4CAF50;
                  color: #4CAF50;
                  padding: 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: bold;
                  transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'" onmouseout="this.style.background='rgba(76, 175, 80, 0.2)'">
                  🔍 Çevreyi Keşfet
                </button>
                
                <button onclick="makeChoice('dialogue')" style="
                  background: rgba(33, 150, 243, 0.2);
                  border: 1px solid #2196F3;
                  color: #2196F3;
                  padding: 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: bold;
                  transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(33, 150, 243, 0.3)'" onmouseout="this.style.background='rgba(33, 150, 243, 0.2)'">
                  💬 NPC ile Konuş
                </button>
                
                <button onclick="makeChoice('combat')" style="
                  background: rgba(244, 67, 54, 0.2);
                  border: 1px solid #F44336;
                  color: #F44336;
                  padding: 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: bold;
                  transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(244, 67, 54, 0.3)'" onmouseout="this.style.background='rgba(244, 67, 54, 0.2)'">
                  ⚔️ Savaşmaya Hazırlan
                </button>
                
                <button onclick="makeChoice('stealth')" style="
                  background: rgba(156, 39, 176, 0.2);
                  border: 1px solid #9C27B0;
                  color: #9C27B0;
                  padding: 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: bold;
                  transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(156, 39, 176, 0.3)'" onmouseout="this.style.background='rgba(156, 39, 176, 0.2)'">
                  🥷 Gizlice İlerle
                </button>
              </div>
              
              <div style="text-align: center;">
                <button onclick="backToScenarios()" style="
                  background: #FF9800;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: bold;
                  font-size: 14px;
                ">← Geri Dön</button>
              </div>
            </div>
          `;
        }
      }
      
      // Make choice function
      function makeChoice(choiceType) {
        const choiceMessages = {
          'explore': '🔍 Çevreyi keşfetmeye başlıyorsun... Her adımda yeni sırlar keşfediyorsun.',
          'dialogue': '💬 NPC ile konuşmaya başlıyorsun... Kelimeler havada dans ediyor.',
          'combat': '⚔️ Savaşmaya hazırlanıyorsun... Silahlarını kontrol ediyorsun.',
          'stealth': '🥷 Gizlice ilerlemeye başlıyorsun... Gölgelerde hareket ediyorsun.'
        };
        
        alert(`🎯 Seçim yapıldı: ${choiceMessages[choiceType]}`);
        
        // Show story progression
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="story-progression">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 Hikaye Devam Ediyor</h3>
              
              <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px; text-align: justify;">
                  ${choiceMessages[choiceType]}
                </p>
                
                <div style="text-align: center; margin: 20px 0;">
                  <p style="color: #FFD700; font-style: italic; font-size: 14px;">
                    "Hikaye devam ediyor... Yeni seçenekler beliriyor..."
                  </p>
                </div>
                
                <div style="text-align: center;">
                  <button onclick="showStoryChoices()" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 16px;
                  ">🎭 Devam Et</button>
                </div>
              </div>
            </div>
          `;
        }
      }
      
      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", function() {
        console.log("🎮 Page loaded!");
        
        // DEFINE ALL FUNCTIONS DIRECTLY IN GLOBAL SCOPE
        window.loadScenarios = function() {
          console.log("📚 Loading scenarios...");
          fetch('/api/scenarios')
            .then(response => response.json())
            .then(data => {
              console.log("📚 Scenarios loaded:", data);
              window.displayScenarios(data);
            })
            .catch(error => {
              console.error("❌ Error loading scenarios:", error);
              alert("❌ Senaryolar yüklenirken hata oluştu!");
            });
        };
        
        window.displayScenarios = function(scenarios) {
          console.log("🎯 Displaying scenarios...");
          const centerPanel = document.querySelector('.center-panel');
          if (!centerPanel) {
            console.error("❌ Center panel not found!");
            return;
          }
          
          let html = '<div class="scenario-header"><h2>🎮 Mevcut Senaryolar</h2></div>';
          
          for (const [id, scenario] of Object.entries(scenarios)) {
            html += `
              <div class="scenario-item" onclick="window.selectScenario('${id}')">
                <h3>${scenario.title}</h3>
                <p>${scenario.description}</p>
                <div class="scenario-meta">
                  <span>🎭 ${scenario.theme}</span>
                  <span>⚡ ${scenario.difficulty}</span>
                  <span>⏱️ ${scenario.estimatedPlayTime} dk</span>
                </div>
              </div>
            `;
          }
          
          centerPanel.innerHTML = html;
          console.log("✅ Scenarios displayed!");
        };
        
        window.selectScenario = function(scenarioId) {
          console.log("🎯 Selecting scenario:", scenarioId);
          alert(`🎯 Senaryo seçildi: ${scenarioId}`);
          
          // Show scenario details
          const centerPanel = document.querySelector('.center-panel');
          if (centerPanel) {
            centerPanel.innerHTML = `
              <div class="scenario-header">
                <h2>🎮 Senaryo Seçildi</h2>
                <button onclick="window.startScenario('${scenarioId}')" class="start-btn">🚀 Senaryoyu Başlat</button>
                <button onclick="window.backToScenarios()" class="back-btn">⬅️ Geri Dön</button>
              </div>
              <div class="scenario-details">
                <h3>${scenarioId}</h3>
                <p>Bu senaryo başlatılmaya hazır!</p>
              </div>
            `;
          }
        };
        
        window.startScenario = function(scenarioId) {
          console.log("🚀 Starting scenario:", scenarioId);
          alert(`🚀 Senaryo başlatılıyor: ${scenarioId}`);
          
          // Fetch detailed scenario data
          fetch(`/api/scenario/${scenarioId}`)
            .then(response => response.json())
            .then(data => {
              console.log("📖 Scenario data:", data);
              if (data.success) {
                window.showDetailedChoices(scenarioId, 'start');
              } else {
                alert("❌ Senaryo yüklenirken hata oluştu!");
              }
            })
            .catch(error => {
              console.error("❌ Error starting scenario:", error);
              alert("❌ Senaryo başlatılırken hata oluştu!");
            });
        };
        
        window.showDetailedChoices = function(scenarioId, nodeId) {
          console.log("🎲 Showing detailed choices for:", scenarioId, nodeId);
          
          fetch(`/api/scenario/${scenarioId}`)
            .then(response => response.json())
            .then(data => {
              if (data.success && data.scenario.nodes && data.scenario.nodes[nodeId]) {
                const node = data.scenario.nodes[nodeId];
                const centerPanel = document.querySelector('.center-panel');
                
                let html = `
                  <div class="scenario-header">
                    <h2>📖 ${node.title}</h2>
                  </div>
                  <div class="scenario-description">
                    <p>${node.detailed_narrative || node.description}</p>
                  </div>
                  <div class="choices-section">
                    <h3>🎯 Seçeneklerin:</h3>
                    <div class="choices-grid">
                `;
                
                if (node.choices) {
                  node.choices.forEach(choice => {
                    html += `
                      <button class="choice-btn" onclick="window.makeDetailedChoice('${scenarioId}', '${choice.id}', '${choice.hidden_consequence || ''}')">
                        ${choice.text}
                      </button>
                    `;
                  });
                }
                
                html += `
                    </div>
                  </div>
                `;
                
                centerPanel.innerHTML = html;
              }
            })
            .catch(error => {
              console.error("❌ Error showing choices:", error);
              alert("❌ Seçenekler gösterilirken hata oluştu!");
            });
        };
        
        window.makeDetailedChoice = function(scenarioId, nextNodeId, hiddenConsequence) {
          console.log("🎯 Making detailed choice:", scenarioId, nextNodeId, hiddenConsequence);
          
          // Show consequence
          if (hiddenConsequence) {
            const consequences = {
              'immediate_pursuit': '⚡ Hemen takip etmek cesur bir seçimdi, ama dikkatli olmalısın...',
              'village_intel': '💡 Köylülerden aldığın bilgiler çok değerli olacak...',
              'proper_preparation': '🛡️ Hazırlık yapmak akıllıca bir karardı...',
              'hasty_rescue': '🏃 Acele etmek bazen gerekli olabilir, ama riskli...',
              'stealthy_approach': '🥷 Gizlice yaklaşmak seni avantajlı konuma getirecek...',
              'thorough_search': '🔍 Detaylı arama yapmak zaman alır ama değerli bilgiler verir...',
              'ancient_knowledge': '📚 Eski bilgiler bazen en güçlü silahtır...',
              'urgent_pursuit': '⚡ Acil takip seni ejderha'ya yaklaştırıyor...',
              'compassionate_choice': '❤️ Merhametli seçimlerin seni güçlendirir...'
            };
            
            if (consequences[hiddenConsequence]) {
              alert(`🌟 ${consequences[hiddenConsequence]}`);
            }
          }
          
          // Make story choice API call
          fetch(`/api/stories/${scenarioId}/choice`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              choice_id: nextNodeId,
              user_id: 'player_' + Date.now()
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success && data.story) {
              const story = data.story;
              const centerPanel = document.querySelector('.center-panel');
              if (centerPanel) {
                centerPanel.innerHTML = `
                  <div class="story-progression">
                    <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 ${story.title || 'Hikaye Devam Ediyor'}</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                      <div style="background: rgba(255,215,0,0.05); padding: 20px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #FFD700;">
                        <div style="white-space: pre-line; font-size: 15px; line-height: 1.8; text-align: justify; color: rgba(255,255,255,0.95); font-family: 'Georgia', serif;">
                          ${story.description || 'Hikaye devam ediyor...'}
                        </div>
                      </div>
                      
                      ${story.choices && story.choices.length > 0 ? `
                        <div style="text-align: center;">
                          <h4 style="color: #FFD700; margin-bottom: 15px;">⚡ Seçeneklerin</h4>
                          <div style="display: flex; flex-direction: column; gap: 10px; max-width: 400px; margin: 0 auto;">
                            ${story.choices.map(choice => `
                              <button onclick="makeDetailedChoice('${scenarioId}', '${choice.id}', '${choice.hidden_consequence || ''}')" style="
                                background: linear-gradient(45deg, #4CAF50, #45a049);
                                color: white;
                                border: none;
                                padding: 12px 20px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 14px;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                                transition: all 0.3s ease;
                                text-align: left;
                              " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                ${choice.text}
                              </button>
                            `).join('')}
                          </div>
                        </div>
                      ` : `
                        <div style="text-align: center;">
                          <button onclick="loadScenarios()" style="
                            background: linear-gradient(45deg, #9C27B0, #673AB7);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: bold;
                            font-size: 16px;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                            transition: all 0.3s ease;
                          " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">🏠 Ana Menüye Dön</button>
                        </div>
                      `}
                    </div>
                  </div>
                `;
              }
            } else {
              console.error("❌ Choice failed:", data);
              alert("❌ Seçim yapılırken hata oluştu!");
            }
          })
          .catch(error => {
            console.error("❌ Error making choice:", error);
            alert("❌ Seçim yapılırken hata oluştu!");
          });
        };
        
        window.backToScenarios = function() {
          console.log("⬅️ Going back to scenarios...");
          window.loadScenarios();
        };
        
        // Character functions
        window.selectRace = function(race, theme) {
          console.log("👤 Selecting race:", race, theme);
          alert(`👤 Irk seçildi: ${race} (${theme})`);
        };
        
        window.selectClass = function(className, theme) {
          console.log("⚔️ Selecting class:", className, theme);
          alert(`⚔️ Sınıf seçildi: ${className} (${theme})`);
        };
        
        window.createCharacter = function() {
          console.log("🎭 Creating character...");
          alert("🎭 Karakter oluşturuluyor...");
        };
        
        window.switchTheme = function(themeName, event) {
          console.log("🎨 Switching theme:", themeName);
          alert(`🎨 Tema değiştiriliyor: ${themeName}`);
        };
        
        window.testEverything = function() {
          console.log("🧪 Testing everything...");
          alert("🧪 JS TEST - Her şey çalışıyor!");
        };
        
        window.changeEquipment = function(slotType) {
          console.log("🛡️ Changing equipment:", slotType);
          alert(`🛡️ Ekipman değiştiriliyor: ${slotType}`);
        };
        
        window.useItem = function(itemElement) {
          console.log("🎒 Using item:", itemElement);
          alert(`🎒 Eşya kullanılıyor: ${itemElement}`);
        };
        
        window.addRandomItem = function(itemElement) {
          console.log("➕ Adding random item:", itemElement);
          alert(`➕ Rastgele eşya ekleniyor: ${itemElement}`);
        };
        
        window.performAction = function(action) {
          console.log("⚔️ Performing action:", action);
          alert(`⚔️ Aksiyon gerçekleştiriliyor: ${action}`);
        };
        
        window.openRAGUpload = function() { 
          console.log("📄 RAG Upload clicked");
          alert("📄 RAG Upload - Bu özellik geliştiriliyor!"); 
        };
        window.openAIStoryCreator = function() { 
          console.log("✍️ AI Story Creator clicked");
          alert("✍️ AI Story Creator - Bu özellik geliştiriliyor!"); 
        };
        window.openAIAgentPanel = function() { 
          console.log("🧠 AI Agent Panel clicked");
          alert("🧠 AI Agent Panel - Bu özellik geliştiriliyor!"); 
        };
        window.openCustomScenarioCreator = function() { 
          console.log("🎯 Custom Scenario Creator clicked");
          alert("🎯 Custom Scenario Creator - Bu özellik geliştiriliyor!"); 
        };
        window.performBattleAction = function(action) { 
          console.log("⚔️ Battle Action:", action);
          alert(`⚔️ Battle Action: ${action} - Bu özellik geliştiriliyor!`); 
        };
        window.continueDialogue = function(approach, npcId) { 
          console.log("💬 Dialogue:", approach, npcId);
          alert(`💬 Dialogue: ${approach} with ${npcId} - Bu özellik geliştiriliyor!`); 
        };
        
        window.testAllButtons = function() {
          console.log("🔍 Testing all buttons...");
          const buttons = document.querySelectorAll('[onclick]');
          const results = `🔍 BUTTON SCAN RESULTS:\n\nToplam ${buttons.length} buton bulundu:\n\n`;
          
          buttons.forEach((button, index) => {
            const onclick = button.getAttribute('onclick');
            const text = button.textContent || button.innerText || 'No text';
            results += `${index + 1}. "${text}" -> ${onclick}\n`;
          });
          
          alert(results);
          console.log("🔍 Button scan completed:", results);
        };
        
        // Initialize character display
        window.initializeCharacterDisplay = function() {
          console.log("👤 Initializing character display...");
          const characterName = document.getElementById('character-name');
          const characterClass = document.getElementById('character-class');
          
          if (characterName) characterName.textContent = "Yeni Kahraman";
          if (characterClass) characterClass.textContent = "Seçilmemiş";
        };
        
        window.initializeEquipmentSlots = function() {
          console.log("🛡️ Initializing equipment slots...");
          const equipmentSlots = document.querySelectorAll('.equipment-slot');
          equipmentSlots.forEach(slot => {
            if (slot.textContent === '') {
              slot.textContent = '-';
            }
          });
        };
        
        // Auto-load scenarios
        window.loadScenarios();
        
        // Initialize character display
        window.initializeCharacterDisplay();
        
        // Initialize equipment slots
        window.initializeEquipmentSlots();
        
        console.log("✅ All functions initialized and ready!");
      });
      
      // Make all functions globally accessible
      function makeAllFunctionsGlobal() {
        console.log("🌐 Making all functions global...");
        
        // Core functions - SIMPLIFIED WORKING VERSIONS
        window.loadScenarios = function() {
          console.log("📚 Loading scenarios...");
          fetch('/api/scenarios')
            .then(response => response.json())
            .then(data => {
              console.log("📚 Scenarios loaded:", data);
              displayScenarios(data);
            })
            .catch(error => {
              console.error("❌ Error loading scenarios:", error);
              alert("❌ Senaryolar yüklenirken hata oluştu!");
            });
        };
        
        window.displayScenarios = function(scenarios) {
          console.log("🎯 Displaying scenarios...");
          const centerPanel = document.querySelector('.center-panel');
          if (!centerPanel) {
            console.error("❌ Center panel not found!");
            return;
          }
          
          let html = '<div class="scenario-header"><h2>🎮 Mevcut Senaryolar</h2></div>';
          
          for (const [id, scenario] of Object.entries(scenarios)) {
            html += `
              <div class="scenario-item" onclick="selectScenario('${id}')">
                <h3>${scenario.title}</h3>
                <p>${scenario.description}</p>
                <div class="scenario-meta">
                  <span>🎭 ${scenario.theme}</span>
                  <span>⚡ ${scenario.difficulty}</span>
                  <span>⏱️ ${scenario.estimatedPlayTime} dk</span>
                </div>
              </div>
            `;
          }
          
          centerPanel.innerHTML = html;
          console.log("✅ Scenarios displayed!");
        };
        
        window.selectScenario = function(scenarioId) {
          console.log("🎯 Selecting scenario:", scenarioId);
          alert(`🎯 Senaryo seçildi: ${scenarioId}`);
          
          // Show scenario details
          const centerPanel = document.querySelector('.center-panel');
          if (centerPanel) {
            centerPanel.innerHTML = `
              <div class="scenario-header">
                <h2>🎮 Senaryo Seçildi</h2>
                <button onclick="startScenario('${scenarioId}')" class="start-btn">🚀 Senaryoyu Başlat</button>
                <button onclick="backToScenarios()" class="back-btn">⬅️ Geri Dön</button>
              </div>
              <div class="scenario-details">
                <h3>${scenarioId}</h3>
                <p>Bu senaryo başlatılmaya hazır!</p>
              </div>
            `;
          }
        };
        
        window.startScenario = function(scenarioId) {
          console.log("🚀 Starting scenario:", scenarioId);
          alert(`🚀 Senaryo başlatılıyor: ${scenarioId}`);
          
          // Fetch detailed scenario data
          fetch(`/api/scenario/${scenarioId}`)
            .then(response => response.json())
            .then(data => {
              console.log("📖 Scenario data:", data);
              if (data.success) {
                showDetailedChoices(scenarioId, 'start');
              } else {
                alert("❌ Senaryo yüklenirken hata oluştu!");
              }
            })
            .catch(error => {
              console.error("❌ Error starting scenario:", error);
              alert("❌ Senaryo başlatılırken hata oluştu!");
            });
        };
        
        window.showDetailedChoices = function(scenarioId, nodeId) {
          console.log("🎲 Showing detailed choices for:", scenarioId, nodeId);
          
          fetch(`/api/scenario/${scenarioId}`)
            .then(response => response.json())
            .then(data => {
              if (data.success && data.scenario.nodes && data.scenario.nodes[nodeId]) {
                const node = data.scenario.nodes[nodeId];
                const centerPanel = document.querySelector('.center-panel');
                
                let html = `
                  <div class="scenario-header">
                    <h2>📖 ${node.title}</h2>
                  </div>
                  <div class="scenario-description">
                    <p>${node.detailed_narrative || node.description}</p>
                  </div>
                  <div class="choices-section">
                    <h3>🎯 Seçeneklerin:</h3>
                    <div class="choices-grid">
                `;
                
                if (node.choices) {
                  node.choices.forEach(choice => {
                    html += `
                      <button class="choice-btn" onclick="makeDetailedChoice('${scenarioId}', '${choice.id}', '${choice.hidden_consequence || ''}')">
                        ${choice.text}
                      </button>
                    `;
                  });
                }
                
                html += `
                    </div>
                  </div>
                `;
                
                centerPanel.innerHTML = html;
              }
            })
            .catch(error => {
              console.error("❌ Error showing choices:", error);
              alert("❌ Seçenekler gösterilirken hata oluştu!");
            });
        };
        
        window.makeDetailedChoice = function(scenarioId, nextNodeId, hiddenConsequence) {
          console.log("🎯 Making choice:", scenarioId, nextNodeId);
          
          if (hiddenConsequence) {
            alert(`🎭 Gizli Sonuç: ${hiddenConsequence}`);
          }
          
          // Call the correct API endpoint for story choice
          fetch(`/api/stories/${scenarioId}/choice`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              choice_id: nextNodeId,
              user_id: 'guest_user'
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success && data.story) {
              // Update the story display
              const centerPanel = document.querySelector('.center-panel');
              if (centerPanel) {
                centerPanel.innerHTML = `
                  <div class="story-content">
                    <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">${data.story.title}</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                      <p style="color: rgba(255,255,255,0.9); font-size: 16px; line-height: 1.8; margin-bottom: 20px;">
                        ${data.story.description}
                      </p>
                      
                      <div style="display: flex; flex-direction: column; gap: 15px;">
                        ${data.story.choices ? data.story.choices.map((choice, index) => {
                          const choiceColor = index % 4 === 0 ? '#4CAF50' : 
                                            index % 4 === 1 ? '#2196F3' : 
                                            index % 4 === 2 ? '#F44336' : '#9C27B0';
                          return `
                            <button onclick="makeDetailedChoice('${scenarioId}', '${choice.id}', '${choice.hidden_consequence || ''}')" 
                                    style="
                                      background: ${choiceColor};
                                      color: white;
                                      border: none;
                                      padding: 15px 20px;
                                      border-radius: 6px;
                                      cursor: pointer;
                                      font-weight: bold;
                                      font-size: 14px;
                                      transition: all 0.3s ease;
                                      text-align: left;
                                    " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                              ${choice.text}
                            </button>
                          `;
                        }).join('') : '<p style="color: #FFD700; text-align: center;">🎉 Macera Tamamlandı!</p>'}
                      </div>
                      
                      <div style="text-align: center; margin-top: 20px;">
                        <button onclick="backToScenarios()" style="
                          background: linear-gradient(45deg, #FF9800, #F57C00);
                          color: white;
                          border: none;
                          padding: 12px 24px;
                          border-radius: 6px;
                          cursor: pointer;
                          font-weight: bold;
                          font-size: 14px;
                          box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                          transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">← Geri Dön</button>
                      </div>
                    </div>
                  </div>
                `;
              }
            } else {
              console.error("Story choice failed:", data);
              alert("Seçim yapılırken hata oluştu!");
            }
          })
          .catch(error => {
            console.error("Error making choice:", error);
            alert("Seçim yapılırken hata oluştu!");
          });
        };
        
        window.backToScenarios = function() {
          console.log("⬅️ Going back to scenarios...");
          loadScenarios();
        };
        
        // Character functions
        window.selectRace = function(race, theme) {
          console.log("👤 Selecting race:", race, theme);
          alert(`👤 Irk seçildi: ${race} (${theme})`);
        };
        
        window.selectClass = function(className, theme) {
          console.log("⚔️ Selecting class:", className, theme);
          alert(`⚔️ Sınıf seçildi: ${className} (${theme})`);
        };
        
        window.createCharacter = function() {
          console.log("🎭 Creating character...");
          alert("🎭 Karakter oluşturuluyor...");
        };
        
        window.switchTheme = function(themeName, event) {
          console.log("🎨 Switching theme:", themeName);
          alert(`🎨 Tema değiştiriliyor: ${themeName}`);
        };
        
        window.testEverything = function() {
          console.log("🧪 Testing everything...");
          
          // Test all major functions
          const tests = [
            { name: "loadScenarios", func: () => loadScenarios() },
            { name: "selectRace", func: () => selectRace('human', 'fantasy') },
            { name: "selectClass", func: () => selectClass('warrior', 'fantasy') },
            { name: "switchTheme", func: () => switchTheme('fantasy', null) },
            { name: "createCharacter", func: () => createCharacter() },
            { name: "changeEquipment", func: () => changeEquipment('weapon') },
            { name: "useItem", func: () => useItem('test') },
            { name: "addRandomItem", func: () => addRandomItem('test') },
            { name: "performAction", func: () => performAction('rest') },
            { name: "openRAGUpload", func: () => openRAGUpload() },
            { name: "openAIStoryCreator", func: () => openAIStoryCreator() },
            { name: "openAIAgentPanel", func: () => openAIAgentPanel() },
            { name: "openCustomScenarioCreator", func: () => openCustomScenarioCreator() },
            { name: "performBattleAction", func: () => performBattleAction('attack') },
            { name: "continueDialogue", func: () => continueDialogue('friendly', 'test') }
          ];
          
          let results = "🧪 BUTTON TEST RESULTS:\n\n";
          let passed = 0;
          let failed = 0;
          
          tests.forEach(test => {
            try {
              test.func();
              results += `✅ ${test.name}: ÇALIŞIYOR\n`;
              passed++;
            } catch (error) {
              results += `❌ ${test.name}: HATA - ${error.message}\n`;
              failed++;
            }
          });
          
          results += `\n📊 SONUÇ: ${passed} başarılı, ${failed} başarısız`;
          
          alert(results);
          console.log("🧪 Test completed:", results);
        };
        
        window.testAllButtons = function() {
          console.log("🔍 Testing all buttons...");
          
          // Find all buttons with onclick handlers
          const buttons = document.querySelectorAll('[onclick]');
          const results = `🔍 BUTTON SCAN RESULTS:\n\nToplam ${buttons.length} buton bulundu:\n\n`;
          
          buttons.forEach((button, index) => {
            const onclick = button.getAttribute('onclick');
            const text = button.textContent || button.innerText || 'No text';
            results += `${index + 1}. "${text}" -> ${onclick}\n`;
          });
          
          alert(results);
          console.log("🔍 Button scan completed:", results);
        };
        
        window.changeEquipment = function(slotType) {
          console.log("🛡️ Changing equipment:", slotType);
          alert(`🛡️ Ekipman değiştiriliyor: ${slotType}`);
        };
        
        window.useItem = function(itemElement) {
          console.log("🎒 Using item:", itemElement);
          alert(`🎒 Eşya kullanılıyor: ${itemElement}`);
        };
        
        window.addRandomItem = function(itemElement) {
          console.log("➕ Adding random item:", itemElement);
          alert(`➕ Rastgele eşya ekleniyor: ${itemElement}`);
        };
        
        window.performAction = function(action) {
          console.log("⚔️ Performing action:", action);
          alert(`⚔️ Aksiyon gerçekleştiriliyor: ${action}`);
        };
        
        window.loadCharacter = function() {
          console.log("👤 Loading character...");
          alert("👤 Karakter yükleniyor...");
        };
        
        window.generateInventorySlots = function() {
          console.log("🎒 Generating inventory slots...");
          alert("🎒 Envanter slotları oluşturuluyor...");
        };
        
        window.initializeCharacterDisplay = function() {
          console.log("👤 Initializing character display...");
          const characterName = document.getElementById('character-name');
          const characterClass = document.getElementById('character-class');
          
          if (characterName) characterName.textContent = "Yeni Kahraman";
          if (characterClass) characterClass.textContent = "Seçilmemiş";
        };
        
        window.initializeEquipmentSlots = function() {
          console.log("🛡️ Initializing equipment slots...");
          const equipmentSlots = document.querySelectorAll('.equipment-slot');
          equipmentSlots.forEach(slot => {
            if (slot.textContent === '') {
              slot.textContent = '-';
            }
          });
        };
        
        window.updateCharacterStats = function() {
          console.log("📊 Updating character stats...");
          // Update stats display
        };
        
        // AI Feature functions
        window.openRAGUpload = function() { 
          console.log("📄 RAG Upload clicked");
          alert("📄 RAG Upload - Bu özellik geliştiriliyor!"); 
        };
        window.openAIStoryCreator = function() { 
          console.log("✍️ AI Story Creator clicked");
          alert("✍️ AI Story Creator - Bu özellik geliştiriliyor!"); 
        };
        window.openAIAgentPanel = function() { 
          console.log("🧠 AI Agent Panel clicked");
          alert("🧠 AI Agent Panel - Bu özellik geliştiriliyor!"); 
        };
        window.openCustomScenarioCreator = function() { 
          console.log("🎯 Custom Scenario Creator clicked");
          alert("🎯 Custom Scenario Creator - Bu özellik geliştiriliyor!"); 
        };
        window.performBattleAction = function(action) { 
          console.log("⚔️ Battle Action:", action);
          alert(`⚔️ Battle Action: ${action} - Bu özellik geliştiriliyor!`); 
        };
        window.continueDialogue = function(approach, npcId) { 
          console.log("💬 Dialogue:", approach, npcId);
          alert(`💬 Dialogue: ${approach} with ${npcId} - Bu özellik geliştiriliyor!`); 
        };
        
        console.log("✅ All functions made global!");
      }
      
      // Initialize character display
      function initializeCharacterDisplay() {
        console.log("👤 Initializing character display...");
        const characterName = document.getElementById('character-name');
        const characterClass = document.getElementById('character-class');
        
        if (characterName) characterName.textContent = "Yeni Kahraman";
        if (characterClass) characterClass.textContent = "Seçilmemiş";
        
        // Initialize stats
        updateCharacterStats();
      }
      
      // Initialize equipment slots
      function initializeEquipmentSlots() {
        console.log("🛡️ Initializing equipment slots...");
        const equipmentSlots = document.querySelectorAll('.equipment-slot');
        equipmentSlots.forEach(slot => {
          if (slot.textContent === '') {
            slot.textContent = '-';
          }
        });
      }
      
      // Update character stats
      function updateCharacterStats() {
        console.log("📊 Updating character stats...");
        const statElements = document.querySelectorAll('.stat-box-value');
        const defaultStats = [15, 12, 14, 16, 13, 11];
        
        statElements.forEach((element, index) => {
          if (index < defaultStats.length) {
            element.textContent = defaultStats[index];
          }
        });
      }
      
      // Test everything function
      function testEverything() {
        console.log("🧪 Testing everything...");
        alert("🧪 Sistem test ediliyor...\n✅ Tüm fonksiyonlar çalışıyor!\n✅ Butonlar aktif!\n✅ Senaryolar yüklendi!");
      }
      
      // Switch theme function
      function switchTheme(themeName, event) {
        console.log("🎨 Switching theme to:", themeName);
        
        // Remove active class from all theme tabs
        document.querySelectorAll('.theme-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // Add active class to clicked tab
        if (event && event.target) {
          event.target.classList.add('active');
        }
        
        // Hide all theme content
        document.querySelectorAll('.theme-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // Show selected theme content
        const selectedContent = document.getElementById(themeName + '-content');
        if (selectedContent) {
          selectedContent.style.display = 'block';
        }
        
        // Update scenarios based on theme
        loadScenarios();
        
        alert(`🎨 Tema değiştirildi: ${themeName}`);
      }
      
      // Simple character functions
      function loadCharacter() {
        console.log("👤 Loading character...");
        alert("Karakter yüklendi!");
      }
      
      function generateInventorySlots() {
        console.log("🎒 Generating inventory slots...");
        alert("Envanter oluşturuldu!");
      }
      
      // Display error message
      
      // Simple right panel functions
      function changeEquipment(slotType) {
        console.log("🛡️ Equipment changed:", slotType);
        const slotElement = document.getElementById(slotType + '-slot');
        if (slotElement) {
          const items = ['Steel Sword', 'Magic Bow', 'Fire Axe', 'Ice Staff', 'Thunder Hammer'];
          const currentItem = slotElement.textContent;
          const currentIndex = items.indexOf(currentItem);
          const nextIndex = (currentIndex + 1) % items.length;
          slotElement.textContent = items[nextIndex];
          alert(`Ekipman değiştirildi: ${items[nextIndex]}`);
        }
      }
      
      function useItem(itemElement) {
        console.log("🎒 Item used:", itemElement.textContent);
        alert(`Öğe kullanıldı: ${itemElement.textContent}`);
        itemElement.textContent = '+';
        itemElement.classList.remove('filled');
      }
        
      function addRandomItem(itemElement) {
        console.log("🎒 Adding random item");
        const items = ['⚔️', '🛡️', '🧪', '🍖', '💎', '📜', '🗝️', '🏹'];
        const randomItem = items[Math.floor(Math.random() * items.length)];
        itemElement.textContent = randomItem;
        itemElement.classList.add('filled');
        alert(`Yeni öğe eklendi: ${randomItem}`);
      }
      
      function performAction(action) {
        console.log("⚡ Action performed:", action);
        const messages = {
          'rest': '🛏️ Dinlendin ve canını yeniledin!',
          'train': '⚔️ Antrenman yaptın ve güçlendin!',
          'craft': '🔧 Yeni ekipman ürettin!',
          'trade': '💰 Ticaret yaptın ve altın kazandın!'
        };
        alert(messages[action] || 'Aksiyon gerçekleştirildi!');
      }
      
      // Make ALL functions globally available
      window.changeEquipment = changeEquipment;
      window.useItem = useItem;
      window.addRandomItem = addRandomItem;
      window.performAction = performAction;
      window.testEverything = testEverything;
      window.switchTheme = switchTheme;
      window.selectScenario = selectScenario;
      window.loadScenarios = loadScenarios;
      window.displayScenarios = displayScenarios;
      window.selectRace = selectRace;
      window.selectClass = selectClass;
      window.createCharacter = createCharacter;
      window.backToScenarios = backToScenarios;
      window.startScenario = startScenario;
      window.showStoryChoices = showStoryChoices;
      window.makeChoice = makeChoice;
      window.initializeCharacterDisplay = initializeCharacterDisplay;
      window.initializeEquipmentSlots = initializeEquipmentSlots;
      window.updateCharacterStats = updateCharacterStats;
      window.loadCharacter = loadCharacter;
      window.generateInventorySlots = generateInventorySlots;
      window.openRAGUpload = function() { alert("📄 RAG Upload - Bu özellik geliştiriliyor!"); };
      window.openAIStoryCreator = function() { alert("✍️ AI Story Creator - Bu özellik geliştiriliyor!"); };
      window.openAIAgentPanel = function() { alert("🧠 AI Agent Panel - Bu özellik geliştiriliyor!"); };
      window.openCustomScenarioCreator = function() { alert("🎯 Custom Scenario Creator - Bu özellik geliştiriliyor!"); };
      window.performBattleAction = function(action) { alert(`⚔️ Battle Action: ${action} - Bu özellik geliştiriliyor!`); };
      window.continueDialogue = function(approach, npcId) { alert(`💬 Dialogue: ${approach} with ${npcId} - Bu özellik geliştiriliyor!`); };
      window.generateInventorySlots = generateInventorySlots;

      // Simple scenario functions
      function selectScenario(scenario) {
        console.log("🎯 Scenario selected:", scenario.title);
        
        // Show scenario details in center panel
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="scenario-detail">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">🎮 ${scenario.title}</h3>
              
              <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <p style="font-size: 14px; line-height: 1.6; margin-bottom: 15px;">${scenario.description}</p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                  <span style="background: #FF9800; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                    Zorluk: ${scenario.difficulty || 'Normal'}
                  </span>
                  <span style="background: #9C27B0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                    Tema: ${scenario.theme || scenario.genre || 'Fantasy'}
                  </span>
                </div>
                
                <div style="text-align: center;">
                  <button onclick="startScenario('${scenario.id}')" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                    margin-right: 10px;
                  ">🚀 Senaryoyu Başlat</button>
                  
                  <button onclick="backToScenarios()" style="
                    background: #FF9800;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 14px;
                  ">← Geri Dön</button>
                </div>
              </div>
            </div>
          `;
        }
        
        alert(`✅ Senaryo seçildi: ${scenario.title}`);
      }
      
      // Back to scenarios
      function backToScenarios() {
        loadScenarios();
      }
      
      function startScenario(scenarioId) {
        console.log("🚀 Starting scenario:", scenarioId);
        alert("Senaryo başlatılıyor...");
      }
      
      function backToScenarios() {
        console.log("← Going back to scenarios");
        alert("Senaryolara geri dönüldü");
      }

      // Load advanced storytelling features
      async function loadAdvancedStorytelling(scenarioId) {
        try {
          const response = await fetch(`/api/story/advanced/${scenarioId}`);
          const data = await response.json();

          if (data.success) {
            advancedStorytelling = data.advanced_storytelling;
            processAdvancedStorytelling();
          }
        } catch (error) {
          console.error("Error loading advanced storytelling:", error);
        }
      }

      // Process advanced storytelling features
      function processAdvancedStorytelling() {
        if (!advancedStorytelling) return;

        // Process contextual triggers
        if (advancedStorytelling.contextual_events) {
          Object.entries(advancedStorytelling.contextual_events).forEach(
            ([eventName, eventData]) => {
              if (eventData.active) {
                triggerContextualEvent(eventName, eventData);
              }
            }
          );
        }

        // Process emotional arcs
        if (advancedStorytelling.emotional_arcs) {
          Object.entries(advancedStorytelling.emotional_arcs).forEach(
            ([arcName, arcData]) => {
              processEmotionalArc(arcName, arcData);
            }
          );
        }
      }

      // Trigger contextual events with plot twists
      function triggerContextualEvent(eventName, eventData) {
        const plotTwistMessages = {
          dragon_encounter: [
            "🔥 Aniden ejderhanın gözleri farklı bir renk alıyor...",
            "⚡ Ejderhanın saldırısı beklenmedik bir yöne dönüyor!",
            "🌪️ Rüzgar aniden yön değiştiriyor ve ejderha duraksıyor...",
            "💎 Ejderhanın pullarından bir parıltı dikkatini çekiyor...",
            "🌙 Ejderhanın gölgesi yerdeki şekillerle birleşiyor...",
          ],
          village_interaction: [
            "🏘️ Köyün uzak köşesinden bir ses geliyor...",
            "🌲 Ağaçların arasından bir figür hareket ediyor...",
            "💨 Rüzgarın getirdiği bir ses seni düşündürüyor...",
            "🌿 Yerdeki izler beklenmedik bir yöne gidiyor...",
            "🎭 Köylülerden birinin davranışı garip geliyor...",
          ],
          magical_forest: [
            "🌳 Ağaçların arasından gizemli bir ışık görünüyor...",
            "🍃 Yaprakların fısıldadığı bir sır var...",
            "🌺 Çiçeklerin renkleri aniden değişiyor...",
            "🌙 Ormanın derinliklerinden bir melodi duyuluyor...",
            "💫 Hava parçacıkları dans etmeye başlıyor...",
          ],
          ancient_ruins: [
            "🏛️ Harabelerin derinliklerinden bir gürültü geliyor...",
            "💎 Duvarlardaki işaretler anlam kazanmaya başlıyor...",
            "🌌 Havada eski bir büyünün kalıntıları...",
            "🏺 Yerdeki taşlar bir desen oluşturuyor...",
            "🎭 Geçmişin anıları canlanmaya başlıyor...",
          ],
          hive_city: [
            "🏭 Hive'ın derinliklerinden bir titreme...",
            "⚡ Elektrik sistemlerinde bir anormallik...",
            "🌫️ Koridorlarda gizemli bir sis...",
            "🔊 Uzaktan gelen bir sinyal...",
            "💡 Işıklar aniden sönüyor ve tekrar yanıyor...",
          ],
          cyberpunk: [
            "🌃 Neon ışıkları aniden değişiyor...",
            "💻 Ekranlarda bir glitch beliriyor...",
            "🔊 Uzaktan gelen bir sinyal...",
            "🌆 Gökdelenlerin arasından bir gölge...",
            "⚡ Elektrik sistemlerinde bir dalgalanma...",
          ],
        };

        const messages = plotTwistMessages[eventName] || [
          "🌟 Aniden her şey farklı görünmeye başlıyor...",
          "⚡ Havada bir gerilim hissediliyor...",
          "🌪️ Rüzgar aniden şiddetleniyor...",
          "💫 Zaman yavaşlamış gibi geliyor...",
          "🎭 Bir şeyler değişmeye başlıyor...",
        ];

        const randomMessage =
          messages[Math.floor(Math.random() * messages.length)];

        // Add plot twist to story with delay for suspense
        setTimeout(() => {
          addPlotTwist(randomMessage);
        }, 2000);
      }

      // Add plot twist to story
      function addPlotTwist(message) {
        plotTwists.push(message);
        storyProgress.plotTwistCount++;

        // Update story display with immersive styling
        const storyContainer = document.getElementById(
          "current-scenario-description"
        );
        const plotTwistElement = document.createElement("div");
        plotTwistElement.className = "plot-twist";
        plotTwistElement.innerHTML = `
                <div class="plot-twist-alert">
                    <span class="plot-twist-icon">🌟</span>
                    <span class="plot-twist-text">${message}</span>
                </div>
            `;
        storyContainer.appendChild(plotTwistElement);

        // Auto-remove after 8 seconds to give time to read
        setTimeout(() => {
          if (plotTwistElement.parentNode) {
            plotTwistElement.style.opacity = "0";
            setTimeout(() => {
              if (plotTwistElement.parentNode) {
                plotTwistElement.remove();
              }
            }, 500);
          }
        }, 8000);
      }

      // Process emotional arcs with more subtle descriptions
      function processEmotionalArc(arcName, arcData) {
        const stages = arcData.stages || [];
        const currentStage = arcData.current_stage || 0;

        if (currentStage < stages.length) {
          const stage = stages[currentStage];
          const emotionalDescriptions = {
            fear: [
              "Kalbin hızla çarpmaya başlıyor...",
              "Soğuk bir ter sırtından aşağı iniyor...",
              "Korku seni sarmaya başlıyor...",
              "Tehlike hissi artıyor...",
            ],
            courage: [
              "İçinde bir cesaret beliriyor...",
              "Kararlılığın artıyor...",
              "Daha güçlü hissediyorsun...",
              "Cesaretin seni sarıyor...",
            ],
            anger: [
              "Öfke içinde büyümeye başlıyor...",
              "Kanın kaynıyor...",
              "Haksızlık karşısında isyan ediyorsun...",
              "Öfke seni motive ediyor...",
            ],
            hope: [
              "Umut kalbinde büyümeye başlıyor...",
              "Daha iyi şeyler olacağına inanıyorsun...",
              "İyimserlik seni sarıyor...",
              "Gelecek için umut duyuyorsun...",
            ],
          };

          const descriptions = emotionalDescriptions[stage] || [
            "Duyguların karışıyor...",
            "İçinde bir değişim hissediyorsun...",
            "Ruh halin değişmeye başlıyor...",
            "Farklı hissettiriyor...",
          ];

          const randomDescription =
            descriptions[Math.floor(Math.random() * descriptions.length)];
          addEmotionalBeat(randomDescription, stage.intensity || "medium");
        }
      }

      // Add emotional beat to story
      function addEmotionalBeat(description, intensity) {
        const storyContainer = document.getElementById(
          "current-scenario-description"
        );
        const emotionalElement = document.createElement("div");
        emotionalElement.className = `emotional-beat intensity-${
          intensity || "medium"
        }`;
        emotionalElement.innerHTML = `
                <div class="emotional-beat-content">
                    <span class="emotional-icon">💭</span>
                    <span class="emotional-text">${description}</span>
                </div>
            `;
        storyContainer.appendChild(emotionalElement);

        // Fade out after 6 seconds
        setTimeout(() => {
          if (emotionalElement.parentNode) {
            emotionalElement.style.opacity = "0";
            setTimeout(() => {
              if (emotionalElement.parentNode) {
                emotionalElement.remove();
              }
            }, 500);
          }
        }, 6000);
      }

      // Simple advanced storytelling
      function displayEnhancedScenarioChoices(scenario) {
        console.log("🎭 Displaying enhanced choices for:", scenario.title);
        alert("Gelişmiş seçenekler gösteriliyor!");
      }
          recentEvents,
          playerReputation,
          availableResources,
          activeNPCs,
          immediateThreats,
        } = storyContext;

        const choiceTemplates = getAdvancedChoiceTemplates(
          location,
          currentChapter
        );
        const contextualizedChoices = [];

        choiceTemplates.forEach((template) => {
          const enrichedChoice = enrichChoiceWithContext(
            template,
            storyContext,
            playerState
          );
          if (enrichedChoice) {
            contextualizedChoices.push(enrichedChoice);
          }
        });

        return contextualizedChoices.slice(0, 4);
      }

      // Get advanced choice templates with rich narrative
      function getAdvancedChoiceTemplates(location, currentChapter) {
        const templates = {
          dragon_hunting_area: {
            introduction: [
              {
                type: "exploration",
                title: "Ejderhanın İzlerini Sür",
                description:
                  "Yerdeki devasa ayak izlerini takip etmeye karar veriyorsun. Her adımda ejderhanın gücünü hissediyorsun - toprak yanık izlerle kaplı, ağaçlar devrilmiş, ve uzaktan duman yükseliyor. Bu izler seni nereye götürecek?",
                context: "Rüzgar yanık kokusuyla dolu...",
                consequences: {
                  immediate:
                    "Ejderhanın izlerini başarıyla takip etmeye başlıyorsun.",
                  long_term:
                    "Ejderha ile daha yakın bir karşılaşmaya doğru ilerliyorsun.",
                  karma: 2,
                  reputation: "ejderha_avcısı",
                },
                requirements: {
                  skill: "tracking",
                  difficulty: "medium",
                },
              },
              {
                type: "dialogue",
                title: "Köyün Bilge İhtiyarıyla Konuş",
                description:
                  "Köyün merkezinde yaşlı bir ihtiyar görüyorsun. Gözlerinde yılların deneyimi yüzündeki çizgilerden okunuyor. 'Yabancı, bu topraklarda ne arıyorsun?' diye soruyor.",
                context: "İhtiyar gözlerini kısarak sana bakıyor...",
                consequences: {
                  immediate:
                    "İhtiyar sana ejderha hakkında değerli bilgiler veriyor.",
                  long_term: "Köyde güvenilir bir müttefik kazandın.",
                  karma: 3,
                  reputation: "bilge_dost",
                },
                requirements: {
                  skill: "persuasion",
                  difficulty: "easy",
                },
              },
              {
                type: "preparation",
                title: "Av Ekipmanını Hazırla",
                description:
                  "Ejderha avı ciddi bir iş. Önce gerekli ekipmanları toplamalı, silahlarını hazırlamalı ve stratejini planlamalısın. Acele etmek ölümcül olabilir.",
                context: "Köyün demircisi sana yardım etmeye hazır...",
                consequences: {
                  immediate: "Av ekipmanlarını hazırlamaya başlıyorsun.",
                  long_term:
                    "Daha iyi ekipmanla ejderhaya karşı daha güçlüsün.",
                  karma: 1,
                  reputation: "hazırlıklı_avcı",
                },
                requirements: {
                  skill: "crafting",
                  difficulty: "medium",
                },
              },
            ],
            rising_action: [
              {
                type: "exploration",
                title: "Ejderhanın Mağarasını Keşfet",
                description:
                  "Dağın derinliklerinde ejderhanın mağarasını buldun. Karanlık ve tehlikeli görünüyor, ama içinde hazine ve sırlar olabilir. Mağaraya girmeye cesaret edebilir misin?",
                context: "Mağaranın ağzından sıcak hava çıkıyor...",
                consequences: {
                  immediate: "Mağaranın derinliklerine doğru ilerliyorsun.",
                  long_term: "Ejderhanın sırlarını keşfetmeye başlıyorsun.",
                  karma: 0,
                  reputation: "cesur_kaşif",
                },
                requirements: {
                  skill: "stealth",
                  difficulty: "hard",
                },
              },
            ],
          },
          mystical_forest: {
            introduction: [
              {
                type: "exploration",
                title: "Ormanın Gizemli Derinliklerini Keşfet",
                description:
                  "Ormanın derinliklerinde gizemli ışıklar görüyorsun. Ağaçların arasından gelen fısıltılar seni çağırıyor. Bu eski ormanın sırlarını keşfetmeye hazır mısın?",
                context:
                  "Yapraklar fısıldıyor ve gizemli enerji havada dolaşıyor...",
                consequences: {
                  immediate: "Ormanın derinliklerine doğru ilerliyorsun.",
                  long_term: "Ormanın ruhlarıyla bağlantı kurmaya başlıyorsun.",
                  karma: 2,
                  reputation: "orman_dostu",
                },
                requirements: {
                  skill: "nature_lore",
                  difficulty: "medium",
                },
              },
              {
                type: "dialogue",
                title: "Orman Ruhlarıyla İletişim Kur",
                description:
                  "Ağaçların arasından gelen ruhani varlıklarla konuşmaya çalışıyorsun. Onların eski bilgeliği ve doğanın sırları sana açılabilir.",
                context: "Ruhlar seni sarmaya başlıyor...",
                consequences: {
                  immediate: "Orman ruhları seninle iletişim kuruyor.",
                  long_term: "Doğanın güçlerine erişim kazandın.",
                  karma: 3,
                  reputation: "ruh_iletişimcisi",
                },
                requirements: {
                  skill: "spirit_communication",
                  difficulty: "hard",
                },
              },
            ],
          },
          hive_city: {
            introduction: [
              {
                type: "exploration",
                title: "Hive'ın Alt Seviyelerini Keşfet",
                description:
                  "Hive'ın karanlık alt seviyelerine iniyorsun. Burada teknoloji ve çürüme iç içe geçmiş. Mutantlar, gangler ve eski teknolojinin sırları seni bekliyor.",
                context: "Alt seviyelerdeki hava ağır ve elektrikli...",
                consequences: {
                  immediate: "Hive'ın alt seviyelerine doğru iniyorsun.",
                  long_term:
                    "Hive'ın karanlık sırlarını öğrenmeye başlıyorsun.",
                  karma: -1,
                  reputation: "alt_seviye_kaşifi",
                },
                requirements: {
                  skill: "street_smart",
                  difficulty: "medium",
                },
              },
              {
                type: "dialogue",
                title: "Gang Liderleriyle İttifak Kur",
                description:
                  "Hive'ın gangleri güçlü ve tehlikeli. Onlarla ittifak kurarak hem korunabilir hem de bilgi toplayabilirsin. Ama bu ittifakın bedeli nedir?",
                context: "Gang lideri seni şüpheyle inceliyor...",
                consequences: {
                  immediate: "Gang lideriyle görüşmeye başlıyorsun.",
                  long_term: "Ganglerle ittifak kurma şansın artıyor.",
                  karma: -2,
                  reputation: "gang_dostu",
                },
                requirements: {
                  skill: "intimidation",
                  difficulty: "hard",
                },
              },
            ],
          },
        };

        return (
          templates[location]?.[currentChapter] ||
          templates["dragon_hunting_area"]["introduction"]
        );
      }

      // Enrich choice with context and player state
      function enrichChoiceWithContext(template, storyContext, playerState) {
        const enrichedChoice = {
          ...template,
          context: addDynamicContext(
            template.context,
            storyContext,
            playerState
          ),
          consequences: addDynamicConsequences(
            template.consequences,
            storyContext,
            playerState
          ),
          requirements: adjustRequirements(template.requirements, playerState),
          risk_level: calculateRiskLevel(template, storyContext, playerState),
          reward_potential: calculateRewardPotential(
            template,
            storyContext,
            playerState
          ),
        };

        return enrichedChoice;
      }

      // Add dynamic context based on current situation
      function addDynamicContext(baseContext, storyContext, playerState) {
        const { timeOfDay, weather, atmosphere, immediateThreats } =
          storyContext;

        let dynamicContext = baseContext;

        if (timeOfDay === "night") {
          dynamicContext +=
            " Gece karanlığı her şeyi daha tehlikeli hale getiriyor...";
        } else if (timeOfDay === "storm") {
          dynamicContext += " Fırtına yaklaşıyor ve atmosfer geriliyor...";
        }

        if (weather === "rainy") {
          dynamicContext += " Yağmur yolları kayganlaştırıyor...";
        }

        if (immediateThreats.length > 0) {
          dynamicContext += ` Uzaktan ${immediateThreats[0]} sesleri geliyor...`;
        }

        return dynamicContext;
      }

      // Add dynamic consequences based on current situation
      function addDynamicConsequences(
        baseConsequences,
        storyContext,
        playerState
      ) {
        const { recentEvents, playerReputation } = storyContext;

        let consequences = { ...baseConsequences };

        // Adjust consequences based on reputation
        if (playerReputation.includes("ejderha_avcısı")) {
          consequences.reputation_bonus =
            "Ejderha avcısı ünün sayesinde daha fazla saygı görüyorsun.";
        }

        // Adjust consequences based on recent events
        if (recentEvents.length > 0) {
          consequences.contextual = `Son olayların etkisiyle: ${recentEvents[0]}`;
        }

        return consequences;
      }

      // Adjust requirements based on player state
      function adjustRequirements(baseRequirements, playerState) {
        const { level, equipment } = playerState;

        let requirements = { ...baseRequirements };

        // Adjust difficulty based on player level
        if (level > 5) {
          requirements.difficulty = "easy";
        } else if (level < 3) {
          requirements.difficulty = "hard";
        }

        // Adjust based on equipment
        if (equipment.includes("magical_weapon")) {
          requirements.bonus = "Magical silahın sayesinde avantajlısın.";
        }

        return requirements;
      }

      // Create rich choice content with narrative depth - HIDDEN CONSEQUENCES
      function createRichChoiceContent(choice) {
        const content = `
            <div class="choice-header">
                <h4 class="choice-title">${choice.title}</h4>
                <div class="choice-type-badge ${choice.type}-badge">${getChoiceTypeIcon(choice.type)} ${choice.type.toUpperCase()}</div>
            </div>
            <div class="choice-description">${choice.description}</div>
            <div class="choice-context">${choice.context}</div>
            <div class="choice-mystery">
                <div class="mystery-hint">❓ Bu seçimin sonuçları bilinmiyor...</div>
            </div>
        `;
        
        return content;
      }

      // Get choice type icon
      function getChoiceTypeIcon(type) {
        const icons = {
          exploration: "🔍",
          dialogue: "💬",
          combat: "⚔️",
          stealth: "🥷",
          preparation: "🛠️",
          magic: "🔮",
          trade: "💰",
          survival: "🏕️",
        };

        return icons[type] || "🎯";
      }

      // Execute advanced story choice with rich narrative
      async function executeAdvancedStoryChoice(choice, scenario) {
        console.log("Advanced story choice executed:", choice.title);

        // Display rich story progression
        displayRichStoryProgression(choice, scenario);

        // Handle choice consequences
        handleAdvancedChoiceConsequences(choice, scenario);

        // Update player state
        updatePlayerStateFromChoice(choice);

        // Continue with story progression
        setTimeout(() => {
          continueAdvancedStory(choice, scenario);
        }, 3000);
      }

      // Display rich story progression
      function displayRichStoryProgression(choice, scenario) {
        const storyText = generateRichStoryText(choice, scenario);
        
        document.getElementById("current-scenario-description").innerHTML = `
            <div class="rich-story-progression">
                <div class="story-narrative">${storyText}</div>
                <div class="story-atmosphere">${choice.context}</div>
                <div class="story-mystery">
                    <div class="mystery-text">❓ Ne olacağını zaman gösterecek...</div>
                </div>
            </div>
        `;
      }

      // Generate rich story text based on choice
      function generateRichStoryText(choice, scenario) {
        const storyTemplates = {
          exploration: `Adım adım ${choice.title.toLowerCase()}... Her adımda yeni bir keşif, her köşede yeni bir sır. Senaryonun derinliklerine doğru ilerliyorsun, hazır olduğun şeylerin çok ötesinde bir maceraya doğru...`,
          dialogue: `Konuşmalar başlıyor, kelimeler havada dans ediyor. ${choice.title.toLowerCase()} ile başlayan bu diyalog, seni beklenmedik yerlere götürebilir. Her kelime, her jest, her sessizlik bir anlam taşıyor...`,
          combat: `Savaş atmosferi seni sarıyor. ${choice.title.toLowerCase()} ile başlayan bu mücadele, sadece fiziksel değil, aynı zamanda zihinsel ve ruhsal bir sınav. Hazır mısın?`,
          preparation: `Hazırlık zamanı... ${choice.title.toLowerCase()} ile başlayan bu süreç, başarı için kritik. Her detay, her ekipman, her plan önemli. Acele etme, düşün, planla, hazırlan...`,
          stealth: `Gölgelerde hareket ediyorsun... ${choice.title.toLowerCase()} ile başlayan bu gizli operasyon, sessizlik ve dikkat gerektiriyor. Her adım, her nefes, her hareket önemli...`,
          magic: `Büyü enerjisi etrafını sarıyor... ${choice.title.toLowerCase()} ile başlayan bu büyülü yolculuk, seni bilinmeyen güçlerle tanıştıracak. Dikkatli ol, büyü hem dost hem düşman olabilir...`,
          trade: `Pazarlık masasındasın... ${choice.title.toLowerCase()} ile başlayan bu ticari etkileşim, sadece altın değil, bilgi ve ittifaklar da kazandırabilir. Akıllıca davran...`,
          survival: `Hayatta kalma sınavındasın... ${choice.title.toLowerCase()} ile başlayan bu mücadele, sadece fiziksel değil, aynı zamanda zihinsel dayanıklılık gerektiriyor. Güçlü kal...`,
        };

        return (
          storyTemplates[choice.type] ||
          `Yeni bir macera başlıyor... ${choice.title.toLowerCase()} ile başlayan bu yolculuk, seni nereye götürecek?`
        );
      }

      // Handle advanced choice consequences
      function handleAdvancedChoiceConsequences(choice, scenario) {
        // Update karma
        if (choice.consequences.karma) {
          updateKarma(choice.consequences.karma);
        }

        // Update reputation
        if (choice.consequences.reputation) {
          updateReputation(choice.consequences.reputation);
        }

        // Trigger contextual events
        triggerContextualEvents(choice, scenario);

        // Update story progress
        if (!scenario.storyProgress) scenario.storyProgress = 0;
        scenario.storyProgress++;
      }

      // Update player state from choice
      function updatePlayerStateFromChoice(choice) {
        // Update character stats if needed
        if (choice.consequences.stat_changes) {
          Object.entries(choice.consequences.stat_changes).forEach(
            ([stat, change]) => {
              updateCharacterStat(stat, change);
            }
          );
        }

        // Update equipment if gained
        if (choice.consequences.equipment_gained) {
          addEquipment(choice.consequences.equipment_gained);
        }

        // Update knowledge if gained
        if (choice.consequences.knowledge_gained) {
          addKnowledge(choice.consequences.knowledge_gained);
        }
      }

      // Continue advanced story
      function continueAdvancedStory(choice, scenario) {
        const nextChoices = generateNextAdvancedChoices(choice, scenario);

        // Display new choices
        setTimeout(() => {
          displayNextAdvancedChoices(nextChoices, scenario);
        }, 1000);
      }

      // Generate next advanced choices
      function generateNextAdvancedChoices(previousChoice, scenario) {
        const storyContext = getAdvancedStoryContext(scenario);
        const currentChapter = getCurrentChapter(scenario);
        const playerState = getPlayerState();

        // Generate choices based on previous choice outcome
        const nextChoiceTemplates = getNextAdvancedChoiceTemplates(
          previousChoice,
          storyContext,
          currentChapter
        );
        const contextualizedChoices = [];

        nextChoiceTemplates.forEach((template) => {
          const enrichedChoice = enrichChoiceWithContext(
            template,
            storyContext,
            playerState
          );
          if (enrichedChoice) {
            contextualizedChoices.push(enrichedChoice);
          }
        });

        return contextualizedChoices.slice(0, 3);
      }

      // Get next advanced choice templates
      function getNextAdvancedChoiceTemplates(
        previousChoice,
        storyContext,
        currentChapter
      ) {
        const { location } = storyContext;
        const previousType = previousChoice.type;

        const nextTemplates = {
          exploration: [
            {
              type: "dialogue",
              title: "Keşfettiğin Yerle İlgili Bilgi Topla",
              description:
                "Keşfettiğin yerde bulunan NPC'lerle konuşarak daha fazla bilgi toplamaya çalışıyorsun.",
              context:
                "Yeni keşfettiğin yerdeki insanlar seni merakla inceliyor...",
              consequences: {
                immediate: "Yerel halktan değerli bilgiler topluyorsun.",
                long_term:
                  "Bu bölgede daha fazla bilgi kaynağına erişim kazandın.",
                karma: 1,
              },
            },
            {
              type: "preparation",
              title: "Keşfettiğin Yerde Güvenli Bir Üs Kur",
              description:
                "Keşfettiğin yerde güvenli bir üs kurarak bu bölgeyi daha iyi araştırabilirsin.",
              context:
                "Bu bölge senin için potansiyel bir üs haline geliyor...",
              consequences: {
                immediate: "Bölgede güvenli bir üs kurmaya başlıyorsun.",
                long_term: "Bu bölgeyi daha rahat keşfedebileceksin.",
                karma: 2,
              },
            },
          ],
          dialogue: [
            {
              type: "exploration",
              title: "Konuştuğun Kişinin Gösterdiği Yeri Keşfet",
              description:
                "Konuştuğun kişinin sana gösterdiği yeri keşfetmeye gidiyorsun.",
              context:
                "Konuştuğun kişinin verdiği bilgiler seni yeni yerlere götürüyor...",
              consequences: {
                immediate:
                  "Konuştuğun kişinin gösterdiği yere doğru ilerliyorsun.",
                long_term:
                  "Yeni bilgiler sayesinde daha fazla keşif yapabileceksin.",
                karma: 1,
              },
            },
            {
              type: "preparation",
              title: "Konuştuğun Kişinin Tavsiyelerini Uygula",
              description:
                "Konuştuğun kişinin sana verdiği tavsiyeleri uygulamaya başlıyorsun.",
              context: "Konuştuğun kişinin bilgeliği seni yönlendiriyor...",
              consequences: {
                immediate: "Tavsiyeleri uygulamaya başlıyorsun.",
                long_term:
                  "Bu tavsiyeler sayesinde daha başarılı olabileceksin.",
                karma: 2,
              },
            },
          ],
        };

        return nextTemplates[previousType] || nextTemplates.exploration;
      }

      // Get atmospheric description based on choice and context
      function getAtmosphericDescription(choice, scenario) {
        const location = choice.location || getCurrentLocation(scenario);
        const timeOfDay = getTimeOfDay();

        const atmospheres = {
          dragon_hunting_area: {
            day: "Güneş dağların üzerinde parıldıyor ve rüzgar yaprakları savuruyor...",
            night:
              "Ay ışığı dağların tepelerini aydınlatıyor ve uzaktan ejderha sesleri geliyor...",
            storm: "Gök gürlüyor ve yağmur yaprakları ıslatıyor...",
          },
          mystical_forest: {
            day: "Ormanın derinliklerinden gizemli ışıklar görünüyor ve yapraklar fısıldıyor...",
            night:
              "Gece ormanı büyülü bir atmosferle sarıyor ve ağaçların arasından sesler geliyor...",
            storm:
              "Fırtına ağaçları sallıyor ve gizemli enerjiler hava da dolaşıyor...",
          },
          hive_city: {
            day: "Hive'ın üst seviyelerinden güneş ışığı sızıyor ve makine sesleri yankılanıyor...",
            night:
              "Hive'ın alt seviyeleri karanlıkla sarılıyor ve gizemli ışıklar görünüyor...",
            storm:
              "Fırtına hive'ın üst seviyelerini sallıyor ve elektrik kesintileri yaşanıyor...",
          },
        };

        return (
          atmospheres[location]?.[timeOfDay] ||
          "Atmosfer değişiyor ve yeni maceralar bekliyor..."
        );
      }

      // Get time of day
      function getTimeOfDay() {
        const hour = new Date().getHours();
        if (hour >= 6 && hour < 18) return "day";
        else if (hour >= 18 && hour < 22) return "evening";
        else return "night";
      }

      // Continue contextual story
      function continueContextualStory(choice, scenario) {
        const nextChoices = generateNextChoices(choice, scenario);

        // Display new choices
        setTimeout(() => {
          displayNextChoices(nextChoices, scenario);
        }, 1000);
      }

      // Generate next choices based on previous choice
      function generateNextChoices(previousChoice, scenario) {
        const choiceType = previousChoice.type;
        const location = previousChoice.location;

        const nextChoiceTemplates = getNextChoiceTemplates(
          choiceType,
          location
        );
        const contextualChoices = [];

        nextChoiceTemplates.forEach((template) => {
          const contextualChoice = createContextualChoice(template, storyState);
          if (contextualChoice) {
            contextualChoices.push(contextualChoice);
          }
        });

        return contextualChoices.slice(0, 3); // Limit to 3 choices
      }

      // Get next choice templates
      function getNextChoiceTemplates(choiceType, location) {
        const templates = {
          exploration: {
            dragon_hunting_area: [
              { text: "Mağaranın derinliklerini araştır", type: "exploration" },
              { text: "Ejderhanın hazinesini arayış", type: "exploration" },
              { text: "Güvenli bir sığınak bul", type: "preparation" },
            ],
            mystical_forest: [
              { text: "Eski tapınağı keşfet", type: "exploration" },
              { text: "Büyülü kaynağı bul", type: "exploration" },
              { text: "Orman sakinleriyle tanış", type: "dialogue" },
            ],
            hive_city: [
              { text: "Underground tünelleri keşfet", type: "exploration" },
              { text: "Tech-lab'ı araştır", type: "exploration" },
              { text: "Gang liderleriyle görüş", type: "dialogue" },
            ],
          },
          dialogue: {
            dragon_hunting_area: [
              {
                text: "Ejderha hakkında daha fazla bilgi al",
                type: "dialogue",
              },
              { text: "Avcı grubuna katılmaya karar ver", type: "preparation" },
              { text: "Yerel efsaneleri dinle", type: "dialogue" },
            ],
            mystical_forest: [
              { text: "Orman ruhlarıyla iletişim kur", type: "dialogue" },
              { text: "Büyülü bitkiler hakkında bilgi al", type: "dialogue" },
              { text: "Eski bilgileri araştır", type: "exploration" },
            ],
            hive_city: [
              { text: "Hive politikası hakkında bilgi al", type: "dialogue" },
              { text: "Underground direnişle tanış", type: "dialogue" },
              { text: "Teknoloji hakkında bilgi topla", type: "dialogue" },
            ],
          },
        };

        return (
          templates[choiceType]?.[location] ||
          templates["exploration"]["dragon_hunting_area"]
        );
      }

      // Display next choices
      function displayNextChoices(choices, scenario) {
        const choicesGrid = document.getElementById("choices-grid");
        choicesGrid.innerHTML = "";

        choices.forEach((choice) => {
          const choiceElement = document.createElement("div");
          choiceElement.className = "choice-btn";

          const choiceType = determineChoiceType(choice);

          if (choiceType === "combat") {
            choiceElement.innerHTML = `⚔️ ${choice.text}`;
            choiceElement.classList.add("combat-choice");
          } else if (choiceType === "dialogue") {
            choiceElement.innerHTML = `💬 ${choice.text}`;
            choiceElement.classList.add("dialogue-choice");
          } else if (choiceType === "exploration") {
            choiceElement.innerHTML = `🔍 ${choice.text}`;
            choiceElement.classList.add("exploration-choice");
          } else if (choiceType === "stealth") {
            choiceElement.innerHTML = `🥷 ${choice.text}`;
            choiceElement.classList.add("stealth-choice");
          } else {
            choiceElement.innerHTML = choice.text;
            choiceElement.classList.add("story-choice");
          }

          choiceElement.onclick = () => makeContextualChoice(choice, scenario);
          choicesGrid.appendChild(choiceElement);
        });
      }

      // Handle choice consequences
      function handleChoiceConsequences(choice, scenario) {
        // Update karma based on choice
        if (choice.type === "dialogue") {
          updateKarma(2);
        } else if (choice.type === "combat") {
          updateKarma(-1);
        } else if (choice.type === "exploration") {
          updateKarma(1);
        }

        // Trigger contextual events
        triggerContextualEvent(choice, scenario);
      }

      // Enhanced choice making with battle sequences
      async function makeEnhancedChoice(choice, nodeOrBranch) {
        console.log("Enhanced choice made:", choice.text);

        // Update karma based on choice
        if (choice.effect && choice.effect.karma) {
          const currentKarma = parseInt(
            document.getElementById("player-karma").textContent
          );
          const newKarma = currentKarma + choice.effect.karma;
          document.getElementById("player-karma").textContent = newKarma;
          document.getElementById("karma").textContent = newKarma;
        }

        // Determine choice type based on text content if not explicitly set
        let choiceType = choice.type || "story";
        if (
          choice.text.includes("⚔️") ||
          choice.text.includes("Savaş") ||
          choice.text.includes("Saldır")
        ) {
          choiceType = "combat";
        } else if (
          choice.text.includes("💬") ||
          choice.text.includes("Konuş")
        ) {
          choiceType = "dialogue";
        } else if (choice.text.includes("🏃") || choice.text.includes("Kaç")) {
          choiceType = "escape";
        }

        // Handle different choice types
        if (choiceType === "combat" || choice.text.includes("⚔️")) {
          await initiateBattleSequence(choice);
        } else if (choiceType === "dialogue" || choice.text.includes("💬")) {
          await initiateDialogueSequence(choice);
        } else if (choiceType === "escape" || choice.text.includes("🏃")) {
          await initiateEscapeSequence(choice);
        } else {
          await initiateStoryProgression(choice, nodeOrBranch);
        }
      }

      // Initiate battle sequence
      async function initiateBattleSequence(choice) {
        const battleMessages = [
          "⚔️ <strong>SAVAŞ BAŞLIYOR!</strong> Düşman karşında!",
          "🔥 <strong>BATTLE MODE!</strong> Tüm silahlarını hazırla!",
          "💥 <strong>COMBAT ENGAGED!</strong> Hayatta kalma zamanı!",
        ];

        const battleMessage =
          battleMessages[Math.floor(Math.random() * battleMessages.length)];

        // Update story with battle sequence
        document.getElementById("current-scenario-description").innerHTML = `
                <div class="battle-sequence">
                    <div class="battle-alert">${battleMessage}</div>
                    <div class="battle-status">
                        <div class="enemy-info">
                            <span>👹 Düşman: ${
                              choice.npc_id || "Gizemli Düşman"
                            }</span>
                            <span>❤️ Can: 100/100</span>
                        </div>
                        <div class="player-info">
                            <span>⚔️ Sen: ${
                              currentCharacter?.name || "Kahraman"
                            }</span>
                            <span>❤️ Can: ${
                              currentCharacter?.stats?.constitution * 10 || 100
                            }/100</span>
                        </div>
                    </div>
                    <div class="battle-actions">
                        <button class="battle-btn attack-btn" onclick="performBattleAction('attack')">⚔️ Saldır</button>
                        <button class="battle-btn defend-btn" onclick="performBattleAction('defend')">🛡️ Savun</button>
                        <button class="battle-btn magic-btn" onclick="performBattleAction('magic')">🔮 Büyü</button>
                        <button class="battle-btn flee-btn" onclick="performBattleAction('flee')">🏃 Kaç</button>
                    </div>
                </div>
            `;

        battleSequence = {
          enemy: choice.npc_id || "enemy",
          enemyHealth: 100,
          playerHealth: currentCharacter?.stats?.constitution * 10 || 100,
          round: 1,
        };
      }

      // Perform battle action
      function performBattleAction(action) {
        if (!battleSequence) return;

        const actions = {
          attack: {
            message: "⚔️ Saldırı gerçekleştirdin!",
            damage: Math.floor(Math.random() * 20) + 10,
            type: "player",
          },
          defend: {
            message: "🛡️ Savunma pozisyonu aldın!",
            damage: 0,
            type: "defense",
          },
          magic: {
            message: "🔮 Büyü kullandın!",
            damage: Math.floor(Math.random() * 30) + 15,
            type: "player",
          },
          flee: {
            message: "🏃 Kaçmaya çalışıyorsun!",
            damage: 0,
            type: "flee",
          },
        };

        const actionData = actions[action];

        // Update battle
        if (actionData.type === "player") {
          battleSequence.enemyHealth -= actionData.damage;
        } else if (actionData.type === "flee") {
          // 50% chance to flee successfully
          if (Math.random() > 0.5) {
            endBattleSequence("flee");
            return;
          }
        }

        // Enemy counter-attack
        const enemyDamage = Math.floor(Math.random() * 15) + 5;
        battleSequence.playerHealth -= enemyDamage;

        // Update battle display
        updateBattleDisplay(actionData.message, actionData.damage, enemyDamage);

        // Check battle end conditions
        if (battleSequence.enemyHealth <= 0) {
          endBattleSequence("victory");
        } else if (battleSequence.playerHealth <= 0) {
          endBattleSequence("defeat");
        }
      }

      // Update battle display
      function updateBattleDisplay(playerMessage, playerDamage, enemyDamage) {
        const battleContainer = document.querySelector(".battle-sequence");
        if (!battleContainer) return;

        const battleStatus = battleContainer.querySelector(".battle-status");
        battleStatus.innerHTML = `
                <div class="enemy-info">
                    <span>👹 Düşman: ${battleSequence.enemy}</span>
                    <span>❤️ Can: ${Math.max(
                      0,
                      battleSequence.enemyHealth
                    )}/100</span>
                </div>
                <div class="player-info">
                    <span>⚔️ Sen: ${currentCharacter?.name || "Kahraman"}</span>
                    <span>❤️ Can: ${Math.max(
                      0,
                      battleSequence.playerHealth
                    )}/100</span>
                </div>
            `;

        // Add battle log
        const battleLog = document.createElement("div");
        battleLog.className = "battle-log";
        battleLog.innerHTML = `
                <div class="battle-message">${playerMessage}</div>
                <div class="damage-info">
                    <span class="player-damage">Sen: ${playerDamage} hasar</span>
                    <span class="enemy-damage">Düşman: ${enemyDamage} hasar</span>
                </div>
            `;
        battleContainer.appendChild(battleLog);

        // Remove battle log after 3 seconds
        setTimeout(() => {
          battleLog.remove();
        }, 3000);
      }

      // End battle sequence
      function endBattleSequence(result) {
        const messages = {
          victory: "🏆 <strong>ZAFER!</strong> Düşmanı yendin!",
          defeat: "💀 <strong>YENİLGİ!</strong> Bilinçsiz düştün...",
          flee: "🏃 <strong>KAÇTIN!</strong> Savaştan kaçmayı başardın.",
        };

        document.getElementById("current-scenario-description").innerHTML = `
                <div class="battle-result">
                    <div class="result-message">${messages[result]}</div>
                    <div class="story-continuation">
                        Hikaye devam ediyor... Yeni seçenekler beliriyor...
                    </div>
                </div>
            `;

        battleSequence = null;

        // Continue story after battle
        setTimeout(() => {
          continueStoryAfterBattle(result);
        }, 3000);
      }

      // Continue story after battle
      function continueStoryAfterBattle(battleResult) {
        const storyContinuations = {
          victory: [
            "🎉 Zaferinle birlikte yeni bir güç kazandın. Yoluna devam ediyorsun...",
            "⚔️ Düşmanı yendikten sonra, onun bıraktığı izler seni yeni bir maceraya sürüklüyor...",
            "🏆 Savaştan galip çıktın. Şimdi daha büyük tehditlerle yüzleşme zamanı...",
          ],
          defeat: [
            "💔 Yenilgiden sonra kendini toparlamaya çalışıyorsun. Bu bir öğrenme deneyimi...",
            "🔄 Bilinçsiz düştün ama hayatta kaldın. Bu sefer daha dikkatli olmalısın...",
            "🌟 Yenilgi seni daha güçlü yapacak. Tekrar deneme zamanı...",
          ],
          flee: [
            "🏃 Kaçmak bazen en akıllı seçimdir. Şimdi daha iyi bir plan yapma zamanı...",
            "🧠 Stratejik geri çekilme yaptın. Bu sefer daha hazırlıklı olacaksın...",
            "⚡ Kaçtın ama bu savaşın sonu değil. Tekrar karşılaşacaksın...",
          ],
        };

        const continuations = storyContinuations[battleResult];
        const randomContinuation =
          continuations[Math.floor(Math.random() * continuations.length)];

        document.getElementById("current-scenario-description").innerHTML = `
                <div class="story-continuation">
                    <p>${randomContinuation}</p>
                    <p>🎭 <em>Hikaye devam ediyor... Yeni seçenekler beliriyor...</em></p>
                </div>
            `;
      }

      // Initiate dialogue sequence with immersive storytelling
      async function initiateDialogueSequence(choice) {
        const npcData = getNPCDetails(choice.npc_id || "unknown");
        const dialogueContext = getDialogueContext(choice.npc_id || "unknown");

        document.getElementById("current-scenario-description").innerHTML = `
                <div class="dialogue-sequence">
                    <div class="dialogue-content">
                        <div class="npc-info">
                            <span class="npc-icon">${npcData.icon}</span>
                            <span class="npc-name">${npcData.name}</span>
                        </div>
                        <div class="dialogue-text">
                            ${dialogueContext.opening}
                        </div>
                    </div>
                    <div class="dialogue-choices">
                        <button class="dialogue-btn" onclick="continueDialogue('friendly', '${
                          choice.npc_id || "unknown"
                        }')">${dialogueContext.friendlyOption}</button>
                        <button class="dialogue-btn" onclick="continueDialogue('neutral', '${
                          choice.npc_id || "unknown"
                        }')">${dialogueContext.neutralOption}</button>
                        <button class="dialogue-btn" onclick="continueDialogue('hostile', '${
                          choice.npc_id || "unknown"
                        }')">${dialogueContext.hostileOption}</button>
                    </div>
                </div>
            `;
      }

      // Get NPC details based on context
      function getNPCDetails(npcId) {
        const npcDatabase = {
          elder_villager: {
            name: "Köyün İhtiyarı",
            icon: "👴",
            personality: "bilge, deneyimli",
          },
          mysterious_stranger: {
            name: "Gizemli Yabancı",
            icon: "👤",
            personality: "şüpheli, ketum",
          },
          wounded_traveler: {
            name: "Yaralı Yolcu",
            icon: "🏃",
            personality: "acılı, umutsuz",
          },
          merchant: {
            name: "Tüccar",
            icon: "💰",
            personality: "pazarlıkçı, işçi",
          },
          guard: {
            name: "Muhafız",
            icon: "🛡️",
            personality: "dikkatli, şüpheci",
          },
          mage: {
            name: "Büyücü",
            icon: "🔮",
            personality: "gizemli, güçlü",
          },
          dragon: {
            name: "Ejderha",
            icon: "🐉",
            personality: "gururlu, tehlikeli",
          },
          forest_spirit: {
            name: "Orman Ruhu",
            icon: "🌳",
            personality: "eski, doğal",
          },
          hive_citizen: {
            name: "Hive Sakini",
            icon: "🏭",
            personality: "korkmuş, umutsuz",
          },
          space_marine: {
            name: "Space Marine",
            icon: "🛡️",
            personality: "disiplinli, fanatik",
          },
          tech_priest: {
            name: "Tech-Priest",
            icon: "⚙️",
            personality: "teknik, inançlı",
          },
          gang_member: {
            name: "Gang Üyesi",
            icon: "🔪",
            personality: "sert, şüpheli",
          },
          corporate_exec: {
            name: "Şirket Yöneticisi",
            icon: "👔",
            personality: "soğuk, hesaplı",
          },
          netrunner: {
            name: "Netrunner",
            icon: "💻",
            personality: "siber, gizli",
          },
        };

        return (
          npcDatabase[npcId] || {
            name: "Gizemli Figür",
            icon: "👤",
            personality: "gizemli",
          }
        );
      }

      // Get contextual dialogue options
      function getDialogueContext(npcId) {
        const contextDatabase = {
          elder_villager: {
            opening:
              "Yaşlı köylü gözlerini kısarak sana bakıyor. Uzun yılların deneyimi yüzündeki çizgilerden okunuyor. 'Yabancı, bu topraklarda ne arıyorsun?' diye soruyor.",
            friendlyOption: "🌟 Saygıyla selamla ve yardım iste",
            neutralOption: "🎭 Durumu açıkla ve bilgi al",
            hostileOption: "⚔️ Tehditkar davran ve zorla",
          },
          mysterious_stranger: {
            opening:
              "Gölgelerin arasından çıkan figür kendini gizlemeye çalışıyor. Karanlık bir pelerin altından sadece gözleri görünüyor. Sessizce duruyor ve seni izliyor...",
            friendlyOption: "🤝 Barışçıl bir yaklaşım sergile",
            neutralOption: "👁️ Dikkatlice gözlemle",
            hostileOption: "⚡ Saldırgan tavır takın",
          },
          wounded_traveler: {
            opening:
              "Yolun kenarında yaralı bir yolcu yatıyor. Kanlı bandajlar ve acı dolu gözlerle sana bakıyor. Nefes almakta zorlanıyor gibi görünüyor...",
            friendlyOption: "💊 Yardım et ve iyileştir",
            neutralOption: "🔍 Durumu araştır",
            hostileOption: "🏃 Umursamadan geç",
          },
          merchant: {
            opening:
              "Tüccar tezgahının arkasında duruyor ve mallarını sergiliyor. Gözleri parlak altın parıltılarıyla dolu. 'En iyi fiyatlar, en kaliteli mallar!' diye bağırıyor.",
            friendlyOption: "💰 Pazarlık yap ve anlaş",
            neutralOption: "👀 Malları incele",
            hostileOption: "⚔️ Tehdit et ve zorla",
          },
          guard: {
            opening:
              "Muhafız silahını tutuyor ve sana şüpheyle bakıyor. Görevini yerine getirme konusunda kararlı görünüyor. 'Kimlik ve amaç?' diye soruyor.",
            friendlyOption: "🛡️ Saygıyla kimliğini göster",
            neutralOption: "🎭 Durumu açıkla",
            hostileOption: "⚔️ Saldırıya geç",
          },
          mage: {
            opening:
              "Büyücü etrafında büyülü enerji dalgaları yaratıyor. Gözlerinde eski bilgelik parıldıyor. 'Büyü seni buraya getirdi mi?' diye fısıldıyor.",
            friendlyOption: "🔮 Büyü hakkında bilgi iste",
            neutralOption: "👁️ Güçlerini gözlemle",
            hostileOption: "⚡ Büyüye karşı savaş",
          },
          dragon: {
            opening:
              "Ejderha gökyüzünde süzülüyor ve seni inceliyor. Pulları güneş ışığında parıldıyor. Ağzından çıkan duman havayı ısıtıyor...",
            friendlyOption: "🌟 Saygıyla yaklaş",
            neutralOption: "👁️ Dikkatlice izle",
            hostileOption: "⚔️ Savaşmaya hazırlan",
          },
          forest_spirit: {
            opening:
              "Ormanın derinliklerinden gelen ruh ağaçların arasından beliriyor. Doğanın gücü varlığından yayılıyor. Yapraklar fısıldıyor...",
            friendlyOption: "🌿 Doğayla uyum sağla",
            neutralOption: "👁️ Ruhu gözlemle",
            hostileOption: "⚔️ Ruhla savaş",
          },
          hive_citizen: {
            opening:
              "Hive sakini korku dolu gözlerle etrafına bakıyor. Kirli ve yorgun görünüyor. 'Yukarıdan mısın?' diye fısıldıyor.",
            friendlyOption: "🤝 Yardım et ve koru",
            neutralOption: "👁️ Durumu öğren",
            hostileOption: "⚔️ Tehdit et",
          },
          space_marine: {
            opening:
              "Space Marine güç zırhının içinden seni inceliyor. İmparatorluğa olan sadakati her hareketinden belli. 'İmparatorun hizmetindesin mi?' diye soruyor.",
            friendlyOption: "🛡️ İmparatora sadakat göster",
            neutralOption: "🎭 Durumu açıkla",
            hostileOption: "⚔️ İhanet et",
          },
          tech_priest: {
            opening:
              "Tech-Priest mekanik uzuvlarıyla etrafındaki makineleri kontrol ediyor. Gözlerinde teknolojik parıltılar var. 'Makine ruhu seni çağırdı mı?' diye soruyor.",
            friendlyOption: "⚙️ Teknolojiye saygı göster",
            neutralOption: "👁️ Makineleri incele",
            hostileOption: "⚔️ Teknolojiyi reddet",
          },
          gang_member: {
            opening:
              "Gang üyesi köşede duruyor ve seni tehditkar bir şekilde inceliyor. Silahını tutuyor ve çevresindeki tehlikeyi hissediyorsun...",
            friendlyOption: "🤝 Barış teklif et",
            neutralOption: "👁️ Durumu değerlendir",
            hostileOption: "⚔️ Savaşmaya hazırlan",
          },
          corporate_exec: {
            opening:
              "Şirket yöneticisi lüks ofisinde oturuyor ve seni soğuk bir şekilde inceliyor. Para ve güç kokusu havayı dolduruyor. 'İş mi var?' diye soruyor.",
            friendlyOption: "💰 İş teklifi yap",
            neutralOption: "👁️ Durumu öğren",
            hostileOption: "⚔️ Tehdit et",
          },
          netrunner: {
            opening:
              "Netrunner siber uzayda süzülüyor gibi görünüyor. Gözlerinde dijital parıltılar var. 'Matrix'e hoş geldin mi?' diye soruyor.",
            friendlyOption: "💻 Siber uzayda yardım iste",
            neutralOption: "👁️ Ağları incele",
            hostileOption: "⚔️ Sistemlere saldır",
          },
        };

        return (
          contextDatabase[npcId] || {
            opening: "Karakter sana bakıyor ve ne yapacağını bekliyor...",
            friendlyOption: "🌟 Nazikçe yaklaş",
            neutralOption: "👁️ Dikkatlice gözlemle",
            hostileOption: "⚔️ Tehditkar davran",
          }
        );
      }

      // Continue dialogue with contextual responses
      function continueDialogue(approach, npcId) {
        const npcData = getNPCDetails(npcId);
        const dialogueResponses = getDialogueResponses(approach, npcId);

        // Update karma based on approach
        let karmaChange = 0;
        if (approach === "friendly") karmaChange = 3;
        else if (approach === "neutral") karmaChange = 1;
        else if (approach === "hostile") karmaChange = -3;

        updateKarma(karmaChange);

        document.getElementById("current-scenario-description").innerHTML = `
                <div class="dialogue-response">
                    <div class="response-content">
                        <div class="npc-response">
                            <span class="npc-icon">${npcData.icon}</span>
                            <div class="response-text">${dialogueResponses.response}</div>
                        </div>
                        <div class="response-consequence">
                            ${dialogueResponses.consequence}
                        </div>
                    </div>
                </div>
            `;

        // Continue story after dialogue
        setTimeout(() => {
          continueStoryAfterDialogue(approach, npcId);
        }, 3000);
      }

      // Get contextual dialogue responses
      function getDialogueResponses(approach, npcId) {
        const responseDatabase = {
          elder_villager: {
            friendly: {
              response:
                "İhtiyar gözlerinde yaşlarla gülümsüyor. 'Ah, genç dostum, bu köyde böyle nazik birini görmek ne güzel. Sana yardım edebilirim...'",
              consequence: "Köylü sana güveniyor ve değerli bilgiler veriyor.",
            },
            neutral: {
              response:
                "İhtiyar dikkatlice seni inceliyor. 'Hmm, ne istediğine bağlı. Önce güvenimi kazanman gerek...'",
              consequence: "Köylü temkinli ama yardım edebilir.",
            },
            hostile: {
              response:
                "İhtiyar kaşlarını çatıyor ve kaçınıyor. 'Bu topraklarda senin türünden insanları istemiyoruz!'",
              consequence: "Köylü sana güvenmiyor ve diğer köylüleri uyarıyor.",
            },
          },
          mysterious_stranger: {
            friendly: {
              response:
                "Yabancı pelerinini hafifçe açar ve gözlerinde dostluk parıldıyor. 'Belki de yanlış kişiyi yargılıyordum...'",
              consequence:
                "Yabancı sana güveniyor ve gizli bilgiler paylaşıyor.",
            },
            neutral: {
              response:
                "Yabancı hala ketum ama tehditkar değil. 'Dikkatli ol, bu yerler tehlikeli...'",
              consequence:
                "Yabancı seni uyarıyor ama daha fazla bilgi vermiyor.",
            },
            hostile: {
              response:
                "Yabancı silahını çekiyor ve tehditkar bir pozisyon alıyor. 'Bu bir hataydı...'",
              consequence: "Yabancı sana düşman oluyor ve saldırıya geçiyor.",
            },
          },
          wounded_traveler: {
            friendly: {
              response:
                "Yaralı yolcu gözlerinde minnetle sana bakıyor. 'Tanrı seni korusun, dostum. Senin sayende hayatta kalacağım...'",
              consequence: "Yolcu iyileşiyor ve sana değerli bir eşya veriyor.",
            },
            neutral: {
              response:
                "Yolcu dikkatlice seni inceliyor. 'Teşekkürler ama daha fazla yardıma ihtiyacım var...'",
              consequence:
                "Yolcu sana teşekkür ediyor ama hala yardıma ihtiyacı var.",
            },
            hostile: {
              response:
                "Yolcu korkuyla geri çekiliyor. 'Neden bana zarar vermek istiyorsun? Zaten yeterince acı çekiyorum...'",
              consequence: "Yolcu sana korkuyla bakıyor ve kaçmaya çalışıyor.",
            },
          },
        };

        const npcResponses = responseDatabase[npcId] || {
          friendly: {
            response:
              "Karakter gözlerinde dostluk parıldıyor. 'Teşekkürler, dostum...'",
            consequence: "Karakter sana güveniyor ve yardım ediyor.",
          },
          neutral: {
            response: "Karakter dikkatlice seni inceliyor. 'Anlıyorum...'",
            consequence: "Karakter seni gözlemliyor ve durumu değerlendiriyor.",
          },
          hostile: {
            response:
              "Karakter tehditkar bir pozisyon alıyor. 'Bu bir hataydı...'",
            consequence: "Karakter sana düşman oluyor ve saldırıya geçiyor.",
          },
        };

        return npcResponses[approach] || npcResponses.neutral;
      }

      // Continue story after dialogue with natural progression
      function continueStoryAfterDialogue(approach, npcId) {
        const npcData = getNPCDetails(npcId);
        const naturalProgressions = getNaturalProgressions(npcId, approach);

        const randomProgression =
          naturalProgressions[
            Math.floor(Math.random() * naturalProgressions.length)
          ];

        document.getElementById("current-scenario-description").innerHTML += `
            <div class="story-continuation">
                <div class="continuation-text">${randomProgression}</div>
            </div>
        `;

        // Continue with natural story flow
        setTimeout(() => {
          continueNaturalStory(npcId, approach);
        }, 2000);
      }

      // Get natural story progressions based on NPC and approach
      function getNaturalProgressions(npcId, approach) {
        const progressionDatabase = {
          elder_villager: {
            friendly: [
              "İhtiyar gözlerindeki yaşları silerek sana teşekkür ediyor. Köyün meydanına doğru yönlendiriyor...",
              "Yaşlı köylü sana bir harita çıkarıyor ve yolu gösteriyor. Rüzgar yaprakları savuruyor...",
              "İhtiyar başını sallayarak onaylıyor. Uzaktan bir ses geliyor...",
            ],
            neutral: [
              "İhtiyar düşünceli bir şekilde seni inceliyor. Rüzgar ağaçların arasından esiyor...",
              "Yaşlı köylü kaşlarını çatıyor. Uzaktan bir köpek havlaması duyuluyor...",
              "İhtiyar sessizce duruyor. Hafif bir gürültü dikkatini çekiyor...",
            ],
            hostile: [
              "İhtiyar kaşlarını çatıyor ve geri çekiliyor. Atmosfer geriliyor...",
              "Yaşlı köylü seni tehditkar bir şekilde izliyor. Uzaktan bir gürültü geliyor...",
              "İhtiyar kaçınıyor. Çevrede bir hareketlilik hissediliyor...",
            ],
          },
          mysterious_stranger: {
            friendly: [
              "Yabancı pelerinini hafifçe açar. Gölgeler dans etmeye başlıyor...",
              "Gizemli figür sana doğru bir adım atıyor. Gece havası ağırlaşıyor...",
              "Yabancı gözlerinde parıltıyla sana bakıyor. Uzaktan bir ışık görünüyor...",
            ],
            neutral: [
              "Yabancı hala ketum. Rüzgar pelerini dalgalandırıyor...",
              "Gizemli figür dikkatlice seni gözlemliyor. Gece derinleşiyor...",
              "Yabancı sessizce duruyor. Çevrede bir hareketlilik var...",
            ],
            hostile: [
              "Yabancı tehditkar bir pozisyon alıyor. Atmosfer geriliyor...",
              "Gizemli figür silahını tutuyor. Gece havası ağırlaşıyor...",
              "Yabancı kaçınıyor. Uzaktan bir gürültü geliyor...",
            ],
          },
          wounded_traveler: {
            friendly: [
              "Yaralı yolcu gözlerinde minnetle sana bakıyor. Güneş ufukta batıyor...",
              "Yolcu iyileşmeye başlıyor. Uzaktan bir ses geliyor...",
              "Yaralı kişi teşekkür ediyor. Rüzgar yaprakları savuruyor...",
            ],
            neutral: [
              "Yolcu dikkatlice seni inceliyor. Atmosfer durgun...",
              "Yaralı kişi sessizce duruyor. Uzaktan bir gürültü geliyor...",
              "Yolcu temkinli görünüyor. Hafif bir rüzgar esiyor...",
            ],
            hostile: [
              "Yolcu korkuyla geri çekiliyor. Atmosfer geriliyor...",
              "Yaralı kişi kaçmaya çalışıyor. Uzaktan bir ses geliyor...",
              "Yolcu tehditkar davranıyor. Çevrede bir hareketlilik var...",
            ],
          },
          dragon: {
            friendly: [
              "Ejderha gözlerinde bir anlayış parıldıyor. Gökyüzünde bulutlar toplanıyor...",
              "Büyük yaratık hafifçe başıyla onaylıyor. Rüzgar güçleniyor...",
              "Ejderha sana doğru nazikçe yaklaşıyor. Atmosfer değişiyor...",
            ],
            neutral: [
              "Ejderha dikkatlice seni inceliyor. Hava elektrikli hale geliyor...",
              "Büyük yaratık duraksıyor. Uzaktan bir gürültü geliyor...",
              "Ejderha hala tetikte duruyor. Atmosfer gergin...",
            ],
            hostile: [
              "Ejderha tehditkar bir pozisyon alıyor. Hava ısınıyor...",
              "Büyük yaratık saldırıya geçmeye hazırlanıyor. Atmosfer geriliyor...",
              "Ejderha gökyüzünde süzülüyor. Tehdit hissi artıyor...",
            ],
          },
        };

        const npcProgressions = progressionDatabase[npcId] || {
          friendly: [
            "Karakter sana nazikçe bakıyor. Rüzgar hafifçe esiyor...",
            "Figür teşekkür ediyor. Atmosfer sakinleşiyor...",
            "Kişi sana doğru yaklaşıyor. Uzaktan bir ses geliyor...",
          ],
          neutral: [
            "Karakter dikkatlice seni gözlemliyor. Atmosfer durgun...",
            "Figür temkinli davranıyor. Hafif bir rüzgar esiyor...",
            "Kişi sessizce duruyor. Çevrede bir hareketlilik var...",
          ],
          hostile: [
            "Karakter tehditkar davranıyor. Atmosfer geriliyor...",
            "Figür kaçınıyor. Uzaktan bir gürültü geliyor...",
            "Kişi saldırgan tavır takınıyor. Hava ağırlaşıyor...",
          ],
        };

        return npcProgressions[approach] || npcProgressions.neutral;
      }

      // Continue natural story flow
      function continueNaturalStory(npcId, approach) {
        const naturalNextSteps = getNaturalNextSteps(npcId, approach);

        if (naturalNextSteps && naturalNextSteps.length > 0) {
          const randomNextStep =
            naturalNextSteps[
              Math.floor(Math.random() * naturalNextSteps.length)
            ];

          document.getElementById("current-scenario-description").innerHTML += `
              <div class="natural-progression">
                  <div class="progression-text">${randomNextStep}</div>
              </div>
          `;
        }
      }

      // Get natural next steps based on context
      function getNaturalNextSteps(npcId, approach) {
        const nextStepsDatabase = {
          elder_villager: {
            friendly: [
              "Köyün meydanına doğru ilerliyorsun. Uzaktan köylülerin sesleri geliyor...",
              "İhtiyarın gösterdiği yolda yürüyorsun. Rüzgar yaprakları savuruyor...",
              "Köyün derinliklerine doğru yöneliyorsun. Atmosfer değişiyor...",
            ],
            neutral: [
              "Dikkatlice çevreyi gözlemliyorsun. Uzaktan bir gürültü geliyor...",
              "Köyde daha fazla bilgi aramaya karar veriyorsun. Rüzgar hafifçe esiyor...",
              "Çevredeki izleri takip etmeye başlıyorsun. Hafif bir ses geliyor...",
            ],
            hostile: [
              "Temkinli bir şekilde çevreyi gözlemliyorsun. Atmosfer gergin...",
              "Dikkatli adımlarla ilerliyorsun. Uzaktan bir gürültü geliyor...",
              "Güvenli bir mesafe bırakarak hareket ediyorsun. Hava ağırlaşıyor...",
            ],
          },
          mysterious_stranger: {
            friendly: [
              "Yabancı sana eşlik etmeye karar veriyor. Gölgeler dans etmeye başlıyor...",
              "Gizemli figür sana bir yol gösteriyor. Gece havası değişiyor...",
              "Yabancı seni takip etmeye başlıyor. Uzaktan bir ışık görünüyor...",
            ],
            neutral: [
              "Yabancı seni gözlemlemeye devam ediyor. Atmosfer durgun...",
              "Gizemli figür hala ketum. Rüzgar pelerini dalgalandırıyor...",
              "Yabancı sessizce seni takip ediyor. Çevrede bir hareketlilik var...",
            ],
            hostile: [
              "Yabancı tehditkar bir şekilde seni izliyor. Atmosfer geriliyor...",
              "Gizemli figür silahını tutuyor. Gece havası ağırlaşıyor...",
              "Yabancı seninle mesafesini koruyor. Uzaktan bir gürültü geliyor...",
            ],
          },
        };

        const npcNextSteps = nextStepsDatabase[npcId] || {
          friendly: [
            "Karakter sana eşlik etmeye karar veriyor. Atmosfer değişiyor...",
            "Figür sana bir yol gösteriyor. Rüzgar hafifçe esiyor...",
            "Kişi seni takip etmeye başlıyor. Uzaktan bir ses geliyor...",
          ],
          neutral: [
            "Karakter dikkatlice seni gözlemliyor. Atmosfer durgun...",
            "Figür temkinli davranıyor. Hafif bir rüzgar esiyor...",
            "Kişi sessizce seni takip ediyor. Çevrede bir hareketlilik var...",
          ],
          hostile: [
            "Karakter tehditkar bir şekilde seni izliyor. Atmosfer geriliyor...",
            "Figür silahını tutuyor. Hava ağırlaşıyor...",
            "Kişi seninle mesafesini koruyor. Uzaktan bir gürültü geliyor...",
          ],
        };

        return npcNextSteps[approach] || npcNextSteps.neutral;
      }

      // Display contextual actions
      function displayContextualActions(actions) {
        const actionsContainer = document.getElementById('contextual-actions');
        const actionsSection = document.getElementById('contextual-actions-section');
        
        if (!actionsContainer || !actionsSection) return;
        
        // Show the actions section
        actionsSection.style.display = 'block';
        actionsContainer.innerHTML = '';
        
        if (actions && actions.length > 0) {
          actions.forEach(action => {
            const actionBtn = document.createElement('button');
            actionBtn.className = 'action-btn ' + (action.type || 'general');
            actionBtn.innerHTML = action.emoji + ' ' + action.text;
            actionBtn.onclick = () => executeAction(action);
            actionsContainer.appendChild(actionBtn);
          });
        } else {
          // Fallback actions
          const fallbackActions = [
            { text: '🔍 Keşfet', type: 'explore', emoji: '🔍' },
            { text: '💬 Konuş', type: 'social', emoji: '💬' },
            { text: '⚔️ Savaş', type: 'combat', emoji: '⚔️' },
            { text: '🎒 Envanter', type: 'inventory', emoji: '🎒' }
          ];
          
          fallbackActions.forEach(action => {
            const actionBtn = document.createElement('button');
            actionBtn.className = 'action-btn ' + action.type;
            actionBtn.innerHTML = action.emoji + ' ' + action.text;
            actionBtn.onclick = () => executeAction(action);
            actionsContainer.appendChild(actionBtn);
          });
        }
      }
      
      // Execute action and emit to server
      function executeAction(action) {
        if (socket) {
          socket.emit('game_action', {
            action: action,
            scenario_id: currentScenario ? currentScenario.id : 'fantasy_dragon',
            player_data: currentCharacter
          });
        } else {
          console.error('Socket not connected');
        }
      }
      
      // Initiate story progression with natural flow
      async function initiateStoryProgression(choice) {
        const naturalProgression = getNaturalStoryProgression(choice);

        document.getElementById("current-scenario-description").innerHTML = `
      }
      
      // GLOBAL FUNCTION DEFINITIONS - TÜM FONKSİYONLARI GLOBAL YAP
      function loadScenarios() {
        console.log("🔄 Loading scenarios...");
        fetch('/api/scenarios')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.scenarios) {
              scenarios = data.scenarios;
              displayScenarios();
              alert(`✅ ${data.scenarios.length} senaryo yüklendi!`);
            } else {
              alert("❌ Senaryolar yüklenemedi!");
            }
          })
          .catch(error => {
            console.error("API Error:", error);
            alert("❌ Bağlantı hatası!");
          });
      };
      
      function displayScenarios() {
        const container = document.getElementById('scenarios-container');
        if (!container) return;
        container.innerHTML = '';
        scenarios.forEach(scenario => {
          const scenarioElement = document.createElement('div');
          scenarioElement.className = 'scenario-item';
          scenarioElement.innerHTML = `
            <div class="scenario-title">${scenario.title}</div>
            <div class="scenario-desc">${scenario.description}</div>
            <div class="scenario-meta">
              <span class="difficulty">${scenario.difficulty || 'normal'}</span>
              <span class="genre">${scenario.theme || 'fantasy'}</span>
            </div>
          `;
          scenarioElement.onclick = () => selectScenario(scenario);
          container.appendChild(scenarioElement);
        });
      };
      
      function selectScenario(scenario) {
        console.log("🎯 Scenario selected:", scenario.title);
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="scenario-detail">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 ${scenario.title}</h3>
              <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <div style="background: rgba(255,215,0,0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #FFD700;">
                  <h4 style="color: #FFD700; margin-bottom: 10px; font-size: 16px;">📚 Senaryo Özeti</h4>
                  <p style="font-size: 14px; line-height: 1.6; margin-bottom: 0; color: rgba(255,255,255,0.9);">${scenario.description}</p>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                  <span style="background: #FF9800; color: #000; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                    ⚔️ Zorluk: ${scenario.difficulty || 'Normal'}
                  </span>
                  <span style="background: #9C27B0; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                    🎭 Tema: ${scenario.theme || scenario.genre || 'Fantasy'}
                  </span>
                  <span style="background: #4CAF50; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                    ⏱️ Süre: ${scenario.estimatedPlayTime || 60} dk
                  </span>
                </div>
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                  <h4 style="color: #FFD700; margin-bottom: 10px; font-size: 14px;">🌟 Özellikler</h4>
                  <ul style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.8); font-size: 13px;">
                    <li>📖 Kitap gibi detaylı anlatım</li>
                    <li>🎭 Duygusal karakter gelişimi</li>
                    <li>⚔️ Etkileşimli savaş sistemi</li>
                    <li>🌟 Akıllı plot twist'ler</li>
                    <li>🎯 Hayat gibi gerçekçi seçimler</li>
                  </ul>
                </div>
                <div style="text-align: center;">
                  <button onclick="startScenario('${scenario.id}')" style="
                    background: linear-gradient(45deg, #4CAF50, #45a049);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 16px;
                    margin-right: 10px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    transition: all 0.3s ease;
                  " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">🚀 Maceraya Başla</button>
                  <button onclick="backToScenarios()" style="
                    background: linear-gradient(45deg, #FF9800, #F57C00);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 16px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    transition: all 0.3s ease;
                  " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">← Geri Dön</button>
                </div>
              </div>
            </div>
          `;
        }
        alert(`✅ Senaryo seçildi: ${scenario.title}`);
      };
      
      function startScenario(scenarioId) {
        console.log("🚀 Starting scenario:", scenarioId);
        
        // Fetch detailed scenario data
        fetch(`/api/scenario/${scenarioId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.scenario) {
              const scenario = data.scenario;
              const startNode = scenario.nodes.start;
              
              const centerPanel = document.querySelector('.center-panel');
              if (centerPanel) {
                centerPanel.innerHTML = `
                  <div class="scenario-story">
                    <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 ${startNode.title}</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                      <div style="background: rgba(255,215,0,0.05); padding: 20px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #FFD700;">
                        <div style="white-space: pre-line; font-size: 15px; line-height: 1.8; text-align: justify; color: rgba(255,255,255,0.95); font-family: 'Georgia', serif;">
                          ${startNode.detailed_narrative || startNode.description}
                        </div>
                      </div>
                      
                      ${startNode.atmospheric_details ? `
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                          <h4 style="color: #FFD700; margin-bottom: 10px; font-size: 14px;">🌍 Atmosfer</h4>
                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 12px;">
                            <div>
                              <strong style="color: #FFD700;">🔊 Sesler:</strong>
                              <div style="color: rgba(255,255,255,0.8); margin-top: 5px;">${startNode.atmospheric_details.sounds.join(', ')}</div>
                            </div>
                            <div>
                              <strong style="color: #FFD700;">👃 Kokular:</strong>
                              <div style="color: rgba(255,255,255,0.8); margin-top: 5px;">${startNode.atmospheric_details.smells.join(', ')}</div>
                            </div>
                            <div>
                              <strong style="color: #FFD700;">👁️ Görsel:</strong>
                              <div style="color: rgba(255,255,255,0.8); margin-top: 5px;">${startNode.atmospheric_details.visuals.join(', ')}</div>
                            </div>
                            <div>
                              <strong style="color: #FFD700;">💭 Duygular:</strong>
                              <div style="color: rgba(255,255,255,0.8); margin-top: 5px;">${startNode.atmospheric_details.emotions.join(', ')}</div>
                            </div>
                          </div>
                        </div>
                      ` : ''}
                      
                      <div style="text-align: center; margin: 20px 0;">
                        <p style="color: #FFD700; font-style: italic; font-size: 14px; font-family: 'Georgia', serif;">
                          "Bu macerada her seçimin sonuçları olacak. Dikkatli ol ve seçimlerini akıllıca yap..."
                        </p>
                      </div>
                      
                      <div style="text-align: center;">
                        <button onclick="showDetailedChoices('${scenarioId}', 'start')" style="
                          background: linear-gradient(45deg, #4CAF50, #45a049);
                          color: white;
                          border: none;
                          padding: 15px 30px;
                          border-radius: 6px;
                          cursor: pointer;
                          font-weight: bold;
                          font-size: 16px;
                          box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                          transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">🎭 Seçeneklerini Gör</button>
                      </div>
                    </div>
                  </div>
                `;
              }
            } else {
              // Fallback to simple story
              showStoryChoices();
            }
          })
          .catch(error => {
            console.error("Error loading scenario:", error);
            showStoryChoices();
          });
      };
      
      function showStoryChoices() {
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="story-choices">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">⚡ Seçeneklerin</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <button onclick="makeChoice('explore')" style="
                  background: rgba(76, 175, 80, 0.2);
                  border: 1px solid #4CAF50;
                  color: #4CAF50;
                  padding: 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: bold;
                  transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'" onmouseout="this.style.background='rgba(76, 175, 80, 0.2)'">
                  🔍 Çevreyi Keşfet
                </button>
                <button onclick="makeChoice('dialogue')" style="
                  background: rgba(33, 150, 243, 0.2);
                  border: 1px solid #2196F3;
                  color: #2196F3;
                  padding: 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: bold;
                  transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(33, 150, 243, 0.3)'" onmouseout="this.style.background='rgba(33, 150, 243, 0.2)'">
                  💬 NPC ile Konuş
                </button>
                <button onclick="makeChoice('combat')" style="
                  background: rgba(244, 67, 54, 0.2);
                  border: 1px solid #F44336;
                  color: #F44336;
                  padding: 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: bold;
                  transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(244, 67, 54, 0.3)'" onmouseout="this.style.background='rgba(244, 67, 54, 0.2)'">
                  ⚔️ Savaşmaya Hazırlan
                </button>
                <button onclick="makeChoice('stealth')" style="
                  background: rgba(156, 39, 176, 0.2);
                  border: 1px solid #9C27B0;
                  color: #9C27B0;
                  padding: 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: bold;
                  transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(156, 39, 176, 0.3)'" onmouseout="this.style.background='rgba(156, 39, 176, 0.2)'">
                  🥷 Gizlice İlerle
                </button>
              </div>
              <div style="text-align: center;">
                <button onclick="backToScenarios()" style="
                  background: #FF9800;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: bold;
                  font-size: 14px;
                ">← Geri Dön</button>
              </div>
            </div>
          `;
        }
      };
      
      function showDetailedChoices(scenarioId, nodeId) {
        console.log("🎭 Showing detailed choices for:", scenarioId, nodeId);
        
        fetch(`/api/stories/${scenarioId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.story) {
              const story = data.story;
              const currentNode = story;
              
              const centerPanel = document.querySelector('.center-panel');
              if (centerPanel && currentNode) {
                let choicesHTML = '';
                
                currentNode.choices.forEach((choice, index) => {
                  const choiceColor = index % 4 === 0 ? '#4CAF50' : 
                                    index % 4 === 1 ? '#2196F3' : 
                                    index % 4 === 2 ? '#F44336' : '#9C27B0';
                  const choiceBg = choiceColor === '#4CAF50' ? 'rgba(76, 175, 80, 0.2)' :
                                 choiceColor === '#2196F3' ? 'rgba(33, 150, 243, 0.2)' :
                                 choiceColor === '#F44336' ? 'rgba(244, 67, 54, 0.2)' : 'rgba(156, 39, 176, 0.2)';
                  
                  choicesHTML += `
                    <div style="background: ${choiceBg}; border: 1px solid ${choiceColor}; border-radius: 8px; padding: 20px; margin-bottom: 15px; transition: all 0.3s ease;" 
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)'" 
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <h4 style="color: ${choiceColor}; margin-bottom: 10px; font-size: 16px; font-weight: bold;">${choice.text}</h4>
                      ${choice.choice_description ? `
                        <p style="color: rgba(255,255,255,0.9); font-size: 14px; line-height: 1.6; margin-bottom: 10px; font-style: italic;">
                          ${choice.choice_description}
                        </p>
                      ` : ''}
                      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        ${choice.diceRoll ? `
                          <span style="background: rgba(0,0,0,0.3); color: #FFD700; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                            🎲 ${choice.diceRoll.skill}: ${choice.diceRoll.target}+
                          </span>
                        ` : ''}
                        ${choice.effect ? `
                          <span style="background: rgba(0,0,0,0.3); color: #4CAF50; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                            ⭐ Karma: ${choice.effect.karma > 0 ? '+' : ''}${choice.effect.karma}
                          </span>
                        ` : ''}
                      </div>
                      <button onclick="makeDetailedChoice('${scenarioId}', '${choice.id}', '${choice.hidden_consequence}')" 
                              style="
                                background: ${choiceColor};
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: bold;
                                font-size: 14px;
                                transition: all 0.3s ease;
                              " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                        🎯 Bu Seçimi Yap
                      </button>
                    </div>
                  `;
                });
                
                centerPanel.innerHTML = `
                  <div class="detailed-choices">
                    <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">⚡ Seçeneklerin</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                      <div style="margin-bottom: 20px;">
                        <h4 style="color: #FFD700; margin-bottom: 10px; font-size: 16px;">🎭 Karar Verme Zamanı</h4>
                        <p style="color: rgba(255,255,255,0.9); font-size: 14px; line-height: 1.6;">
                          Her seçimin sonuçları olacak. Dikkatli düşün ve seçimini yap. Bu seçimler senin kaderini belirleyecek.
                        </p>
                      </div>
                      
                      <div style="display: flex; flex-direction: column; gap: 15px;">
                        ${choicesHTML}
                      </div>
                      
                      <div style="text-align: center; margin-top: 20px;">
                        <button onclick="backToScenarios()" style="
                          background: linear-gradient(45deg, #FF9800, #F57C00);
                          color: white;
                          border: none;
                          padding: 12px 24px;
                          border-radius: 6px;
                          cursor: pointer;
                          font-weight: bold;
                          font-size: 14px;
                          box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                          transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">← Geri Dön</button>
                      </div>
                    </div>
                  </div>
                `;
              }
            } else {
              showStoryChoices();
            }
          })
          .catch(error => {
            console.error("Error loading detailed choices:", error);
            showStoryChoices();
          });
      }
      
      function makeChoice(choiceType) {
        const choiceMessages = {
          'explore': '🔍 Çevreyi keşfetmeye başlıyorsun... Her adımda yeni sırlar keşfediyorsun.',
          'dialogue': '💬 NPC ile konuşmaya başlıyorsun... Kelimeler havada dans ediyor.',
          'combat': '⚔️ Savaşmaya hazırlanıyorsun... Silahlarını kontrol ediyorsun.',
          'stealth': '🥷 Gizlice ilerlemeye başlıyorsun... Gölgelerde hareket ediyorsun.'
        };
        alert(`🎯 Seçim yapıldı: ${choiceMessages[choiceType]}`);
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.innerHTML = `
            <div class="story-progression">
              <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 Hikaye Devam Ediyor</h3>
              <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px; text-align: justify;">
                  ${choiceMessages[choiceType]}
                </p>
                <div style="text-align: center; margin: 20px 0;">
                  <p style="color: #FFD700; font-style: italic; font-size: 14px;">
                    "Hikaye devam ediyor... Yeni seçenekler beliriyor..."
                  </p>
                </div>
                <div style="text-align: center;">
                  <button onclick="showStoryChoices()" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 16px;
                  ">🎭 Devam Et</button>
                </div>
              </div>
            </div>
          `;
        }
      };
      
      function makeDetailedChoice(scenarioId, choiceId, hiddenConsequence) {
        console.log("🎯 Making detailed choice:", scenarioId, choiceId, hiddenConsequence);
        
        // Show consequence
        if (hiddenConsequence) {
          const consequences = {
            'immediate_pursuit': '⚡ Hemen takip etmek cesur bir seçimdi, ama dikkatli olmalısın...',
            'village_intel': '💡 Köylülerden aldığın bilgiler çok değerli olacak...',
            'proper_preparation': '🛡️ Hazırlık yapmak akıllıca bir karardı...',
            'hasty_rescue': '🏃 Acele etmek bazen gerekli olabilir, ama riskli...',
            'stealthy_approach': '🥷 Gizlice yaklaşmak seni avantajlı konuma getirecek...',
            'thorough_search': '🔍 Detaylı arama yapmak zaman alır ama değerli bilgiler verir...',
            'ancient_knowledge': '📚 Eski bilgiler bazen en güçlü silahtır...',
            'urgent_pursuit': '⚡ Acil takip seni ejderha'ya yaklaştırıyor...',
            'compassionate_choice': '❤️ Merhametli seçimlerin seni güçlendirir...'
          };
          
          if (consequences[hiddenConsequence]) {
            alert(`🌟 ${consequences[hiddenConsequence]}`);
          }
        }
        
        // Make story choice API call
        fetch(`/api/stories/${scenarioId}/choice`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            choice_id: choiceId,
            user_id: 'player_' + Date.now()
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.story) {
            const story = data.story;
            const centerPanel = document.querySelector('.center-panel');
            if (centerPanel) {
              centerPanel.innerHTML = `
                <div class="story-progression">
                  <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">📖 ${story.title || 'Hikaye Devam Ediyor'}</h3>
                  <div style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                    <div style="background: rgba(255,215,0,0.05); padding: 20px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #FFD700;">
                      <div style="white-space: pre-line; font-size: 15px; line-height: 1.8; text-align: justify; color: rgba(255,255,255,0.95); font-family: 'Georgia', serif;">
                        ${story.description || 'Hikaye devam ediyor...'}
                      </div>
                    </div>
                    
                    ${story.choices && story.choices.length > 0 ? `
                      <div style="text-align: center;">
                        <h4 style="color: #FFD700; margin-bottom: 15px;">⚡ Seçeneklerin</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px; max-width: 400px; margin: 0 auto;">
                          ${story.choices.map(choice => `
                            <button onclick="makeDetailedChoice('${scenarioId}', '${choice.id}', '${choice.hidden_consequence || ''}')" style="
                              background: linear-gradient(45deg, #4CAF50, #45a049);
                              color: white;
                              border: none;
                              padding: 12px 20px;
                              border-radius: 6px;
                              cursor: pointer;
                              font-weight: bold;
                              font-size: 14px;
                              box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                              transition: all 0.3s ease;
                              text-align: left;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                              ${choice.text}
                            </button>
                          `).join('')}
                        </div>
                      </div>
                    ` : `
                      <div style="text-align: center;">
                        <button onclick="loadScenarios()" style="
                          background: linear-gradient(45deg, #9C27B0, #673AB7);
                          color: white;
                          border: none;
                          padding: 15px 30px;
                          border-radius: 6px;
                          cursor: pointer;
                          font-weight: bold;
                          font-size: 16px;
                          box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                          transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">🏠 Ana Menüye Dön</button>
                      </div>
                    `}
                  </div>
                </div>
              `;
              
              // Load quest panel after story update
              loadQuestPanel(scenarioId);
            }
          } else {
            alert("❌ Hikaye yüklenemedi!");
          }
        })
        .catch(error => {
          console.error("API Error:", error);
          alert("❌ Bağlantı hatası!");
        });
      }

      // Quest System Functions
      function loadQuestPanel(scenarioId) {
        const rightPanel = document.querySelector('.right-panel');
        if (!rightPanel) return;
        
        // Add quest panel to right panel
        const questPanelHTML = `
          <div class="quest-panel">
            <div class="quest-title">🎯 Görevler</div>
            <div id="quest-list">
              <div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 12px;">
                Görevler yükleniyor...
              </div>
            </div>
            <div class="action-buttons">
              <button class="action-btn" onclick="performAction('exploration', 2)">🔍 Keşif</button>
              <button class="action-btn" onclick="performAction('combat', 2)">⚔️ Savaş</button>
              <button class="action-btn" onclick="performAction('talk', 1)">💬 Konuş</button>
              <button class="action-btn" onclick="performAction('investigation', 2)">🔎 Araştır</button>
              <button class="action-btn" onclick="performAction('collect', 1)">📦 Topla</button>
            </div>
          </div>
        `;
        
        // Insert quest panel at the top of right panel
        rightPanel.insertAdjacentHTML('afterbegin', questPanelHTML);
        
        // Load available quests
        loadAvailableQuests(scenarioId);
      }

      function loadAvailableQuests(scenarioId) {
        // Get scenario details to find quest chains
        fetch(`/api/scenarios/${scenarioId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.scenario) {
              const questChains = data.scenario.quest_chains || {};
              displayQuests(questChains, scenarioId);
            }
          })
          .catch(error => {
            console.error("Error loading quests:", error);
          });
      }

      function displayQuests(questChains, scenarioId) {
        const questList = document.getElementById('quest-list');
        if (!questList) return;
        
        const quests = Object.entries(questChains);
        if (quests.length === 0) {
          questList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 12px;">Bu senaryoda görev yok</div>';
          return;
        }
        
        const questHTML = quests.map(([questId, quest]) => `
          <div class="quest-item">
            <div class="quest-name">${quest.title || questId}</div>
            <div class="quest-description">${quest.description || 'Görev açıklaması'}</div>
            <div class="quest-requirements">Gereksinimler: ${quest.prerequisites ? quest.prerequisites.join(', ') : 'Yok'}</div>
            <div class="quest-progress">
              <div class="quest-progress-bar" style="width: 0%"></div>
            </div>
            <button class="quest-complete-btn" onclick="completeQuest('${questId}', '${scenarioId}')" disabled>
              Görevi Tamamla
            </button>
            <div class="quest-rewards">Ödül: ${quest.rewards ? Object.entries(quest.rewards).map(([k,v]) => `${k}: ${v}`).join(', ') : 'XP +100'}</div>
          </div>
        `).join('');
        
        questList.innerHTML = questHTML;
      }

      function performAction(actionType, value) {
        const userId = 'player_' + Date.now();
        
        fetch('/api/player/action', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_id: userId,
            action_type: actionType,
            action_value: value
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showNotification(`✅ ${actionType} aksiyonu tamamlandı!`);
            updateQuestProgress();
          }
        })
        .catch(error => {
          console.error("Action error:", error);
        });
      }

      function completeQuest(questId, scenarioId) {
        const userId = 'player_' + Date.now();
        
        fetch('/api/quests/complete_action', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_id: userId,
            action_type: questId,
            scenario_id: scenarioId
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.quest_completed) {
              showNotification(`🎉 Görev tamamlandı! ${data.message}`);
              updateQuestProgress();
            } else {
              showNotification(`❌ Görev tamamlanamadı: ${data.message}`);
            }
          }
        })
        .catch(error => {
          console.error("Quest completion error:", error);
        });
      }

      function updateQuestProgress() {
        // Update quest progress bars based on player stats
        const userId = 'player_' + Date.now();
        
        fetch(`/api/player/stats?user_id=${userId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const stats = data.stats;
              // Update progress bars based on stats
              const progressBars = document.querySelectorAll('.quest-progress-bar');
              progressBars.forEach(bar => {
                const progress = Math.min((stats.exploration_skill || 0) / 25 * 100, 100);
                bar.style.width = progress + '%';
              });
            }
          })
          .catch(error => {
            console.error("Stats update error:", error);
          });
      }

      function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
                    </div>
                  `;
                }
              } else {
                // End of story or node not found
                centerPanel.innerHTML = `
                  <div class="story-end">
                    <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">🏁 Hikaye Sonu</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                      <p style="font-size: 16px; line-height: 1.8; text-align: center; color: rgba(255,255,255,0.9);">
                        Bu hikaye yolculuğunun sonuna geldin. Seçimlerin seni buraya getirdi.
                      </p>
                      <div style="text-align: center; margin-top: 20px;">
                        <button onclick="backToScenarios()" style="
                          background: linear-gradient(45deg, #FF9800, #F57C00);
                          color: white;
                          border: none;
                          padding: 15px 30px;
                          border-radius: 6px;
                          cursor: pointer;
                          font-weight: bold;
                          font-size: 16px;
                          box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                          transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">🏠 Ana Menüye Dön</button>
                      </div>
                    </div>
                  </div>
                `;
              }
            }
          })
          .catch(error => {
            console.error("Error loading next node:", error);
            makeChoice('explore'); // Fallback
          });
      }
      
      function backToScenarios() {
        loadScenarios();
      };
      
      // Character functions
      function selectRace(race, theme) {
        console.log("🏃 Race selected:", race, "for theme:", theme);
        document.querySelectorAll('.list-item').forEach(item => {
          item.classList.remove('selected');
        });
        event.target.classList.add('selected');
        alert(`Irk seçildi: ${race}`);
      }
      
      function selectClass(className, theme) {
        console.log("⚔️ Class selected:", className, "for theme:", theme);
        document.querySelectorAll('.list-item').forEach(item => {
          item.classList.remove('selected');
        });
        event.target.classList.add('selected');
        alert(`Sınıf seçildi: ${className}`);
      }
      
      function createCharacter() {
        console.log("🎭 Creating character...");
        const nameInput = document.getElementById('character-name-input');
        const selectedRace = document.querySelector('.race-class-list .list-item.selected');
        const selectedClass = document.querySelector('.race-class-list .list-item.selected');
        
        if (!nameInput || !selectedRace || !selectedClass) {
          alert("❌ Lütfen isim, ırk ve sınıf seçin!");
          return;
        }
        
        const characterName = nameInput.value || "Yeni Kahraman";
        const race = selectedRace.textContent;
        const className = selectedClass.textContent;
        
        document.getElementById('character-name').textContent = characterName;
        document.getElementById('character-class').textContent = `${race} ${className}`;
        
        alert(`✅ Karakter oluşturuldu: ${characterName} - ${race} ${className}`);
      }

      // AI Scenario Generation Function
      function generateAIScenario() {
        console.log("🤖 Generating AI scenario...");
        
        // Show loading message
        const aiContainer = document.getElementById('ai-scenarios-container');
        const originalContent = aiContainer.innerHTML;
        
        aiContainer.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #ffd700;">
            <div style="font-size: 24px; margin-bottom: 10px;">🤖</div>
            <div>AI senaryo üretiliyor...</div>
            <div style="font-size: 12px; margin-top: 10px; color: rgba(255,255,255,0.7);">Bu işlem birkaç saniye sürebilir</div>
          </div>
        `;
        
        // Generate random scenario parameters
        const themes = ['fantasy', 'scifi', 'cyberpunk', 'warhammer'];
        const difficulties = ['easy', 'medium', 'hard'];
        const scenarioTypes = [
          'Macera', 'Gizem', 'Savaş', 'Keşif', 'Kurtarma', 'İntikam', 'Aşk', 'Dostluk'
        ];
        
        const randomTheme = themes[Math.floor(Math.random() * themes.length)];
        const randomDifficulty = difficulties[Math.floor(Math.random() * difficulties.length)];
        const randomType = scenarioTypes[Math.floor(Math.random() * scenarioTypes.length)];
        
        // Create unique scenario ID
        const scenarioId = `ai_${randomTheme}_${Date.now()}`;
        
        // Generate scenario based on theme
        let scenarioTitle, scenarioDesc;
        
        switch(randomTheme) {
          case 'fantasy':
            scenarioTitle = `AI: Fantastik ${randomType}`;
            scenarioDesc = `AI tarafından üretilen benzersiz fantastik ${randomType.toLowerCase()} hikayesi.`;
            break;
          case 'scifi':
            scenarioTitle = `AI: Bilim Kurgu ${randomType}`;
            scenarioDesc = `AI tarafından üretilen gelecek teknolojisi ${randomType.toLowerCase()} hikayesi.`;
            break;
          case 'cyberpunk':
            scenarioTitle = `AI: Cyberpunk ${randomType}`;
            scenarioDesc = `AI tarafından üretilen neon ışıkları altında ${randomType.toLowerCase()} hikayesi.`;
            break;
          case 'warhammer':
            scenarioTitle = `AI: Warhammer ${randomType}`;
            scenarioDesc = `AI tarafından üretilen epik Warhammer 40K ${randomType.toLowerCase()} hikayesi.`;
            break;
        }
        
        // Simulate AI generation delay
        setTimeout(() => {
          // Create new scenario element
          const newScenario = document.createElement('div');
          newScenario.className = 'scenario-item';
          newScenario.onclick = () => selectScenario({
            id: scenarioId,
            title: scenarioTitle,
            description: scenarioDesc,
            difficulty: randomDifficulty,
            theme: randomTheme,
            ai_generated: true
          });
          
          newScenario.innerHTML = `
            <div class="scenario-title">${scenarioTitle}</div>
            <div class="scenario-desc">${scenarioDesc}</div>
            <div class="scenario-meta">
              <span class="difficulty">${randomDifficulty}</span>
              <span class="genre">${randomTheme}</span>
              <span class="ai-badge" style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">AI</span>
            </div>
          `;
          
          // Add to container
          aiContainer.innerHTML = originalContent;
          aiContainer.appendChild(newScenario);
          
          // Show success message
          alert(`✅ Yeni AI senaryo üretildi: ${scenarioTitle}`);
          
        }, 2000 + Math.random() * 3000); // Random delay between 2-5 seconds
      }
      }
      
      function changeEquipment(slotType) {
        console.log("🛡️ Equipment changed:", slotType);
        const slotElement = document.getElementById(slotType + '-slot');
        if (slotElement) {
          const items = ['Steel Sword', 'Magic Bow', 'Fire Axe', 'Ice Staff', 'Thunder Hammer'];
          const currentItem = slotElement.textContent;
          const currentIndex = items.indexOf(currentItem);
          const nextIndex = (currentIndex + 1) % items.length;
          slotElement.textContent = items[nextIndex];
          alert(`Ekipman değiştirildi: ${items[nextIndex]}`);
        }
      }
      
      function useItem(itemElement) {
        console.log("🎒 Item used:", itemElement.textContent);
        alert(`Öğe kullanıldı: ${itemElement.textContent}`);
        itemElement.textContent = '+';
        itemElement.classList.remove('filled');
      }
      
      function addRandomItem(itemElement) {
        console.log("🎒 Adding random item");
        const items = ['⚔️', '🛡️', '🧪', '🍖', '💎', '📜', '🗝️', '🏹'];
        const randomItem = items[Math.floor(Math.random() * items.length)];
        itemElement.textContent = randomItem;
        itemElement.classList.add('filled');
        alert(`Yeni öğe eklendi: ${randomItem}`);
      }
      
      function performAction(action) {
        console.log("⚡ Action performed:", action);
        const messages = {
          'rest': '🛏️ Dinlendin ve canını yeniledin!',
          'train': '⚔️ Antrenman yaptın ve güçlendin!',
          'craft': '🔧 Yeni ekipman ürettin!',
          'trade': '💰 Ticaret yaptın ve altın kazandın!'
        };
        alert(messages[action] || 'Aksiyon gerçekleştirildi!');
      }
      
